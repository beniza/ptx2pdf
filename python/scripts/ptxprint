#!/usr/bin/python3

import argparse, sys, os, configparser
import appdirs
import site
if getattr(sys, 'frozen', False) and hasattr(sys, '_MEIPASS'):
    site.USER_BASE = os.path.join(os.path.expanduser("~"), ".local")
    if not hasattr(site, 'getuserbase'):
        site.getuserbase = lambda : site.USER_BASE

try:
    import ptxprint
except ImportError:
    sys.path.append(os.path.join(os.path.dirname(__file__), "..", "lib"))
    import ptxprint
from ptxprint.view import ViewModel, VersionStr, doError
from ptxprint.font import initFontCache, cachepath
from ptxprint.runjob import RunJob, isLocked
from ptxprint.utils import _, setup_i18n, get_ptsettings, pt_bindir

parser = argparse.ArgumentParser()
# parser.add_argument('-h','--help', help="show this help message and exit")
parser.add_argument('pid',nargs="?",help="Project id or full path to a ptxprint.cfg file")
parser.add_argument('-c','--config',help='Configuration path to load')
parser.add_argument('-p','--paratext',help="Path to Paratext Projects directory")
parser.add_argument('-d','--directory',help="Directory to store temporary files in")
parser.add_argument('-P','--print',action='store_true',help="Hits print")
parser.add_argument('-b','--books',help='Space separated bookid list to set')
parser.add_argument('-m','--macros',help="Directory containing TeX macros (paratext2.tex)")
parser.add_argument('-l','--logging',action="store_true",help="Output logging to terminal instead of logging window")
parser.add_argument('--timeout',default=200,type=int,help='xetex runtime timeout')
parser.add_argument('-T','--testing',action='store_true',help="Run in testing, output xdv")
parser.add_argument('-f','--fontpath',action='append',help="Directory of fonts to include (repeatable)")
parser.add_argument('--nofontcache',action="store_true",help="Don't use system fonts")
parser.add_argument('-A','--archive',help="Create archive of project")
parser.add_argument('--nuseusfmerge',action="store_true",help="Use a different kind of merge for diglot")
parser.add_argument('--debug',action="store_true",help="Give debug output")
parser.add_argument("-C","--capture",help="Capture interaction events to file. Not to be used yet")
# parser.add_argument('-t','--test', action='store_true',help="Quick start for a lazy typist")
args = parser.parse_args()

# We might need to do this AFTER reading in the user-config file (as the UI language needs to be read)
# setup_i18n()

if args.logging and getattr(sys, 'frozen', False) and hasattr(sys, '_MEIPASS'):
    errfile = open("ptxprint.log", "w")
    sys.stdio = errfile
    sys.stderr = errfile

if not args.print:
    from ptxprint.gtkview import GtkViewModel, getPTDir

# necessary for the side effect of setting pt_bindir :(
if args.paratext is None:
    args.paratext = os.getenv("PTXPRINT_PROJECTSDIR", None)
    if args.paratext is None:
        args.paratext = get_ptsettings()

conffile = os.path.join(appdirs.user_config_dir("ptxprint", "SIL"), "ptxprint_user.cfg")
config = configparser.ConfigParser()
if os.path.exists(conffile):
    config.read(conffile, encoding="utf-8")
    if args.pid is None and config.has_option("init", "project"):
        args.pid = config.get('init', 'project')
        if args.config is None and config.has_option("init", "config"):
            args.config = config.get('init', 'config')
    if not args.paratext and config.has_option("init", "paratext"):
        args.paratext = config.get("init", "paratext")
    try:
        args.lang = config.get("init", "lang")
        print(args.lang)
    except:
        args.lang = 'en'
else:
    if not os.path.exists(os.path.dirname(conffile)):
        os.makedirs(os.path.dirname(conffile))
    config.add_section("init")
    args.lang = 'en'

print(args.lang)
setup_i18n(args.lang)

if not args.paratext or str(args.paratext).lower() == "none":
    # print("No Paratext Settings directory found - sys.exit(1)")
    if not args.print:
        args.paratext = getPTDir()
        if args.paratext is None:
            sys.exit(1)
    else:
        sys.exit(1)
else:
    args.paratext = os.path.abspath(args.paratext.replace("\\", "/"))
    if args.paratext.endswith("/"):
        args.paratext = args.paratext[:-1]

config.set("init", "paratext", str(args.paratext))

if args.pid is not None and (any(x in args.pid for x in "\\/") or args.pid.lower().endswith(".cfg")):
    pidpath = os.path.relpath(args.pid, args.paratext).replace("\\", "/")
    if pidpath.startswith("..") or pidpath.startswith("/"):
        pidpath = os.path.abspath(args.pid).replace("\\", "/")
    pidbits = pidpath.split("/")
    if len(pidbits) > 4 and "ptxprint" in [x.lower() for x in pidbits[-3:-1]]:
        if pidbits[-2].lower() == "ptxprint":
            if len(pidbits) > 4:
                args.paratext = "/".join(pidbits[:-4])
            pidbits = pidbits[-4:]
        elif pidbits[-3].lower() == "ptxprint":
            if len(pidbits) > 5:
                args.paratext = "/".join(pidbits[:-5])
            pidbits = pidbits[-5:]
    if len(pidbits) == 5:
        args.config = pidbits[3]
    if len(pidbits) > 3:
        args.pid = pidbits[0]

if args.directory is not None:
    args.directory = os.path.abspath(args.directory)

# Where to find the default for -p
# HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Paratext\8:Settings_Directory

scriptsdir = getattr(sys, '_MEIPASS', os.path.abspath(os.path.dirname(__file__)))
if os.path.exists("/usr/share/ptx2pdf") and not os.path.exists(os.path.join(scriptsdir, "..", "..", "src")):
    scriptsdir = "/usr/share/ptx2pdf"
    macrosdir = "/usr/share/ptx2pdf/texmacros"
elif getattr(sys, 'frozen', False):
    macrosdir = os.path.join(scriptsdir, "ptx2pdf")
else:
    macrosdir = os.path.join(scriptsdir, "..", "..", "src")

if args.print or args.archive is not None:
    mainw = ViewModel(args.paratext, args.directory, config, macrosdir, args)
else:
    mainw = GtkViewModel(args.paratext, args.directory, config, macrosdir, args)

if args.pid:
    pdir = os.path.join(args.paratext, args.pid)
    if not os.path.exists(pdir):
        args.pid = None
    elif args.config:
        pdir = os.path.join(pdir, "shared", "ptxprint", args.config, "ptxprint.cfg")
        if not os.path.exists(pdir):
            args.config = None


if args.pid:
    mainw.setPrjid(args.pid)
    mainw.setConfigId(args.config or "Default")

def doit(printer):
    if not isLocked():
        runjob = RunJob(printer, scriptsdir, macrosdir, config, args)
        runjob.doit()
        return runjob
    else:
        return None

if args.fontpath is not None:
    for p in args.fontpath:
        if os.path.exists(p):
            cachepath(p, nofclist=args.nofontcache)

if args.print or args.archive is not None:
    res = 0
    initFontCache(nofclist=args.nofontcache)
    if args.print:
        if args.books is not None and len(args.books):
            mainw.bookNoUpdate = True
            bl = args.books.split(" ")
            if len(bl) == 1:
                mainw.set("cb_book", bl[0])
                mainw.set("r_book", "single")
            elif len(bl) > 1:
                mainw.set("t_booklist", args.books)
                mainw.set("r_booK", "multiple")
        mainw.savePics()
        mainw.saveStyles()
        job = doit(mainw)
        if job is not None:
            res = job.wait()
        else:
            res = False
    if args.archive:
        mainw.createArchive(args.archive)
    sys.exit(res)
else:
    mainw.run(doit)
    with open(conffile, "w", encoding="utf-8") as outf:
        config.write(outf)
