% cropmark support for the ptx2pdf package

\newif\ifCropMarks

\font\idf@nt=cmtt10 scaled 700 % font for the marginal job information

\newbox\topcr@p \newbox\bottomcr@p
\def\makecr@ps{% construct the cropmark boxes for top and bottom of page
  \global\setbox\topcr@p=\vbox to 0pt{\vss
    \hbox to \PaperWidth{%
      \kern -30pt
      \vrule height .2pt depth .2pt width 25pt
      \kern 4.8pt
      \vrule height 30pt depth -5pt width .4pt
      \hss
      \raise20pt\vtop{\hsize\PaperWidth \everypar={}
        \lineskiplimit=0pt \baselineskip=10pt
        \leftskip=0pt plus 1fil \rightskip=\leftskip \parfillskip=0pt
        \noindent \beginL\idf@nt \jobname\ -- \printd@te\endL}%
      \hss
      \vrule height 30pt depth -5pt width .4pt
      \kern 4.8pt
      \vrule height .2pt depth .2pt width 25pt
      \kern -30pt
    }%
  }% end \vbox for \topcr@p
  \global\setbox\bottomcr@p=\vbox to 0pt{%
    \hbox to \PaperWidth{%
      \kern -30pt
      \vrule height .2pt depth .2pt width 25pt
      \kern 4.8pt
      \vrule height -5pt depth 30pt width .4pt
      \hss
      \vrule height -5pt depth 30pt width .4pt
      \kern 4.8pt
      \vrule height .2pt depth .2pt width 25pt
      \kern -30pt
    }%
    \vss
  }% end \vbox for \bottomcr@p
}

\def\printd@te{\number\year.% print the date and time of the run
  \ifnum\month<10 0\fi \number\month.%
  \ifnum\day<10 0\fi \number\day\ --
  \count255=\time \divide\count255 by 60
  \ifnum\count255<10 0\fi \number\count255:%
  \multiply\count255 by 60 \advance\count255 by -\time
  \count255=-\count255
  \ifnum\count255<10 0\fi \number\count255
}

\def\shipwithcr@pmarks#1{% \shipout box #1, adding cropmarks if required
  \dimen0=0\ifCropMarks .5\fi in
  \advance\pdfpagewidth by 2\dimen0 % increase PDF media size
  \advance\pdfpageheight by 2\dimen0
  \hoffset=-1in \voffset=-1in % shift the origin to (0,0)
  \shipout\vbox to 0pt{% ship the actual page content, with \BindingGutter added if wanted
    \kern \baselineskip % make room for headline
    \offinterlineskip
    \vbox to \pdfpageheight{\vss
      \let\g@tterside=0
      \ifBindingGutter
        \ifDoubleSided
          \ifodd\pageno
            \ifRTL \let\g@tterside=R
            \else  \let\g@tterside=L \fi
          \else
            \ifRTL \let\g@tterside=L
            \else  \let\g@tterside=R \fi
          \fi
        \else
          \ifRTL \let\g@tterside=R
          \else  \let\g@tterside=L \fi
        \fi
      \fi
      \hbox to \pdfpagewidth{\hss\hbox{%
        \if\g@tterside L\kern\BindingGutter\fi
        #1%
        \if\g@tterside R\kern\BindingGutter\fi
      }\hss}\vss}
    \vss
    \ifCropMarks % if crop marks are enabled
      \ifvoid\topcr@p \makecr@ps \fi % create them (first time)
      \vbox to 0pt{
        \kern\dimen0
        \moveright\dimen0\copy\topcr@p
        \kern\PaperHeight
        \moveright\dimen0\copy\bottomcr@p
        \moveright\dimen0\vbox to 0pt{\kern15pt\hsize\PaperWidth \everypar={}
          \lineskiplimit=0pt \baselineskip=10pt
          \leftskip=0pt plus 1fil \rightskip=\leftskip \parfillskip=0pt
          \noindent \beginL\idf@nt \c@rrID\endL\endgraf % add the current \id line
          \vss}
        \vss
      }
    \fi
  }%
}

% redefine plain TeX's output routine to add the cropmarks
\def\plainoutput{\shipwithcr@pmarks
    {\vbox{\makeheadline\pagebody\makefootline}}%
  \advancepageno
  \ifnum\outputpenalty>-\@MM \else\dosupereject\fi}

\endinput
