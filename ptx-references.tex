% Macros to deal with Scripture references (book, chapter, verse) and running headers

% These macros work on the reference information in the format "Book:C:V"
% that is embedded in the \mark at each verse number.

% Note that "V" may be a verse range, if the USFM data included bridged verses such as "\v 12-15".
% Therefore, we have to do some extra work to extract individual verse numbers.

%
% Print the first reference from the mark data
%
\def\f@rstref#1{\edef\t@st{#1}\x@\extr@ctfirst\t@st\relax
 \ifx\@book\empty\else\@book\ \@chapter\ifVerseRefs\cvs@p\@verse\fi\fi}

%
% Print the last reference from the mark data
% (same as above unless there are bridged verses)
%
\def\l@stref#1{\edef\t@st{#1}\x@\extr@ctlast\t@st\relax
 \ifx\@@book\empty\else\@@book\ \@@chapter\ifVerseRefs\cvs@p\@@verse\fi\fi}

%
% Print the range of references from a pair of marks
%
\def\r@ngerefs#1#2{%
 \edef\t@st{#1}\x@\extr@ctfirst\t@st\relax
 \edef\t@st{#2}\x@\extr@ctlast\t@st\relax
 \ifx\@book\empty\else
 \@book\ 
 \ifVerseRefs
  \ifx\@chapter\empty\else\@chapter\cvs@p\fi\@verse
  \ifx\@book\@@book
   \ifx\@chapter\@@chapter
    \ifx\@verse\@@verse\else\ranges@p\@@verse\fi
   \else\ranges@p\@@chapter\cvs@p\@@verse\fi
  \else\ranges@p\@@book\ \@@chapter\cvs@p\@@verse\fi
 \else
  \ifx\@chapter\empty\else
   \@chapter
   \ifx\@chapter\@@chapter\else
    \setbox0=\hbox{\tracinglostchars=0
     \global\c@untA=0\@chapter \global\c@untB=0\@@chapter}%
    \advance\c@untA by 1
    \ifnum\c@untA=\c@untB \pairs@p \else \ranges@p \fi
    \@@chapter
   \fi
  \fi
 \fi\fi}
\newcount\c@untA \newcount\c@untB

%
% extract the starting reference of a (possible) range
% putting the result into \@book, \@chapter, \@verse
%
\def\extr@ctfirst#1:#2:#3\relax{%
 \def\@book{#1}\def\@chapter{#2}\def\t@st{#3}%
 \x@\spl@tverses\t@st--\relax
 \edef\@verse{\v@rsefrom}}

%
% extract the ending reference of a (possible) range
% putting the result into \@@book, \@@chapter, \@@verse
%
\def\extr@ctlast#1:#2:#3\relax{%
 \def\@@book{#1}\def\@@chapter{#2}\def\t@st{#3}%
 \x@\spl@tverses\t@st--\relax
 \edef\@@verse{\v@rseto}}

%
% split a possible verse range on hyphen, setting \v@rsefrom and \v@rseto
%
\def\spl@tverses#1-#2-#3\relax{%
 \edef\v@rsefrom{#1}\edef\v@rseto{#2}%
 \ifx\v@rseto\empty\let\v@rseto=\v@rsefrom\fi}

\newif\ifVerseRefs % whether to include verse numbers, or only book+chapter

%
% Specify separators to use when constructing references
%
\def\ranges@p{\hbox{\RangeSeparator}} % box this to avoid possible bidi problems
%\def\pairs@p{,\kern.2em}
\let\pairs@p\ranges@p
\def\cvs@p{\hbox{\ChapterVerseSeparator}}
\def\endash{\char"2013\relax}

\def\RangeSeparator{\kern.1em\endash\kern.1em} % what to put between first - last of a range
\def\ChapterVerseSeparator{\kern.02em.\kern.02em} % what to put between chapter:verse

%
% Running headers/footers that may use the references defined above
%

% define \headline for use by the output routine
\headline={{%
 \pl@ceborder % place border graphic, if one has been defined
 \s@tfont{h}%
 \edef\t@st{\p@gefirstmark}% check first mark on page to see if this is a "title" page
 \global\rhr@letrue
 \ifx\t@st\empty \hfil \global\rhr@lefalse \else
  \ifx\t@st\t@tle \the\titlehead \global\rhr@lefalse \else
  \ifodd\pageno \the\oddhead \else
    \ifDoubleSided \the\evenhead \else \the\oddhead \fi % for single-sided, all pages are "odd"
  \fi\fi\fi}}

% default headers are made of three components, placed left, center and right
\newtoks\oddhead
\newtoks\evenhead
\newtoks\titlehead
\oddhead={\rlap{\RHoddleft}\hfil\RHoddcenter\hfil\llap{\RHoddright}}
\evenhead={\rlap{\RHevenleft}\hfil\RHevencenter\hfil\llap{\RHevenright}}
\titlehead={\rlap{\RHtitleleft}\hfil\RHtitlecenter\hfil\llap{\RHtitleright}}

% \footline is similar except it doesn't have to place a border graphic
\footline={{%
 \s@tfont{h}%
 \edef\t@st{\p@gefirstmark}%
 \ifx\t@st\empty \hfil \else
  \ifx\t@st\t@tle \the\titlefoot \else
  \ifodd\pageno \the\oddfoot \else 
    \ifDoubleSided \the\evenfoot \else \the\oddfoot \fi
  \fi\fi\fi}}
\newtoks\oddfoot
\newtoks\evenfoot
\newtoks\titlefoot
\oddfoot={\rlap{\RFoddleft}\hfil\RFoddcenter\hfil\llap{\RFoddright}}
\evenfoot={\rlap{\RFevenleft}\hfil\RFevencenter\hfil\llap{\RFevenright}}
\titlefoot={\rlap{\RHtitleleft}\hfil\RFtitlecenter\hfil\llap{\RHtitleright}}

%
% user-level macros for use within the running header
%
\def\firstref{\ifRTL\beginR\fi\f@rstref{\p@gefirstmark}\ifRTL\endR\fi}
\def\lastref{\ifRTL\beginR\fi\l@stref{\p@gebotmark}\ifRTL\endR\fi}
\def\rangeref{\ifRTL\beginR\fi\r@ngerefs{\p@gefirstmark}{\p@gebotmark}\ifRTL\endR\fi}
\let\pagenumber=\folio

%
% default settings of the running header components
%
\def\RHoddleft{\empty}
\def\RHoddcenter{\rangeref}
\def\RHoddright{\pagenumber}

\def\RHevenleft{\pagenumber}
\def\RHevencenter{\rangeref}
\def\RHevenright{\empty}

\def\RHtitleleft{\empty}
\def\RHtitlecenter{\empty}
\def\RHtitleright{\empty}

\def\RFoddleft{\empty}
\def\RFoddcenter{\empty}
\def\RFoddright{\empty}

\def\RFevenleft{\empty}
\def\RFevencenter{\empty}
\def\RFevenright{\empty}

\def\RFtitleleft{\empty}
\def\RFtitlecenter{\pagenumber}
\def\RFtitleright{\empty}

% If \PageBorder is defined as the name of a PDF file, it will be placed on every page
% by the default \headline, before anything else is printed
\def\PageBorder{}
\newbox\b@rder
\def\pl@ceborder{\ifx\PageBorder\empty\else % if \PageBorder is empty, this does nothing
  \ifvoid\b@rder % set up the \b@rder box the first time it's needed
    \global\setbox\b@rder=\hbox{\XeTeXpdffile \PageBorder \relax}%
    \global\setbox\b@rder=\vbox to 0pt{\vss\hbox to \textwidth{\hss\box\b@rder\hss}\vss}%
  \fi
  \hbox to 0pt{\vbox to 0pt{\kern0.5\textheight % output a copy of \box\b@rder
    \kern7\le@dingunit\copy\b@rder\vss}\hss}%
 \fi}

\endinput
