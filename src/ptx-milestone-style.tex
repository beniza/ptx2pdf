%:strip
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007-2020 by SIL International
% written by David Gardner and pior editors of ptx-char-style
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Milestone macros
\def\mst@nestyle#1{\trace{m}{mst@nestyle:#1 (\milestoneOp)}%
 \gdef\thismil@stone{\detokenize{#1}}% record the name of the style
 \catcode32=12 % make <space> an "other" character, so it won't be skipped by \futurelet
 \catcode13=12 % ditto for <return>
 \tracingassigns=1
 %\use@ttrSlash
 \futurelet\n@xt\domst@nestyle % look at following character and call \domst@nestyle
}

\let\p@pe=| % for matching
\catcode`\~=12 \lccode`\~=32 % we'll use \lowercase{~} when we need a category-12 space
\catcode`\_=12 \lccode`\_=13 % and \lowercase{_} for category-12 <return>
\lowercase{%
 \def\domst@nestyle{% here, \n@xt has been \let to the next character after the marker
  \mst@nestyletrue
  \initmil@stone%
  \catcode32=10 % reset <space> to act like a space again
  \catcode13=10 % and <return> is also a space (we don't want blank line -> \par)
  \ifx\n@xt\h@phen\let\n@xt@\startmst@nestyle@minus\else
    \ifx\n@xt~\let\n@xt@\startmst@nestyle@spc\else
      \ifx\n@xt_\let\n@xt@\startmst@nestyle@nl\else
       \ifx\n@xt\p@pe\let\n@xt@\startmst@nestyle@pipe\else
	\let\n@xt@\startmst@nestyle\fi\fi\fi\fi
  \tracingassigns=0
  \trace{m}{Start style}%
  \n@xt@
 }
 \def\startmst@nestyle@spc~{\startmst@nestyle}%                                             
 \def\startmst@nestyle@nl_{\startmst@nestyle}%
}
\def\startmst@nestyle@pipe|{\trace{m}{Immediate start of attributes}\in@ttribtrue\startmst@nestyle\@ttrSlash}%
\def\startmst@nestyle@minus-#1{%
  \def\milestoneOp{#1}%
  \startmst@nestyle
}

\def\initmil@stone{%called by startmst@nestyle@minus and startch@rstyle@minus.
  \trace{m}{initmil@stone \milestoneOp}%
  \ifmst@nestyle\else %Was this marker defined as a milestone or as a character style
    \edef\thismil@stone{\newch@rstyle}%
  \fi
  \edef\thismil@stoneKey{}\edef\thismil@stoneVal{}% Set by Attributes
  %\xdef\milestoneOp{#1}%
  \edef\attrid{\milestoneOp id}% id / sid / eid, depending.
}

\def\@ttrSlash#1\*{\trace{m}{@ttrSlash}\xdef\attrib@rgs{#1}\message{Attr:\attrib@rgs}\in@ttribtrue\*}

\def\*{%This might end a + style (c)  or a normal style character style(C), or a milestone style
  \trace{m}{slash *}%
  \proc@ttribs
  \get@ttribute{\thisdefault@ttrkey}%
  \ifx\attr@b\relax\else
    \let\thismil@stoneKey\thisdefault@ttrkey
    \let\thismil@stoneVal\attr@b
  \fi
  \ifmst@nestyle\else
    \ifx \ss@ChrP\stylet@pe
      \endch@rstylepls*
    \else
      \endch@rstyle*
    \fi
  \fi
  \mst@nestylefalse
  \processmil@stone}% USFM3 'self closing marker' milestone

\let\milestoneOp\empty
\let\thismil@stone\empty
\newif\ifmst@nestyle \mst@nestylefalse

\def\processmil@stone{\trace{m}{Milestone \thismil@stone (\milestoneOp), \csname thisch@rstyle\endcsname}%
  \if\milestoneOp s\relax\st@rtmilestone\else
   \if\milestoneOp e\relax\@ndmilestone\else
    \st@ndalonemilestone\fi\fi
 \let\milestoneOp\empty
 %\xdef\thisch@rstyle{\mcpeek}%
 \def\d@##1+##2\E{\def\tmp{##2}\csname d@code-##1\endcsname\edef\thisch@rstyle{\tmp}}\mctop
 \trace{m}{Milestone style is \thisch@rstyle}%
 \s@tfont{\thisch@rstyle}% set up font attributes
}

\def\startmst@nestyle{%What actually changes between the beginning of a milestone and the end-marker? Attribute values!
   \trace{m}{startmst@nestyle}%
   \op@ninghooks{before}{\thismil@stone}%
   \csname init@ttribs\endcsname
}

\def\dr@pmilest@ne#1+#2\E{% This itterates the stack to kills the TOP matching milestone 
  \edef\MSt@mp{#1}%
  \ifx\MSt@mp\empty
    \let\d@=\cstackrelax %permanent change
  \else
    \ifx\ss@Mstn\MSt@mp\relax %It's a milestone
      \x@\pars@msid #2;;;\E
      \ifx\MStyp@\MSch@cking\relax
        \ifx\mstone@id\MSch@ckid
          %\csname endit@#1\endcsname
          \trace{m}{Found \MStyp@ (\MSch@ckid)}%
          \let\d@=\empty %just a signal to skip this one.
          \tempfalse % clear error flag if set
        \else
          \trace{m}{Found \MStyp@, but ids do not match "\MSch@ckid"!="\mstone@id"}%
          \temptrue% flag error
        \fi
      \fi
    \fi
    \ifx\d@\empty
      %Two possible actions here: clear all matching milestones or only the top one.
      %standard is vague about nesting/cancellation. Current implementation 
      %keeps going down if there's no sid/eid to match.
      %\ifx\MSch@ckid\empty
        \let\d@=\dr@pmilest@ne % Keep tracking down.
      %\else
        %\let\d@=\cstackrelax %Top match only.  permanent change
      %\fi
    \else
      \ifx\@ut\empty \xdef\@ut{#1+#2}\else
	\xdef\@ut{\@ut,#1+#2}%
      \fi
    \fi
  \fi
  \trace{m}{dr@pmilest@ne: \@ut}%
}

\def\dr@pmilestone#1#2{%Kill a milestone that might be burried in the stack, and might be nested.
  \trace{m}{Dropping milestone #1 from \mcstack}% 
  \edef\MSch@cking{#1}%
  \edef\MSch@ckid{#2}%
  \tempfalse
  \let\@ut=\empty
  \let\d@=\dr@pmilest@ne
  \mcdown
  \ifx\@ut\empty
    \xdef\mcstack{\mcstack@mpty}%
  \else
    \xdef\mcstack{\@ut,\mcstack@mpty}%
  \fi
  \trace{m}{Stack now: \mcstack}%
  \iftemp
    \message{End-milestone of class '\MSch@cking', id '\MSch@ckid' partially matched one or more open milestones, but no match on the id was
    found, sid and eid must match exactly}%
  \fi
}
%+csty_milestone
% Operations on the current milestone(s)
\def\st@rtmilestone{%
  % There may multiple milestones of a given type (can't sensibly have both \qt+s |Jesus\* and 
  % \qt+s |Pilate\* active at the same time (except quote in quote), but in some cases it might make sense to do something similar.)
  \get@ttribute{\attrid}\ifx\attr@b\relax %if sid is set, sid/eid must match, and may contain letters,numbers,underscore.
    \mcpush{\ss@Mstn+\thismil@stone;\thismil@stoneVal}%
    \trace{m}{Milestone without ID stacked}%
  \else
    \mcpush{\ss@Mstn+\thismil@stone;\thismil@stoneVal;\attr@b}%
    \trace{m}{Milestone with \attrid =\attr@b\space stacked}%
  \fi
  \upd@teMsPrefix
  \trace{m}{Style stack now: \mcstack}%
  \op@ninghooks{start}{\thismil@stone}%
}
\def\@ndmilestone{%
  \trace{m}{@ndmilestone.  stack now: \mcstack}%
  \cl@singhooks{end}{\thismil@stone}%
  \get@ttribute{\attrid}%attrid is id/sid/eid (set in init@trrtibs)
  \ifx\attr@b\relax 
  \dr@pmilestone{\thismil@stone}{}%
  \else
  \dr@pmilestone{\thismil@stone}{\attr@b}%
  \fi
  \trace{m}{Style stack now: \mcstack}%
  \upd@teMsPrefix
  \cl@singhooks{after}{\thismil@stone}\the\afterh@@ks
  \let\attr@b\empty\let\attrid\empty
}
\def\st@ndalonemilestone{% FIXME:Potentially some kind of hook? Or use this as an image anchor?
  \get@ttribute{\attrid}%
  \ifx\attr@b\relax
    \runtrigg@rs{ms:\thismil@stone}%
  \else
    \runtrigg@rs{ms:\thismil@stone=\attr@b}%
  \fi
  \cl@singhooks{after}{\thismil@stone}\the\afterh@@ks
}%
\def\upd@teMsPrefix{%Build a prefix based on all currently-in-force milestones.
  \trace{m}{upd@teMsPrefix}%
  \xdef\mspr@fix{}\let\d@=\mil@st@necheck\mcup
  \ifx\mspr@fix\empty\else\xdef\mspr@fix{ms:\mspr@fix|}\trace{m}{msPrefix set to \mspr@fix}\fi
}
\xdef\equ@l{=}
\def\pars@msid#1;#2;#3;#4\E{\edef\MStyp@{#1}\edef\k@yv@al{#2}\def\mstone@id{#3}}

\x@\def\csname d@code-m\endcsname{%Modify contents of \tmp to only include bits of the stack value of use for styles.
  \x@\pars@msid \tmp;;;\E
  \edef\tmp{\ifx\k@yv@al\empty\else\k@yv@al|\fi\MStyp@}%
}
\def\mil@st@necheck#1+#2\E{%The milestone has a key value and possibly an ID field. Ignore the id for building the prefix
  \edef\MSt@mp{#1}%
  \ifx\MSt@mp\ss@Mstn
    \x@\pars@msid #2;;;\E
    \trace{m}{parsed #2->\k@yv@al, \mstone@id}%
  \xdef\mspr@fix{\ifx\mspr@fix\empty\else \mspr@fix+\fi\ifx\k@yv@al\equ@l\else\k@yv@al|\fi\MStyp@}\fi}
 
\newtoks\tmpt@ks
\def\exp@ndmspr@fix#1{%for each potential prefix, call #1 with \@lso defined
   %\tracingmacros=1
   %\tracingassigns=1
   \tmpt@ks{#1}%
   \trace{m}{Expanding \mspr@fix}%
   \def\D@IT##1{\edef\@lso{ms:##1|}\trace{m}{adding option \@lso to styles}\the\tmpt@ks}%
   \it@mcount=0
   \x@\@xp@ndmspr@fix \mspr@fix
   %\ifnum \it@mcount>1
     %\let\@lso\mspr@fix \the\tmpt@ks
   %\fi
}

%simple + separated list processing
\def\l@stitem #1\E{}
\newcount\it@mcount
\def\e@chitem#1+#2\E{%
  \edef\it@mtmp{#1}\ifx\it@mtmp\empty\let\nxt@item\l@stitem\else
    \advance\it@mcount by 1
    \D@IT{#1}\fi
  \x@\nxt@item #2+\E
}

\def\@xp@ndmspr@fix ms:#1|{%
   \trace{m}{list: #1}%
   \let\nxt@item\e@chitem
   \x@\nxt@item #1+\E
}
%-csty_milestone
\def\attrid{}


