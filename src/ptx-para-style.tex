%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007 by SIL International
% written by Jonathan Kew
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Paragraph style macros

% some flags used to communicate between the macros
\newif\if@ntromarker
\newif\if@ntro \newif\ift@tle \newif\ifb@dy
\newif\ifstartpara
\newif\ifintr@done\intr@donefalse % If true, then if@ntro can only be set between the start of a book and the first chapter number
\newif\ifReenterIntroOK\ReenterIntroOKtrue % If true, then a chapter number does not set intr@done

%+cpar_init
\def\initp@rastyles{\@ntrofalse \t@tlefalse \b@dyfalse \def\m@rker{p}}
%-cpar_init

% test if a marker is an "introduction" style (name begins with "i") and we're allowed to enter intro mode.
%+cpar_testintro
\def\t@stintro#1#2\relax{\ifnum 1=\if#1i \ifintr@done 0 \else 1 \fi \else 0\fi \global\@ntromarkertrue\else\global\@ntromarkerfalse\fi}
%-cpar_testintro

%+cpar_starttypes
% start title/intro/body, if not already in that mode, switching columns if needed
\def\st@rtintro{\TRACE{st@rtintro}\if@ntro\else
  \ifdiglot\else
    \ifnum\IntroColumns=\c@rrentcols\else
      \ifnum\IntroColumns=2 \doublecolumns\else\singlecolumn\fi
    \fi
  \fi
  \global\@ntrotrue\global\t@tlefalse\global\b@dyfalse\fi}

\def\st@rttitle{\TRACE{st@rttitle}\ift@tle\else
  \ifdiglot\else 
    \ifnum\TitleColumns=\c@rrentcols\else
      \ifnum\TitleColumns=2 \doublecolumns\else\singlecolumn\fi
    \fi
  \fi
  \global\t@tletrue\global\@ntrofalse\global\b@dyfalse\fi}

\def\st@rtbody{%\endhe@dings
  \ifb@dy\else\TRACE{st@rtbody}%
  \ifdiglot\else
    \ifnum\BodyColumns=\c@rrentcols
      \penalty-200\vskip\baselineskip
    \else
      \ifdiglot\diglotcolumns\else
      \ifnum\BodyColumns=2 \doublecolumns\else\singlecolumn\fi\fi
    \fi
  \fi
  \global\b@dytrue\global\@ntrofalse\global\t@tlefalse\fi}

\newcount\c@rrentcols \global\c@rrentcols=1
%-cpar_starttypes

%
% Headings are set into a box, so that they can be measured and adjusted for the grid
%
%+cpar_endheadings
\newif\ifhe@dings
\newdimen\headingtopspace
\newbox\he@dingbox
\def\endhe@dings{\ifhe@dings\TRACE{endhe@dings}%
  \makecutouts \endgraf
  \egroup \cutoutcarryover
%{\showboxbreadth=200 \showbox\he@dingbox}
  \s@tbaseline{p}%
  \trace{h}{ht=\the\ht\he@dingbox dp=\the\dp\he@dingbox}%
  \gridb@x\he@dingbox\unvbox\he@dingnotes
  \global\he@dingsfalse
  \global\first@fterheadingtrue
 \fi
}
\newif\iffirst@fterheading
%-cpar_endheadings

%+cpar_killdescenders
\def\killd@scenders#1{%
  \vbox{\unvbox#1 \skip0=\lastskip\unskip \count255=\lastpenalty\unpenalty
    \setbox0=\lastbox\dimen4=\dp0  % Remember last box's depth
    \ifvoid0\else\dp0=0pt \box0 \fi
    \ifdim\skip0>0pt \penalty\count255 \vskip\skip0 \fi}}
%-cpar_killdescenders

%
% Given a box of headings, output it but ensure we use an integral number of lines altogether
%
%+cpar_gridbox1
\def\gr@db@x#1{%
% \setbox0=\vbox{\kern-#1pt\vrule\kern#1pt\kern-.4pt\box#1\kern-.4pt\vrule}%
\setbox0=\vbox{\unvbox#1}%\ifgridp@c\vbox{\box#1}\else\killd@scenders#1\fi%
\trace{h}{before gridbox: ht0=\the\ht0; dp0=\the\dp0 (dp was \the\dimen4)}%
%\MSG{after killd: ht0=\the\ht0; dp0=\the\dp0}
%{\showboxbreadth=100 \showboxdepth=10 \showbox0 }%
 \dimen2=\ht0 \advance\dimen2 by \dp0
 %\dimen0=\ifnum\@djustment>0 -\baselineskip\else0pt\fi
 \dimen0=0pt
 \ifgridp@c\line{}\nobreak\fi % otherwise first \line in loop won't get any baselineskip
                              % when doing a picture box, because it's not part of the
                              % current page
 \loop \ifdim\dimen0<\dimen2                                                    %(1)
   \advance\dimen0 by \baselineskip
   \line{}\nobreak \repeat
 \setbox0=\vbox to 0pt{\kern-\ht0\unvbox0}%
 \trace{h}{after gridbox: dimen0=\the\dimen0; dp0=\the\dp0}%
 \unvbox0 \nobreak
}
\newif\ifgridp@c % if applying \gridb@x to a picture box rather than headings
%-cpar_gridbox1

%+cpar_gridbox2
% returns in \dimen0 how much to advance \dimen1 to be an integral multiple of \dimen0
\def\m@d{\dimen3=\dimen1\divide\dimen1\dimen0\multiply\dimen1\dimen0\advance\dimen3 by -\dimen1\advance\dimen0 by -\dimen3}

\def\gr@db@@x#1{%
  \ifhmode\endgraf\fi % Not sure why, but sometiems we get here in hmode
  \prevdepth=0pt
  \setbox0=\ifgridp@c\vbox{\box#1}\else\killd@scenders#1\fi
  \ifVisTraceExtra
    \setbox0=\vbox{\box0\doVisTraceT{G}\box0}%
  \fi
  \trace{h}{before gridbox: ht0=\the\ht0; dp0=\the\dp0 (\the\dimen4); spacebefore=\the\headingtopspace; depth=\the\lastdepth}%
  \s@tbaseline{p}\dimen1=\ht0 \dimen0=\baselineskip \m@d \dimen2=\dimen0 % dimen2 is grid space
  \dimen1=\ht0 \advance\dimen1 by -\headingtopspace
  \dimen0=\baselineskip \m@d \advance\dimen2 by -\dimen0
  \advance\dimen2 by \headingtopspace                                           %(1)
  \ifgridp@c\else
    \ifdim\lastdepth>0pt\advance\dimen2 by -\lastdepth\fi
  \fi
  \ifdiglot\kern\else\vskip\fi\dimen2
  \vbox{\kern\dimen0\vskip-\headingtopspace
    \trace{h}{after gridbox(\ch@pter.\v@rse): skip \the\dimen2, kern \the\dimen0; baselineskip=\the\baselineskip}%
    \unvbox0}\nobreak
}

\newif\ifsquashgridbox\squashgridboxtrue                                        %(2)
\let\gridb@x\gr@db@@x % overridden during \ptxfile setup, depending on \ifdiglot and \ifsquashgridbox 
%-cpar_gridbox2

\def\at@ndofthispar{}
\def\at@ndofthisparR{}
\def\at@ndofthisparL{}
\def\at@ndofthisparDelay{}
\def\at@ndofthisparRDelay{}
\def\at@ndofthisparLDelay{}

%+cpar_par
% end a paragraph, handling cutouts (shaping around drop-cap) if any, and the <end> hook
\def\par{\ifhmode
   \makecutouts
   \cl@singhooks{end}{\m@rker}%
   \trace{j}{baselineskip = \the\baselineskip, looseness = \the\looseness}%
   \endgraf
   \ifvmode\ifinn@te\else\ifhe@dings\else\lastdepth=\prevdepth\fi\fi\fi
   \cutoutcarryover 
 \fi
 \do@ndofthispar
}
%-cpar_par
% No blank line here!
%+cpar_doendofthispar
\def\do@ndofthispar{%
 %run code to insert picb@x / picb@xR at the right time.
 \edef\eotpn@me{at@ndofthispar\c@rrdstat}% Which endofthispar macro?
 \x@\let\x@\pn@xt\csname \eotpn@me\endcsname
 \trace{g}{doendofthispar \ch@pter:\v@rse\c@rrdstat \space \the\pagetotal,
           \the\holdinginserts, page/chunk-\ifp@gestart start\else -middle\fi}%
 \temptrue %If iftemp stays true, then it's a valid insertion point.
 \ifx\pn@xt\empty\tempfalse\fi
 \ifinn@te\tempfalse\fi %No pictures in notes!
 \ifdiglot
   \ifp@gestart\tempfalse\fi
 \else 
   \ifdim\pagetotal=0pt \tempfalse\fi
 \fi
 \ifx\pn@xt\empty\else
   \iftemp
     %Potential inclusion location. Check delay.
     \edef\temp{\csname\eotpn@me Delay\endcsname}%
     \ifx\temp\empty\else
       \let\pn@xt=\empty
       \trace{g}{\ch@pter:\v@rse. Delayed by specification (\temp)}%
       \x@\shrinkdel@y \temp\EDLY\relax
       \trace{g}{Delay for \eotpn@me set to \temp}%
       \x@\xdef\csname \eotpn@me Delay\endcsname{\temp}%
       \edef\eotpn@me{empty}%
     \fi
   \else
     \edef\eotpn@me{empty}%
     \let\pn@xt=\empty
     \trace{g}{\ch@pter:\v@rse. Not here}%
   \fi
 \fi
 \ifx\pn@xt\empty\else
   % Time to acually include the picture
   \trace{g}{\eotpn@me\space used (\the\holdinginserts)\the\ht\picb@x / \the\ht\picb@xR}%
   %\nonstopmode
   %\show\pn@xt
   %\edef\pn@xt{\hbox{x}}% test code
   \x@\global\x@\let\csname\eotpn@me\endcsname=\empty 
   \pn@xt\relax 
 \fi
}

\def\shrinkdel@y#1|#2\EDLY{\trace{g}{shrink {#1}{#2}}\xdef\temp{#2}}
%-cpar_doendofthispar

%
% Handle a paragraph style marker (parameter is the marker name)
%
%+cpar_parstyle_intro
\newif\ifhe@dingstyle
\newif\ifnsp@cebefore
\newif\ifJustifyPars \JustifyParstrue
\def\introAmbigious#1{\x@\def\csname intro@mbigious-#1\endcsname{t}}
\def\settest@mb#1{\x@\let\x@\test@mb\csname intro@mbigious-#1\endcsname}
\introAmbigious{iex} % iex can be intro or not intro.

\newdimen\lastdepth
\newcount\dropped@ther@lines
\dropped@ther@lines=0
\def\endit@P{%Called by whileitp@ps, to end a paragraph style
 \let\p@r=\par % end the paragraph
 \ifhmode\unskip % remove any trailing space
   \beginL\pdfsavepos
   \write\p@rlocs{\noexpand\@parend{\the\pdflastxpos}{\the\pdflastypos}}\endL       %(1)
   %\ifnum\pagetracing>0\tracingparagraphs=1\ifnum\pagetracing>1\looseness=-1%\emergencystretch=1sp
   %  \fi\else\tolerance=10\fi
   \p@r
   \ifvmode
    %\ifdim\prevdepth>0pt\lastdepth=\prevdepth\else\lastdepth=-1pt\fi
   \else
     %\lastdepth=0pt
     \ifinner\trace{s}{Inner mode at end of paragraph style \m@rker}\fi
   \fi
   \trace{C}{enditP: \the\dropped@ther@lines, \ifdr@ppednumber dropped num\fi, \pending@items}%
   \ifnum\pagetracing>0\tracingparagraphs=0\fi
   \ifnum 0\ifdr@ppednumber 1\else\ifnum\dropped@ther@lines>0 1\fi\ifx\pending@items\cstackempty\else1\fi\fi>0 % the preceding par had a dropped number or other cutout;                       %(2)
                    % add \nobreak if it was a single line, else clear the flag
     \x@\write\x@\p@rlocs\x@{\x@\noexpand\x@\@parlines\x@{\the\prevgraf}}%
     \ifnum\prevgraf=1 \nobreak\else 
       \dr@ppednumberfalse 
       \ifnum\prevgraf<\dropped@ther@lines \nobreak
       \fi
     \fi
     \ifnum\dropped@ther@lines>0
       \advance\dropped@ther@lines by -\prevgraf
     \fi
   \fi
 \fi
 \mcpop
}

\def\endlastp@rstyle#1{%
 \ifsk@pping \egroup \fi % if we were skipping nonpublishable text, end that mode
 \let\p@r=\par
 \the\p@rstylehooks % allow other modules to hook in here
 \end@llpoppedstyles{P}%
%-cpar_parstyle_intro
%+cpar_parstyle_after
 \t@stpublishability{#1}% test if the new marker is nonpublishable
 \ifn@npublishable
  \p@r% End the present paragaph, to make sure that cutouts, etc. are handled properly
  \setbox\j@nkbox=\vbox\bgroup\def\m@rker{#1}\sk@ppingtrue % and if so, start a box to consume and discard the text
 \else % else we need to actually process it!
  \ifx\m@rker\relax\else
    \getp@ram{spaceafter}{\m@rker}% output any <spaceafter> for the previous style
  \fi
  \ifx\p@ram\relax \else
    \ifhe@dings\nobreak\fi
    \vskip\p@ram\verticalsp@ceunit                                              %(1)
  \fi
  %\ifx\mcstack\mcstack@mpty\else
    %\def\d@##1+##2\E{\edef\tmp{##2}%
      %\ifx\tmp\m@rker\else\ifx\m@rker\relax\else\MSG{Bad closing marker "\tmp" expecting "\m@rker"}\fi\fi}%
  
    %\mctop \mcpop                                                                 %(2)
  %\fi
  \cl@singhooks{after}{\m@rker}%
  \the\afterh@@ks
 \fi
}
\def\p@rstyle#1{\trace{s}{p@rstyle: #1}%
 \endlastp@rstyle{#1}%
 \ifn@npublishable\else
  \gdef\m@rker{#1}% remember the new style name
  \mcpushunderms{P+#1}%
  \trace{s}{Pushed P+#1,  stack now: \mcstack}%
  \op@ninghooks{before}{\m@rker}%
%-cpar_parstyle_after
  %
  % now we check what kind of marker this is: intro? title? section? other?
  % and switch to the appropriate mode
  %
%+cpar_parstyle_transition
  \let\styst@k=\empty
  \def\d@##1+##2\E{\edef\tmp{##2}\csname d@code-##1\endcsname\let\t@pstyle\tmp}\mctop
  \s@tstyst@k{\t@pstyle}%
  \x@\t@stintro\m@rker\relax
  %If the marker is an (ultra-rare) type that occurs in introductions and normal text, then
  %set the intromarker flag based on what the current state (\if@ntro) is.
  \ifReenterIntroOK
    \settest@mb{\m@rker}\ifx\test@mb\relax\else
      \if@ntro\@ntromarkertrue\else\@ntromarkerfalse\fi 
    \fi
  \fi
  % \tr is treated as an intro marker if we're already in intro mode
  \if@tablerow\if@ntro\@ntromarkertrue\fi\fi
  \global\he@dingstylefalse
  \getp@ram{type}{\m@rker}%
  \ifx\p@ram\t@tle
    \mark{\t@tle}\ifdiglot\marks\csname m@rknum\c@rrdstat\endcsname{\t@tle}\fi% 
    \ift@tle\else\ifhe@dings\endhe@dings\fi\fi
    \st@rttitle
    \global\he@dingstyletrue 
  \else\ifx\p@ram\s@ction                                                       %(1)
    \ift@tle\ifhe@dings\endhe@dings\fi\fi
    \if@ntromarker\st@rtintro\else\st@rtbody\fi
    \global\he@dingstyletrue
  \else\ifx\p@ram\oth@r
    \ift@tle\ifhe@dings\endhe@dings\fi\fi
    \if@ntromarker\st@rtintro\else\st@rtbody\fi
    \if@ntromarker\else\global\he@dingstyletrue\fi
  \else
    \if@ntromarker\st@rtintro\else\st@rtbody\fi
  \fi\fi\fi                                                                     %(2)
  \ifhe@dingstyle\trace{s}{headingstyle true}%
    \ifhe@dings\nsp@cebeforetrue\s@tbaseline{\m@rker}%In a heading again, may be different so set a new baseline
    \else
        % Headingtopspace gets removed at top of page, preserve for titles.
        \getp@ram{spacebefore}{\m@rker}\ifx\p@ram\relax\headingtopspace=0pt\else
          \ift@tle\headingtopspace=0pt\else\headingtopspace=\p@ram\verticalsp@ceunit\fi\fi
        \setbox\he@dingbox=\vbox\bgroup\global\he@dingstrue
        \s@tbaseline{\m@rker}% Obey baseline changes for headings
        \linepenalty=1000 % minimize line count
        \interlinepenalty=10000 % never break column/page between lines
        \XeTeXdashbreakstate=0 % mainly for ranges in \r
        \hyphenpenalty=10000 \exhyphenpenalty=10000 % don't hyphenate in headings
    \fi
    \nobreak
  \else\trace{s}{headingstyle false}%
    \ifhe@dings\endhe@dings\fi
    \s@tbaseline{\m@rker}%
  \fi
  \getp@ram{spacebefore}{\m@rker}% output <spacebefore> for this style
  \ifx\p@ram\relax \else
    \ifhe@dings\nobreak\fi
    \ifnsp@cebefore\nsp@cebeforefalse
      \ifdim\p@ram\verticalsp@ceunit<0pt\vskip\p@ram\verticalsp@ceunit\fi
    \else\vskip\p@ram\verticalsp@ceunit\fi
  \fi
  \global\startparatrue
  \resetp@rstyle
%-cpar_parstyle_transition
  \trace{sP}{Redefined everypar}%
%+cpar_parstyle_start
  \everypar={%
   \trace{sP}{everypar! ifch@pter\ifch@pter true\else false\fi}%
   %
   % \everypar will be triggered when the paragraph actually starts (normally at the first character of text,
   % or something like a verse number); then we'll set up margins/indents and font
   %
   \the\@veryparhooks
   \beginL\pdfsavepos
   \write\p@rlocs{\noexpand\@parstart{\the\pdflastxpos}{\the\pdflastypos}}\endL
   \ifRTL \rightskip\else\leftskip\fi =0pt
   \ifRTL \beginR \leftskip\else\rightskip\fi =0pt \ifJustifyPars\else plus .25\hsize\fi
   \getp@ram{justification}{\m@rker}%
   \ifx\p@ram\c@nter
    \leftskip=0pt plus \hsize \rightskip=\leftskip \parfillskip=0pt
   \else\ifx\p@ram\l@ft
    \ifRTL\leftskip\else\rightskip\fi=0pt plus .25\hsize \ifRTL\parfillskip=0pt\fi
   \else\ifx\p@ram\r@ght
    \ifRTL\rightskip\else\leftskip\fi=0pt plus .25\hsize \ifRTL\else\parfillskip=0pt\fi
   \fi\fi\fi
   \getp@ram{leftmargin}{\m@rker}%                                              %(1)
   \ifx\p@ram\relax \else \advance \ifRTL\rightskip\else\leftskip\fi\p@ram \IndentUnit \fi
   \getp@ram{rightmargin}{\m@rker}%
   \ifx\p@ram\relax \else \advance \ifRTL\leftskip\else\rightskip\fi\p@ram \IndentUnit \fi
   \trace{s}{\m@rker\g@tdstat\space iu=\the\IndentUnit, ls=\the\leftskip, rs=\the\rightskip}%
   \getp@ram{fontsize}{\m@rker}\edef\c@rrfontsize{\ifx\p@ram\relax12\else\p@ram\fi}%Need to set this before calling s@tfont, else that will consder the current fontsize as ruling.
   \setwh@tvrstyle% set up font attributes (based on style stack)
   \trace{j}{baselineskip=\the\baselineskip ; UseGlyphMetrics=\the\XeTeXuseglyphmetrics}%
   \allowp@rindenttrue
   %
   % Generate top-level PDF bookmark if the \h book name has changed
   \pdfb@@kmark
   \getp@ram{firstindent}{\m@rker}\let\f@rstindent=\p@ram
%-cpar_parstyle_start
   %
   % handle drop-cap style chapter number, if this is the beginning of a chapter
   %
%+cpar_parstyle_chapter
   \ifinextended\else\ifch@pter
    \getp@ram{type}{\m@rker}%
    \ifx\p@ram\v@rsetext
     \t@stpublishability{c}\ifn@npublishable
     \else
      \m@kechapterbox
      \ifRTL\let\c@tcmd=\rightcutout\else\let\c@tcmd=\leftcutout\fi
      \getp@ram{leftmargin}{\m@rker}%
      \ifx\p@ram\relax % simple case - no left indent
        \x@\c@tcmd\x@{\the\ch@pterwd}{0}{2}%
      \else % probably \q or something like that;                               %(1)
            % need to compare cutout width with leftindent
        \dimen0=\p@ram\IndentUnit \dimen2=\dimen0
        \ifx\f@rstindent\relax \else \advance\dimen0 by \f@rstindent\IndentUnit \fi
        % now \dimen0 is the real indent of the 1st line
        \dimen4=\ch@pterwd \advance\dimen4 by -\dimen0
        \ifdim\dimen4>0pt % if the chapter number doesn't fit there...
          \x@\c@tcmd\x@{\the\dimen4}{0}{1}% create extra indent
          \dimen4=\ch@pterwd \advance\dimen4 by -\dimen2 % and for wrap if needed
          \ifdim\dimen4>0pt \x@\c@tcmd\x@{\the\dimen4}{1}{1}\fi
        \else % the indent is already big enough, so just use it as is
          \setbox\ch@pterbox=\hbox to \dimen0{\box\ch@pterbox\hfil}%
        \fi
      \fi
      \global\ch@pterfalse
      \ifIndentAtChapter\else \allowp@rindentfalse \fi
      \dr@ppednumbertrue
     \fi
     % generate second-level PDF bookmark for the chapter
     \pdfch@ptermark
    \fi
%-cpar_parstyle_chapter
%+cpar_parstyle_drop
   \else
    \ifdr@ppednumber % second line of chapter number, need to check indent/cutout
     \cancelcutouts % forget existing cutout, we're re-doing it
     \ifRTL\let\c@tcmd=\rightcutout\else\let\c@tcmd=\leftcutout\fi
     \getp@ram{leftmargin}{\m@rker}%
     \ifx\p@ram\relax % simple case - no left indent
       \x@\c@tcmd\x@{\the\ch@pterwd}{0}{1}%
     \else % probably \q or something like that;
           % need to compare cutout width with leftindent
       \dimen0=\p@ram\IndentUnit \dimen2=\dimen0
       \ifx\f@rstindent\relax \else \advance\dimen0 by \f@rstindent\IndentUnit \fi
       % now \dimen0 is the real indent of the 1st line
       \dimen4=\ch@pterwd \advance\dimen4 by -\dimen0
       \ifdim\dimen4>0pt % if the chapter number doesn't fit there...
         \x@\c@tcmd\x@{\the\dimen4}{0}{1}% create extra indent
       \else % the indent is already big enough, so just use it as is
       \fi
     \fi
     \dr@ppednumberfalse
     \spacefactor=\n@wchaptersf % prevent hanging verse number here
    \fi
   \fi\fi
   \run@pending
%-cpar_parstyle_drop
%+cpar_parstyle_final
   \ifx\f@rstindent\relax \else
    \x@\ifdim\f@rstindent pt<0pt
     \allowp@rindenttrue % redundant
    \else
     \iffirst@fterheading \ifIndentAfterHeading\else \allowp@rindentfalse \fi\fi
    \fi
    \ifallowp@rindent % create first-line indent, unless suppressed at dropped chapter number
                      % (note that we don't suppress negative indents, as in \q1 etc)
     \trace{Ds}{\m@rker\ifdiglot\c@rrdstat\fi\space  First indent \f@rstindent * \the\IndentUnit}%
     \kern\f@rstindent \IndentUnit                                              %(1)
    \fi
   \fi
   \ifvoid\ch@pterbox\else \kern-\wd\ch@pterbox \box\ch@pterbox \fi
   \global\p@ranesting=1
   \n@xtparstart\gdef\n@xtparstart{}%
   \op@ninghooks{start}{\m@rker}%handle <start> hook
   \ifdr@ppednumber \spacefactor=0\n@wchaptersf \fi
   \startparafalse
   % set special \spacefactor if we're at a chapter number, so \v 1 can omit the verse number here
  }% end everypar
 \fi}
%-cpar_parstyle_final

%+cpar_pdfbookmark
\newif\ifRTL
\newif\ifallowp@rindent
\newif\ifdr@ppednumber
\newif\ifdr@ppedother
\dr@ppedotherfalse
\newif\ifIndentAtChapter
\newif\ifIndentAfterHeading \IndentAfterHeadingtrue
\newif\ifOmitVerseNumberOne \OmitVerseNumberOnefalse
\newif\ifOmitVerses \OmitVersesfalse
\newif\ifDropActions \DropActionsfalse
\def\n@wchaptersf{998}
\let\b@ok\relax
\let\prevb@ok\relax
\let\b@okR\relax
\let\prevb@okR\relax
\def\pdfb@@kmark{\ifdiglot\ifx\c@rrdstat\PDFBookMarkColumn \pdfb@@km@rkD\fi\else\pdfb@@km@rk\fi}

\def\pdfb@@km@rk{\ifx\b@ok\prevb@ok
 \else
  \global\dr@ppednumberfalse
  \ifDropActions\else\bgroup\liter@lspecials
    \special{pdf:dest (\id@@@.) [@thispage /Fit]}%
    \ifx\b@ok\relax \let\t@mp=\id@@@ \else \let\t@mp=\b@ok\fi
    \special{pdf:outline 0 << /Title (\t@mp)
             /A << /S /GoTo /D (\id@@@.) >> >>}%
    \global\let\prevb@ok\b@ok\egroup\fi
 \fi}

\def\Alternative{\ /\ }%
\let\PDFBookMarkColumn=\relax
\let\b@okDiglot\empty

%Build a \Alternative separated list of book names 
\def\buildb@@k#1{\edef\bbtmp{#1}\x@\let\x@\t@st\csname b@ok\if L\bbtmp\else\bbtmp\fi\endcsname
  \ifx\t@st\relax\let\t@st\id@@@\fi
  \ifx\b@okDiglot\t@st\else 
    \ifx\b@okDiglot\empty\xdef\b@okDiglot{\t@st}\else\xdef\b@okDiglot{\b@okDiglot\Alternative\t@st}\fi
  \fi
}

\def\pdfb@@km@rkD{\ifDropActions\else
 %\tracingmacros=1
 %\tracingassigns=1
 \let\col@do\buildb@@k
 \let\b@okDiglot\empty
 \x@\each@col\diglot@list\E
 %\message{Bookname now: \b@okDiglot}%
 \ifx\b@okDiglot\prevb@okD 
 \else
  \bgroup\liter@lspecials
   \special{pdf:dest (\id@@@.) [@thispage /Fit]}%
   \special{pdf:outline 0 << /Title (\b@okDiglot)
            /A << /S /GoTo /D (\id@@@.) >> >>}%
   \global\let\prevb@okD\b@okDiglot
  \egroup
 \fi\fi}
%-cpar_pdfbookmark

%+cpar_pdfchaptermark
\def\prevch@p{}
\def\pdfch@ptermark{\ifDropActions\else\ifdiglot\ifx\c@rrdstat\PDFBookMarkColumn \pdfch@pterm@rk\fi\else\pdfch@pterm@rk\fi\fi}
\def\pdfch@pterm@rk{%
  \ifx\prevch@p\ch@pter\else
    \bgroup\liter@lspecials
    \edef\@@side{\g@tdstat}%
    \special{pdf:dest (\id@@@\@@side.\ch@pter) [@thispage /Fit]}%
    \ifdiglot
      \let\t@mp\b@okDiglot
    \else
      \let\t@mp\b@ok
    \fi
    \x@\let\x@\t@mp\csname b@ok\@@side\endcsname
    \ifx\b@ok\relax \let\t@mp=\id@@@ \fi
    \special{pdf:outline 1 << /Title (\t@mp\space\ch@pter)
             /A << /S /GoTo /D (\id@@@\@@side.\ch@pter) >> >>}%
  \egroup\fi}

%-cpar_pdfchaptermark

%+cpar_initparlocs
\newwrite\p@rlocs
\newread\readp@rlocs
\def\initp@rlocs{%
  % check if there's a delayed-chapters file from a previous run
  \openin\readp@rlocs="\j@bname.delayed"
  \ifeof\readp@rlocs \let\n@xt\relax
  \else \def\n@xt{\input "\j@bname.delayed"}\fi
  \closein\readp@rlocs
  % and if so, read it so we'll use those settings
  \n@xt
  % open the parlocs file to record paragraph and no-break-chapter locations
  \immediate\openout\p@rlocs="\j@bname.parlocs"
}
\addtoinithooks{\initp@rlocs}
\def\locs@startstop#1{%
  %\showboxdepth=99
  %\showboxbreadth=99
  \let\old@ep=\everypar
  \everypar{}%
  \setbox#1\vbox{%
    %\hsize=\wd#1%
    \edef\dc@ref@rgs{\string\@colstart{\the\ht#1}{\the\dp#1}{\the\wd#1}}%
    \pdfsavepos
    \x@\write\x@\p@rlocs\x@{\dc@ref@rgs{\the\pdflastxpos}{\the\pdflastypos}}%
    \box#1%
    \pdfsavepos
    \write\p@rlocs{\string\@colstop{\the\pdflastxpos}{\the\pdflastypos}}%
    %\MSG{\dc@ref@rgs (\the\hsize) ->}%
    }%
    %\MSG{\the\ht#1,\the\dp#1,\the\wd#1}%
    %\showbox#1
}
%-cpar_initparlocs

%+cpar_finishparlocs
\def\finishp@rlocs{%
  \immediate\closeout\p@rlocs
  \catcode`\{=1 \catcode`\}=2 \m@kedigitsother \catcode`\@=11
  \immediate\openout\delayf@le="\j@bname.delayed"
  \input "\j@bname.parlocs"
  \immediate\closeout\delayf@le
}
\newif\ifdelay@pen
\let\delayf@le=\p@rlocs % we write the delay file while reading the finished parlocs, so we can re-use the write stream
\addtoendhooks{\finishp@rlocs}
%-cpar_finishparlocs


% commands that get written to the parlocs file to record locations

%+cpar_parloccmds
%prev@y is the pdf y pos of the current paragraph
%this@y is the pdf y pos of the last line within the paragraph 
%thispar@lines is number of lines in the (recently finished) paragrpah
%
\newcount\prev@y \newcount\this@y \newcount\thing@y
\newcount\tmp@lines \newcount\thispar@lines
\def\this@pgno{}
\let\par@items\cstackempty

\def\@parstart#1#2{\prev@y=#2\relax\let\par@items\cstackempty}

\def\@parend#1#2{%
      \this@y=#2\relax}

\def\@pgstart#1{%
      \edef\this@pgno{#1}}

\def\@colstart#1#2#3#4#5{%
      \edef\prev@col@x{#4}%
      \edef\prev@col@y{#5}%
      \edef\prev@col@ht{#1}%
      \edef\prev@col@wd{#2}%
      \edef\prev@col@dp{#3}%
}
\def\@colstop#1#2{%
      \edef\this@col@x{#1}%
      \edef\this@col@y{#2}%
      \trace{C}{colstop: \par@items}%
      \let\d@=\check@pagefoot
      \x@\cstackdown\par@items\E
}

%Do somehing clever for items that are near 
%the end of the column.. Problem: the ones we're
%interested in doing clever things with were not put
%on the pending stack. Use a new stack, \par@items and
%...  Do somthing with it. At the moment just moan.
\def\check@pagefoot#1|#2|#3\E{
  \ifnum #3 < \this@col@y
    \dimen1=\this@col@y sp
    \advance \dimen1 by -#3 sp
    \MSG{*** item type '#1' in cutout at #2 drops below the bottom of the column(by more than \the\dimen1)}%
  \fi
}

\def\@parlines#1{%
  \thispar@lines=#1
%  \MSG{* calculated \string\DelayedChapter{\pendingb@@k}{\pendingch@pter}{\the\this@y}}%
  %\ifx\pendingb@@k\empty\else
    %\ifdr@ppednumber
      %\wr@teDelayedChapter{\pendingb@@k}{\pendingch@pter}{\the\thispar@lines}%
      %\let\pendingch@pter\empty\let\pendingb@@k\empty
    %\fi
  %\fi
  \ifx\pending@items\cstackempty\else
    \trace{C}{Before parlines: pending: \pending@items}%
   % \thispar@lines=\prev@y\advance\thispar@lines by -\this@y
   % \divide\thispar@lines by \baselineskip
    \def\D@IT{%
      %\tmp@lines=\thing@after
      \ifnum\thing@after>500\MSG{*** Rubbish data got into parlocs file.  \this@thing\space\thing@ref\space ignored}%
      \else
        \ifnum\thing@after>\thispar@lines
	  \MSG{*** \this@thing\space \thing@ref Is supposed to be delayed by \thing@after lines, but paragraph is \the\thispar@lines long}%
	  \tmp@lines=\thing@after
	  \advance\tmp@lines by -\thispar@lines
	  \edef\thing@after{\the\tmp@lines}%
	  \add@pending{\this@thing}{\thing@ref}{\the\this@y}{\thing@wd}{\thing@ht}{\thing@after}{\thing@side}%
      %\this@y=#2\relax
      %\ifnum\thing@y=0% First time. Don't adjust anything
        \else
          \ifnum\thing@y<\this@y
            \MSG{*** unable to determine \string\DelayedItem\space setting for \this@thing/\thing@ref (\the\thing@y, \the\this@y), removed from list}%
          \else
            \tmp@lines=\thing@y
            \advance\tmp@lines by -\this@y
            \divide\tmp@lines by \baselineskip
	    \advance\tmp@lines by \thing@after
	    \MSG{\this@thing \thing@ref [ \thing@after=>\the\tmp@lines]}%
	    \add@pending{\this@thing}{\thing@ref}{\the\this@y}{\thing@wd}{\thing@ht}{\thing@after}{\thing@side}%
          \fi
	\fi
      \fi
    }
    \let\d@=\parse@pending
    \let\tmp\pending@items
    \global\let\pending@items\cstackempty
    \x@\cstackup\tmp\E
    \trace{C}{After parlines: pending: \pending@items}%
  \fi
  \let\n@xtline=\relax
  \trace{C}{Pending: \pending@items}%
  \ifx\pending@items\cstackempty\else
    \let\d@=\write@pending
    \x@\cstackdown\pending@items\E
  \fi
}
%-cpar_parloccmds

%+cpar_delayedchap
%\def\@delayedchapter#1#2#3#4{\chap@y=#4\relax
  %\ifnum\prev@y<\chap@y % para start was lower than chapter number, must have passed a col/page break
    %\def\pendingb@@k{#1}%
    %\def\pendingch@pter{#2}%
  %\else % para start level with or above chapter number; OK to calculate # of lines
    %\advance\prev@y by -\chap@y
    %\divide\prev@y by \baselineskip
    %\MSG{* calculated \string\DelayedChapter{#1}{#2}{\the\prev@y}}%
    %\wr@teDelayedChapter{#1}{#2}{\the\prev@y}%
  %\fi}

\def\@delayedchapter#1#2#3#4{% Part of post-run processing
  \trace{C}{delayedchapter #1 #2 #3 #4}%
  \@delayedthing{chapter}{#1#2.0}{#4}{\the\ch@pterwd}{2}{0}{\ifRTL R\else L\fi}{#3}{#4}}

%
\def\@delayedthing#1#2#3#4#5#6#7#8#9{\thing@y=#9\relax %Part of post-run processing
  \trace{C}{delayedthing #1 #2 #3 #4 #5 #6 #7 #8 #9}%
  \ifnum\the\prev@y<\thing@y % para start was lower than chapter number, must have passed a col/page break
    %%\def\this@thing{#1}% What is it?
    %\def\thing@ref{#2}% Unique id.
    \trace{C}{* saved pending  \string\DelayedItem{#1}{#2}}%
    \add@pending{#1}{#2}{\the\thing@y}{#4}{#5}{#6}{#7}%
  \else % para start level with or above chapter number; OK to calculate # of lines
    %First, remember where the bottom of the item
    %probably is.
    \tmp@lines=\thing@y
    \dimen1=#4
    \advance\tmp@lines by -\dimen1
    \dimen1=#6\baselineskip
    \advance\tmp@lines by -\dimen1
    \edef\par@items{\cstackpush{\par@items}{#1|#2|\the\tmp@lines}}%
    \tmp@lines=\prev@y
    \advance\tmp@lines by -\thing@y
    \divide\tmp@lines by \baselineskip
    \advance\tmp@lines by #6
    \trace{C}{* calculated \string\DelayedItem{#1}{#2}{\the\tmp@lines} (#4 x#5 @#6)}%
    %\add@pending{#1}{#2}{\the\thing@y}{#4}{#5}{\the\tmp@lines}{#7}%
    \wr@teDelayedItem{#1}{#2}{\the\tmp@lines}{(#4x#5@#6)#7}%
  \fi}

%-cpar_delayedchap

%+cpar_writedelayed
\def\setCutoutSlop#1#2#3{\x@\edef\csname raiselimits-#1\endcsname{#2,#3}}
\setCutoutSlop{chapter}{1}{0}
\def\g@tCutoutSlop#1{\x@\let\x@\r@iselimit\csname raiselimits-#1\endcsname\ifx\r@iselimit\relax\x@\p@rselimit 2,1\E\else\x@\p@rselimit\r@iselimit\E\fi}
\def\p@rselimit#1,#2\E{\edef\r@isemin{-#1}\edef\r@isemax{#2}}

\def\wr@teDelayedItem#1#2#3#4{% Part of post-run processing
  %\wr@teDelayedItem{thingtype}{curref}{delay}{cutout wd}{cutout ht}{cutout after}{cutout side}%
  \def\c@rref{#2}%
  \trace{C}{wDI}%
  \delay@test{#1}%
  \raise@test{#1}%
  \ifx\t@std@lay\relax \pr@vdelay=0 
  \else \pr@vdelay=\t@std@lay\fi
  \th@sdelay=#3\relax
  \ifnum\pr@vdelay=\th@sdelay % if the delay value is unchanged, all is good
    \ifx\t@str@ise\relax
      \trace{C}{PARLOC:ok}%
    \else
       \ifnum\t@str@ise=0\else
         \MSG{PARLOC: Rerun. RaiseItem was applied for #1 #2, but not needed}%
       \fi
    \fi
  \else
    \tmp@lines=\pr@vdelay
    \advance\tmp@lines by -\th@sdelay
    %\ifx\t@str@ise\relax \else \count255=\t@str@ise\advance\tmp@lines by -\count255\fi
    %\ifnum\tmp@lines <0 \count255=-\tmp@lines\else\count255=\tmp@lines\fi
    \g@tCutoutSlop{#1}%
    \trace{C}{tmplines=\the\tmp@lines, \r@isemin, \r@isemax}%
    \tempfalse
    \ifnum \tmp@lines<\r@isemin\relax \temptrue\fi
    \ifnum \tmp@lines>\r@isemax\relax \temptrue\fi  % if new delay is <2 away than old, we can use \RaiseItem
    \iftemp
      \MSG{PARLOC: Rerun. Delayed #1 setting changed (from \the\pr@vdelay to \the\th@sdelay) at #2}%
    \else
      \th@sdelay=\pr@vdelay % Retain past delay and (if needed) use raiseitem
      \multiply\tmp@lines by -1 % change sign to match semantics of raise.
      \ifx\t@str@ise\relax
        \ifnum\tmp@lines=0\else
          \ifx\t@std@lay\relax\else
            \MSG{PARLOC: Rerun. RaiseItem needed at #1 #2}%
            \temptrue
          \fi
        \fi
      \else 
        \ifnum\tmp@lines=\t@str@ise
          \ifnum\tmp@lines=0\relax\else % Need the same RaiseItem we had last time. 
            \trace{C}{PARLOC: OK.  RaiseItem still needed at #1 #2}%
            \temptrue
          \fi
        \else 
          \MSG{PARLOC: Rerun with new RaiseItem (by \the\tmp@lines was \t@str@ise) at #1 #2}%   
          \temptrue
        \fi
      \fi
      \iftemp
        \immediate\write\delayf@le{\string\RaiseItem{#1}{#2}{\the\tmp@lines}}%
      \fi
    \fi
  \fi
  \immediate\write\delayf@le{\string\DelayedItem{#1}{#2}{\number\th@sdelay}{#4}}%
}
\newcount\pr@vdelay \newcount\th@sdelay
\newif\ifsk@pping \newbox\j@nkbox
%-cpar_writedelayed

% Create the drop-cap in \ch@pterbox
%+cpar_makechapterbox
\newdimen\ch@pterwd
\newbox\ch@pterbox
\newbox\ch@pternote
\def\AfterChapterSpaceFactor{3}
\def\m@kechapterbox{%
 \trace{sP}{m@kechapterbox for \ch@ptert@xt}%
 \edef\@seglyphmetrics{\the\XeTeXuseglyphmetrics}\XeTeXuseglyphmetrics=3%
 \edef\printchapter{\ch@ptert@xt}%
 \csname PrepChapterNumber\endcsname
 \setbox\ch@pterbox=\hbox{\s@tfont{c}\printchapter}%
 \ifrotate
  \dimen0=1.0\ht\ch@pterbox
  \dimen1=\ht\ch@pterbox \advance\dimen1 by \dp\ch@pterbox\advance\dimen1 by \AfterChapterSpaceFactor\FontSizeUnit
  \dimen2=0.5\wd\ch@pterbox \advance\dimen2 by -0.5\ht\ch@pterbox
  \setbox\ch@pterbox=\hbox{\lower\dimen2\hbox to \dimen0{%
    \hskip\ht\ch@pterbox \special{x:gsave}\special{x:rotate 90}%
    \box\ch@pterbox\special{x:grestore}\hss}}%
  \ht\ch@pterbox=\wd\ch@pterbox\wd\ch@pterbox=\dimen1
 \else
  \getp@ram{raise}{c}%
  \dimen0\baselineskip\ifx\p@ram\relax\else\advance\dimen0 by -\p@ram\fi
  \setbox\ch@pterbox=\hbox{\lower\dimen0\box\ch@pterbox
    \box\ch@pternote\kern\AfterChapterSpaceFactor\FontSizeUnit}%
 \fi
 \XeTeXuseglyphmetrics=\@seglyphmetrics
 \ch@pterwd=\wd\ch@pterbox
 \dp\ch@pterbox=0pt
}
%-cpar_makechapterbox

%+cpar_ptxnb
% Used to delay a cutout until later in the paragraph, for no-break chapter numbers
%\def\DelayedChapter#1#2#3{\uppercase{\def\ucb@@k{#1}}%
  %\x@\edef\csname delay-\ucb@@k.#2\endcsname{#3}}

\def\DelayedChapter#1#2#3{\uppercase{\def\ucb@@k{#1}}%
  \DelayedItem{chapter}{\ucb@@k.#2}{#3}{#2}}

%Param 3 is in lines.
\def\DelayedItem#1#2#3#4{%
  \x@\xdef\csname delay-#1.#2\endcsname{#3}\x@\xdef\csname delayparam-#1.#2\endcsname{#4}}

% Used to set a delayed paragraph number one line higher (projecting above the line with v.1 instead of below it)
%\def\RaiseChapter#1#2{\uppercase{\def\ucb@@k{#1}}%
  %\x@\let\csname raise-\ucb@@k.#2\endcsname=1}
\def\RaiseChapter#1#2{\uppercase{\def\ucb@@k{#1}}%
  \RaiseItem{chapter}{\ucb@@k.#2}{-1}}

\def\RaiseItem#1#2#3{%
  \x@\def\csname raise-#1.#2\endcsname{#3}}%

\def\delay@test#1{\trace{C}{delay@test: \id@@@\ifdiglot\c@rrdstat\fi.\ch@pter: #1 \c@rref}%
    \x@\let\x@\t@std@lay\csname delay-#1.\c@rref\endcsname}
\def\raise@test#1{\trace{C}{raise@test: \id@@@\ifdiglot\c@rrdstat\fi.\ch@pter: #1 \c@rref}%
    \x@\let\x@\t@str@ise\csname raise-#1.\c@rref\endcsname}

\def\ptx@nb{%
  \ifch@pter
    \delay@test{chapter}%
    %\x@\let\x@\t@st\csname delay-\id@@@.\ch@pter\endcsname
    \ifx\t@std@lay\relax
      \MSG{*** no-break at \id@@@\ifdiglot \c@rrdstat\fi\space\ch@pter, re-run to generate \string\DelayedChapter\space setting}%
      \def\t@std@lay{0}%
    \else 
      \MSG{* no-break at \id@@@\space\ch@pter (\t@std@lay)}%
    \fi
    \leavevmode\str@t                                                           %(1)
    \global\ch@pterfalse
    \t@stpublishability{c}\ifn@npublishable
     \setbox\ch@pterbox=\box\voidb@x
    \else
     \m@kechapterbox
     \setbox\ch@pterbox=\hbox{\box\ch@pterbox
       \kern\ifRTL\rightskip\else\leftskip\fi}%
     %\ifRTL\let\c@tcmd=\rightcutout\else\let\c@tcmd=\leftcutout\fi
     %\x@\c@tcmd\x@{\the\ch@pterwd}{\t@std@lay}{2}%
     \vadjust{\vbox to 0pt{\kern-\dp\str@tbox \kern-\ht\ch@pterbox              %(2)
      \raise@test{chapter}%
      \ifx\t@str@ise\relax \else \kern-\t@str@ise\baselineskip \fi
      \ifRTL\let\n@xt\rightline\else\let\n@xt\leftline\fi
      \n@xt{\ifRTL\beginR\fi\box\ch@pterbox\ifRTL\endR\fi}\vss}%
      \pdfb@@kmark\pdfch@ptermark\nobreak}%
     \beginL\pdfsavepos                                                         %(3)
     %\edef\dc@ref@rgs{\string\@delayedchapter\string{\id@@@\string}\string{\ch@pter\string}}%
     \ifdiglot\edef\@@ref{\id@@@\c@rrdstat}\else\edef\@@ref{\id@@@}\fi
     \edef\dc@ref@rgs{\string\@delayedchapter\string{\@@ref\string}\string{\ch@pter\string}}%
     \x@\write\x@\p@rlocs\x@{\dc@ref@rgs{\the\pdflastxpos}{\the\pdflastypos}}\endL
     \dr@ppednumbertrue
     \add@pending{chapter}{\c@rref}{0}{\the\ch@pterwd}{2}{\t@std@lay}{\ifRTL R\else L\fi}%
     \run@pending
    \fi
  \else
    \MSG{nb ignored near \c@rref: not after chapter}%
  \fi}

\newbox\str@tbox
\def\mkstr@t{\setbox\str@tbox=\hbox to 0pt{\XeTeXuseglyphmetrics=0                %(4)
  \char32 \hss}}
\def\str@t{\mkstr@t\copy\str@tbox}
%-cpar_ptxnb

%+cpar_strings
% strings for testing against stylesheet parameters
\def\v@rsetext{versetext}
\def\c@nter{center}
\def\l@ft{left}
\def\r@ght{right}
\def\t@tle{title}
\def\s@ction{section}
\def\oth@r{other}
%-cpar_strings

%+cpar_resetparstyle
\def\resetp@rstyle{%
 \leftskip=0pt \rightskip=\leftskip
% \dimen0=\hsize \advance\dimen0 by -4em \parfillskip=2em plus \dimen0 minus 1em
 \parfillskip=0pt plus 1fil
 %\emergencystretch=11in
 \parindent=0pt }
%-cpar_resetparstyle

\endinput
