%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007-2020 by SIL International
% written by Jonathan Kew
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Character style macros

%+cchar_parsecolor
\def\hex#1{\count3=#1\relax%
  \edef\r@s{}\count1=0
  \loop%
    \count2=\count3 \divide\count2 by 16 \multiply\count2 by 16
    \advance\count3 by -\count2
    \ifnum\count3=0\edef\r@s{0\r@s}\else\ifnum\count3<10 \edef\r@s{\number\count3 \r@s}%
    \else\advance\count3 by -10 \edef\r@s{\ifcase\count3 A\or B\or C\or D\or E\or F\fi\r@s}\fi\fi%
    \divide\count2 by 16 \count3=\count2 \advance\count1 by 1
    \ifnum\count1<6\repeat%
  \count3=0 \count1=0 \count2=0
}

\def\colorhex#1{\count1=#1\divide\count1 by 256\multiply\count1 by 256
    \count2=#1\advance\count2 by -\count1 \multiply\count2 by 65536 % r << 16
    \count3=#1\divide\count3 by 65536 \multiply\count3 by 65536 % b << 16
    \advance\count1 by -\count3 \divide\count3 by 65536 % count1=g << 8, count3=b
    \advance\count3 by \count2 \advance\count3 by \count1%
    \hex{\count3}%
}

\def\ParseColor#1#2\end{\edef\t@mp{#1}\trace{F}{Color prefix is "#1"}%
    \if x\t@mp \edef\r@s{#2}\else\colorhex{#1#2}\fi}                                %(1)
%-cchar_parsecolor

%
% Each USFM character style marker is defined to call \ch@rstyle with the marker name as parameter
%

%+cchar_charstyle
\def\ch@rstyle#1{\trace{s}{CH@RSTYLE:#1}%
 \gdef\newch@rstyle{\detokenize{#1}}% record the name of the style
 \catcode32=12 % make <space> an "other" character, so it won't be skipped by \futurelet
 \catcode13=12 % ditto for <return>
 \futurelet\n@xt\doch@rstyle % look at following character and call \doch@rstyle
}

%Version of above for plus versions
\def\ch@rstylepls#1{\leavevmode%Stacking character styles (at least in headers) seem to break paragraph styling if they are invoked before leaving vertical mode. It's something to do with grouping. On the assumption that there will *be* text coming, it ought to be safe to leave vertical mode on meeting a stacking character style
 \trace{s}{CH@RSTYLEPLS:#1}%
 \gdef\newch@rstyle{\detokenize{#1}}% record the name of the style
 \catcode32=12 % make <space> an "other" character, so it won't be skipped by \futurelet
 \catcode13=12 % ditto for <return>
 %\tracingassigns=1
 \futurelet\n@xt\doch@rstylepls % look at following character and call \doch@rstylepls
}
%-cchar_charstyle

%+cchar_docharstyle_intro
\def\c@rrfontsize{12}
\catcode`\~=12 \lccode`\~=32 % we'll use \lowercase{~} when we need a category-12 space
\catcode`\_=12 \lccode`\_=13 % and \lowercase{_} for category-12 <return>
\lccode`\|=`\\
\lowercase{
%-cchar_docharstyle_intro
%+cchar_docharstyle
 \def\startch@rstyle@misc{\MSG{startch@rstyle@misc}\startch@rstyle \relax}%
 \def\doch@rstyle{% here, \n@xt has been \let to the next character after the marker    %(1)
  \catcode32=10 % reset <space> to act like a space again
  \catcode13=10 % and <return> is also a space (we don't want blank line -> \par)
  \tracingassigns=1
  \if\n@xt*\let\n@xt@\endch@rstylen % check for "*", if so then we need to end the style
  \else
    \temptrue
    \if\n@xt~\let\n@xt@\startch@rstyle@spc\else
      \if\n@xt_\let\n@xt@\startch@rstyle@nl\else
        \if\n@xt-\let\n@xt@\startmst@nestyle@minus\let\thismil@stone\newch@rstyle\tempfalse\else
	  \let\n@xt@\startch@rstyle@misc\fi\fi\fi
    \iftemp
      \end@llpoppedstyles{\ss@Char}% Char style
      %\end@llcharstyles % a char style closes all other char styles, milestones do not.
    \fi
  \fi % else we need to start it
  \xdef\stylet@pe{\ss@Char}%                                                                   %(2)
  \tracingassigns=0
  \n@xt@} % chain to the start or end macro
 %doch@rstylepls is like doch@rstyle, but wraps the style in a group and generates a comma-separated stack of styles.
 \def\doch@rstylepls{% here, \n@xt has been \let to the next character after the marker %(1)
  \catcode32=10 % reset <space> to act like a space again
  \catcode13=10 % and <return> is also a space (we don't want blank line -> \par)
  \trace{s}{charstyleplus}%
  %\tracingassigns=1
  \if\n@xt*\let\n@xt@\endch@rstylepls % check for "*", if so then we need to end the style
  \else\if\n@xt~\let\n@xt@\startch@rstyle@spc
    \else\if\n@xt_\let\n@xt@\startch@rstyle@nl
      \else\if\n@xt-\let\n@xt@\startmst@nestyle@minus\let\thismil@stone\newch@rstyle\else
        \else\let\n@xt\startch@rstyle
    \fi\fi\fi
  \fi % else we need to start it
  %\tracingassigns=0
  \xdef\stylet@pe{\ss@ChrP}%                                                                   %(2)
  \n@xt@} % chain to the start or end macro
 % when \startch@rstyle is called, the following <space> or <return> has become category-12
 % so we have to explicitly consume it here as part of the macro parameter list
 \def\startch@rstyle@spc~{\startch@rstyle}%                                             %(3)
 \def\startch@rstyle@nl_{\startch@rstyle}%
}
%-cchar_docharstyle

%+cchar_endstyle
\def\endch@rstylen*{%Consume the star..
  \trace{s}{endch@rstylen \newch@rstyle}%
  \def\d@##1+##2\E{\tempfalse\if ##1c\else\if ##1C\else\temptrue\fi\fi}\mctopnoms
  \iftemp\MSG{Unexpected closing marker for no plus \newch@rstyle * on stack \mcstack. Ignoring}\else\endch@rstyle*\fi
}
\def\endch@rstylepls*{%Consume the star..
  \trace{s}{endch@rstylepls \newch@rstyle}%
  \def\d@##1+##2\E{\edef\tmp{\detokenize{##2}}\edef\tmq{\newch@rstyle}\tempfalse\ifx\tmp\tmq\else\temptrue\MSG{\tmp !=\tmq}\fi}\mctopnoms
  \iftemp\MSG{Unexpected closing marker for plus +\newch@rstyle * on stack \mcstack. Ignoring}\else\endch@rstyle*\fi
}
%-cchar_endstyle
%+cchar_startcharstyle
\def\startch@rstyle{\trace{s}{startch@rstyle \newch@rstyle (\stylet@pe)}%
  \mcpush{\ifx\stylet@pe\empty C\else\stylet@pe\fi+\newch@rstyle}%
  \t@stpublishability{\newch@rstyle}\ifn@npublishable                   %(1)
   \setbox0=\hbox\bgroup\skipch@rstyletrue
   \let\thisch@rstyle=\newch@rstyle
  \else
   \leavevmode % in case the paragraph hasn't started yet               %(2)
   \op@ninghooks{before}{\newch@rstyle}% execute any <before> hook
   \x@\let\x@\@ttriblist\csname @ttriblist-\newch@rstyle\endcsname
     \bgroup % start a group to encapsulate the style's formatting changes
    \let\thisch@rstyle=\newch@rstyle % remember the current style
    \s@tfont{\thisch@rstyle}% set up font attributes
    \ifnum\n@tenesting>0 \global\advance\n@tenesting by 1 % record nesting level in para or note
    \else \global\advance\p@ranesting by 1 \fi
    \getmcp@ram{raise}%
    \tempfalse % do we box the text?
    \ifx\p@ram\relax\else \temptrue\fi
    \ifx\@ttriblist\empty\else\temptrue\fi
    \iftemp\setbox0=\hbox\bgroup \fi                     %(3)
    \op@ninghooks{start}{\thisch@rstyle}%% execute any <start> hook
  \fi
  \csname init@ttribs\endcsname %If ptx-attribute is in use, use it... 
}
%-cchar_startcharstyle

%+cchar_endcharstyle
\lccode`\|=`\\ % for printing backslash in error message
\lowercase{
 \def\endch@rstyle*{\TRACE{endch@rstyle}% consume the * that marked the SFM as ending a style
   \def\d@##1+##2\E{\xdef\oldch@rstyle{##2}}\mctopnoms
   \trace{s}{endch@rstyle \oldch@rstyle\space from \newch@rstyle}%
   \ifx\@ttributes\empty\else
     \message{\@ttributes (\csname @ttriblist-\oldch@rstyle\endcsname)}%
     \parse@ttribs{\@ttributes}%
   \fi
   \ifx\thisch@rstyle\undefined
     \MSG{*** unmatched character style end-marker |\newch@rstyle*}%
   \else
    \ifskipch@rstyle\egroup\else%
     \cl@singhooks{end}{\oldch@rstyle}% discover and execute any <end> hook
     \x@\let\x@\@ttriblist\csname @ttriblist-\oldch@rstyle\endcsname
     \getmcp@ramR{raise}%
     \ifx\@ttriblist\empty
       \ifx\p@ram\relax\else \egroup \raise\p@ram\box0 \fi
     \else
       \egroup
       \ifx\@ttributes\empty\else
         \csname complex-\oldch@rstyle\endcsname
       \fi
       \ifx\p@ram\relax
         \unhbox0
       \else\raise\p@ram\box0 \fi
     \fi
     \cl@singhooks{after}{\oldch@rstyle}% discover any <after> hooks
     \ifnum\n@tenesting>0 \global\advance\n@tenesting by -1 % decrement nesting level
     \else \global\advance\p@ranesting by -1 \fi
     \egroup % end the style's group, so formatting reverts             %(2)
     \the\afterh@@ks%\global\afterh@@ks{} % execute all the <after>-hook, if there was one
    \fi
   \mcpop
   \def\d@##1+##2\E{\edef\tmp{##2}\csname d@code-##1\endcsname\let\thiswh@tvrstyle\tmp}\mctop
   \s@tfont{\thiswh@tvrstyle}% set up font attributes
   \fi
 }
}
%-cchar_endcharstyle
%+cchar_endallcharstyles
\newif\ifskipch@rstyle
\newcount\n@tenesting \newcount\p@ranesting
\def\SuperscriptRaise{0.85ex} % note that this is in terms of the scaled-down superscript font size

%
% end all character styles in effect within the current note or paragraph
% now replaced by end@llpoppedstyles
%\def\end@llcharstyles{\let\d@=\end@llcharstyle\mcdown}
%\def\end@llcharstyle#1+#2\E{\trace{s}{endcharstyles: #1+#2}\edef\tmp{#1}%
    %\ifx\tmp\empty\else\if#1c\endch@rstyle*\else\if#1C\endch@rstyle*\else\let\d@=\cstackrelax\fi\fi\fi}
%-cchar_endallcharstyles

%\def\end@llcharstyles{%
% \ifnum\n@tenesting>0 \doendch@rstyles\n@tenesting
%  \else \doendch@rstyles\p@ranesting \fi}
%\def\doendch@rstyles#1{\@LOOP \ifnum#1>1 \endch@rstyle*\@REPEAT}
% loop macros copied from plain.tex, renamed to avoid clashes in case of nesting
%\def\@LOOP #1\@REPEAT{\gdef\@BODY{#1}\@ITERATE}
%\def\@ITERATE{\@BODY \global\let\@NEXT\@ITERATE
% \else \global\let\@NEXT\relax \fi \@NEXT}
%\let\@REPEAT\fi

%+cchar_getfontname
\newif\ifColorFonts \ColorFontstrue
%
% Set up the font attributes for a given marker (used by all style types, not only char styles)
%
\let\SpaceStretchFactor=\empty %default, do-nothing value
\let\SpaceShrinkFactor=\empty %default, do-nothing value

\def\g@tfontname#1{%
 \trace{F}{Font request for (\c@tegory)(\mspr@fix)#1}%
 \ifdiglot\ifdiglotL\def\f@ntstyle{#1L}\def\sid@{L}\else\def\f@ntstyle{#1R}\def\sid@{R}\fi\else\def\f@ntstyle{#1}\def\sid@{-}\fi%
 \ifx\mspr@fix\empty\else\edef\f@ntstyle{\mspr@fix\f@ntstyle}\fi % Milestones have different styles
 \ifx\c@tegory\empty\else\s@tc@tpr@fix\edef\f@ntstyle{\c@tprefix\f@ntstyle}\fi % Categories have different styles
 \let\d@@=\d@
 \def\d@##1+##2\E{\edef\tmp{#1}\edef\tmpa{##2}\ifx\tmp\tmpa\getmcfonts@ze\else
			\csname d@code-##1\endcsname
                        \getp@ram{fontsize}{\tmp}\ifx\p@ram\relax\xdef\c@rrfontsize{12}%
                        \else\global\let\c@rrfontsize=\p@ram\fi\fi}%
 \mctop\let\d@=\d@@\edef\f@ntstyle{\f@ntstyle-\c@rrfontsize}}
%-cchar_getfontname

%+cchar_setfont
\xdef\z@ros{000000}%What does ParseColor come out with for black?
\def\s@tfont#1{%
 \g@tfontname{#1}%
 \ifdiglot\setLRspecific\fi % FIXME: Whether diglot or not, it might have been diglot before.
 \x@\ifx\csname font<\f@ntstyle>\endcsname \relax 
  \trace{s}{s@tfont font for #1 at \c@rrfontsize}%
  \trace{S}{Normal font for \sid@\space is \regular}%
  \let\regul@r=\regular
  \let\b@ld=\bold
  \let\it@lic=\italic
  \let\b@lditalic=\bolditalic
  \let\typef@ce=\regul@r
  \getFp@ram{fontname}{#1}% see if \FontName was specified in the stylesheet
  \ifx\p@ram\relax % if not, check the \Bold and \Italic properties
	  \getFp@ramR{bold}{#1}%
	  \ifx\p@ram\tru@
		\let\typef@ce=\b@ld
		\getFp@ramR{italic}{#1}%
		\ifx\p@ram\tru@ \let\typef@ce=\b@lditalic \fi
	  \else
		\getFp@ramR{italic}{#1}%
		\ifx\p@ram\tru@ \let\typef@ce=\it@lic \fi
	  \fi
  \else
    \edef\typef@ce{"\p@ram"}% use font name from the stylesheet
  \fi
  \getFp@ramR{smallcaps}{#1}%                                           %(1)
  \ifx\p@ram\tru@
    \edef\typef@ce{\typef@ce\SmallCapsSuffix}%
  \fi
  \getFp@ram{color}{#1}%                                                %(+)
  \ifColorFonts\ifx\p@ram\relax\else
    \x@\ParseColor\p@ram\end\ifx\r@s\z@ros\else\edef\typef@ce{\typef@ce :color=\r@s}\fi%
  \fi\fi%
  \dimen0=\c@rrfontsize\FontSizeUnit                                    %(+)
  \getFp@ramR{fontfactor}{#1}% scale down by \SuperscriptFactor if superscripted style %FIXME! Should this be R version or not (regular=!shrunk??)
  \ifx\p@ram\relax\else \dimen0=\p@ram\dimen0\fi
  %\edef\f@ntstyle{\f@ntstyle-\c@rrfontsize}%
  % create the font identifier for this style
  \trace{F}{font<\f@ntstyle>=\typef@ce\space at \the\dimen0}%
  \x@\global\x@\font
    \csname font<\f@ntstyle>\endcsname=\typef@ce\space at \the \dimen0  %(+)
  \ifx\SpaceStretchFactor\empty\else
    \dimen0=\SpaceStretchFactor\x@\x@\fontdimen2\csname font<\f@ntstyle>\endcsname
    \x@\x@\fontdimen3\csname font<\f@ntstyle>\endcsname=\dimen0
    \trace{F}{Font \f@ntstyle, space stretch \the\dimen0}%
  \fi
  \ifx\SpaceShrinkFactor\empty\else
    \dimen0=\SpaceShrinkFactor\x@\x@\fontdimen2\csname font<\f@ntstyle>\endcsname
    \x@\x@\fontdimen4\csname font<\f@ntstyle>\endcsname=\dimen0
    \trace{F}{Font \f@ntstyle, space shrink \the\dimen0}%
  \fi
 \fi
 % switch to the appropriate font
 \trace{F}{Font set to font<\f@ntstyle>}%
 \csname font<\f@ntstyle>\endcsname                                     %(+)
}
%-cchar_setfont

%+cchar_extrafont
\def\extraregular{"Times New Roman"}
\def\s@textrafont#1{%
  \ifcsname extrafont<#1>\endcsname\else
    \let\typef@ce=\extraregular
    \getmcfonts@ze
    \dimen0=\c@rrfontsize\FontSizeUnit
    \getmcp@ramR{fontfactor}% scale down by \SuperscriptFactor if superscripted style
    \ifx\p@ram\relax\else \multiply\dimen0 by \p@ram\fi
    \x@\global\x@\font\csname extrafont<#1>\endcsname=\typef@ce\space at \dimen0
    \trace{s}{define extrafont<#1> \typef@ce\space at \the\dimen0}%
  \fi
  \trace{s}{extrafont<#1> =\csname extrafont<#1>\endcsname}%
  \csname extrafont<#1>\endcsname
}
\def\tru@{true}
\def\SuperscriptFactor{0.75}
\def\SmallCapsSuffix{/ICU:+smcp}
%-cchar_extrafont

\endinput
