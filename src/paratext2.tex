%:skip
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007 by SIL International
% written by Jonathan Kew
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Paratext formatting macros, spanning footnotes version

%+c_pt_intro
% Here we declare generic useful stuff. Including log output routines.
\TeXXeTstate=1 % enable the eTeX bidi extensions, in case we need RTL support
\catcode`\@=11
\let\x@=\expandafter
\newif\iftemp \tempfalse

\def\MSG{\immediate\write16 } % shorthand to write a message to the terminal
\def\TRACE#1{}%\let\TRACE=\MSG % default - consume messages

% This lot has to be early
\newif\ifinn@te\inn@tefalse
\newif\ifm@rksonpage % Try to keep track of marks, so we can kill them in end-sections. 
\m@rksonpagefalse
%-c_pt_intro

%+c_define-hooks
% `\addtoendhooks` collects macros to be executed at the end of the job
\def\addtoendhooks#1{\x@\global\x@\@ndhooks\x@{\the\@ndhooks #1}}
\def\addtoendptxhooks#1{\x@\global\x@\@ndptxhooks\x@{\the\@ndptxhooks #1}}
\newtoks\@ndhooks
\newtoks\@ndptxhooks
\let\s@ve@nd=\end
\def\end{\ifsk@pping\egroup\fi\par\vfill\supereject  \the\@ndhooks \s@ve@nd}

%: `\addtoinithooks` is for stuff we do during one-time-setup before the first PTX file
\def\addtoinithooks#1{\x@\global\x@\@nithooks\x@{\the\@nithooks #1}}
\newtoks\@nithooks

%: `\addtoeveryparhooks` is for the start of every paragraph
\def\addtoeveryparhooks#1{\x@\global\x@\@veryparhooks\x@{\the\@veryparhooks #1}}
\newtoks\@veryparhooks

%: `\addtoparstylehooks` is for stuff to do at each new parstyle marker
\def\addtoparstylehooks#1{\x@\global\x@\p@rstylehooks\x@{\the\p@rstylehooks #1}}
\newtoks\p@rstylehooks
%-c_define-hooks

%+c_timestamp
% initialize a \timestamp macro for the cropmarks etc to use
\edef\timestamp{\number\year.% print the date and time of the run
  \ifnum\month<10 0\fi \number\month.%
  \ifnum\day<10 0\fi \number\day\space :: }%
\count255=\time \divide\count255 by 60
\edef\hrsmins{\ifnum\count255<10 0\fi \number\count255:}%
\multiply\count255 by 60 \advance\count255 by -\time
\count255=-\count255
\edef\hrsmins{\hrsmins
  \ifnum\count255<10 0\fi \number\count255}%
\edef\timestamp{\timestamp \hrsmins}
%-c_timestamp

%+c_imports
\input ptx-diglot.tex
\input ptx-tracing.tex
\input ptx-para-style.tex
\input ptx-char-style.tex
\input ptx-milestone-style.tex
\input ptx-note-style.tex
\input ptx-stylesheet.tex % must come after the ptx-*-style.tex macros
\input ptx-attribute.tex %Must come after ptx-stylesheet
\input ptx-references.tex
\input ptx-cropmarks.tex
\input ptx-toc.tex
\input ptx-tables.tex
\input ptx-triggers.tex % must come before adj-list and pic-list
\input ptx-adj-list.tex % must come after ptx-stylesheet.tex
\input ptx-pic-list.tex % must come after ptx-stylesheet.tex
\input ptx-cutouts.tex
\input ptx-callers.tex % must come after ptx-note-style.tex
\input ptx-figure.tex % figure-handling
% Additional modules that are not part of the normal ptx2pdf module
\input ptxplus-character-kerning.tex
% We want to import this module here, but it has to come after the stylesheet is loaded.
%\input ptxplus-marginalverses.tex
\input ptx-extended.tex % \esb and friends.
%-c_imports

%+c_fonts-basic
% default font names (override in setup file)
\ifx\regular\undefined   \def\regular{"Times New Roman"}      \fi
\ifx\bold\undefined      \def\bold{"Times New Roman/B"}       \fi
\ifx\italic\undefined    \def\italic{"Times New Roman/I"}     \fi
\ifx\bolditalic\undefined\def\bolditalic{"Times New Roman/BI"}\fi
%-c_fonts-basic

%+c_makenote
% footnote macros based on plain.tex \footnote, \vfootnote
\newbox\he@dingnotes
%:
% #1 ~ class to store the note in. E.g. f, x. The results of `\NoteBlendInto`.
% #2 ~ class to use for styling (what the source had in it)
% #3 ~ styled text for main text caller
% #4 ~ styled text for in note caller
\def\m@kenote#1#2#3#4{\let\@sf\empty
  % text is read later
  \ifhmode\edef\@sf{\spacefactor\the\spacefactor}\/\fi%
  % if footnote is on a chapter number ...
  \ifinextended #3\edef\@wrap{\global\setbox\sid@barnotes=\vbox\bgroup\unvbox\sid@barnotes}\else
    \ifhe@dings #3\edef\@wrap{\global\setbox\he@dingnotes=\vbox\bgroup\unvbox\he@dingnotes}%
    \else\edef\@wrap{}%
      \ifch@pter \everypar={}\ch@pterfalse%
        \global\setbox\ch@pternote=\hbox{\box\ch@pternote #3}%
      \else #3\fi % output caller
    \fi
  \fi%
  % @sf preserves the space factor (e.g. extra space after a period), restore it now
  \@sf \@wrap\vm@kenote{#1}{#2}{\getp@ram{notecallerstyle}{#2}\ifx\p@ram\relax #3\else #4\fi}}
%-c_makenote

%+c_vmakenote
\newtoks\d@note
\def\vm@kenote#1#2#3{%
  \inn@tetrue%
  \let\next\relax%
  \def\n@tetype{#1\g@tndstat}%
  \TRACE{vm@kenote \n@tetype}%
  \x@\let\x@\th@sins\csname note-no-insert-\n@tetype\endcsname
  \checkp@ranotes{#1}% check whether this note class is to be paragraphed 
  \ifx\th@sins\relax
    \n@tewidth=\ifp@ranotes\maxdimen\else\textwidth \advance\n@tewidth by -\columnshift\fi % insert penalties to control breaking of footnotes
    \d@note{\x@\insert\csname note-\n@tetype\endcsname}%
  \else
    \n@tewidth=\ifp@ranotes\maxdimen\else\hsize\fi
    \d@note{\th@sins}%
  \fi%
  \trace{f}{Footnote (\n@tetype) will be \the\n@tewidth wide (page is \the\hsize)}%
  \the\d@note\bgroup% insert note-f (or note-x)
    \XeTeXuseglyphmetrics=3 % so that notes sit on the baseline based on content and not font descender
    \hsize=\n@tewidth
%%% single-column notes:
    \interlinepenalty\interfootnotelinepenalty % set penalty to break lines
    \floatingpenalty\@MM % make sure note does not float away from caller to another page
    \leftskip\z@skip \rightskip\z@skip \spaceskip\z@skip \xspaceskip\z@skip % reset extra space around paragraph 0
    \ifx\th@sins\relax
      \s@tbaseline{#1}%
    \else
      \ifp@ranotes
        \baselineskip=0pt\lineskiplimit=0pt
      \else
        \s@tbaseline{#1}%
      \fi
    \fi
    \ifp@ranotes\else
      \getp@ram{spacebefore}{#1}\trace{f}{note(#1) spacebefore: \p@ram}\ifx\p@ram\relax\else\kern\p@ram\verticalsp@ceunit\fi
      \setbox0=\hbox{\XeTeXuseglyphmetrics=0 \char32}\dimen0=\ht0
      \ifdim\dimen0<\baselineskip
        \dimen1=\baselineskip\advance\dimen1 by -\dimen0
        \vskip\dimen1
		\trace{f}{\reference : Footnote vskip=\the\dimen1 baselineskip=\the\baselineskip strut height=\the\dimen0}%
	  \fi\fi
  \leavevmode % begin paragraph
  \ifdiglot \x@\the\csname diglot\c@rrdstat ho@ks\endcsname \fi%
  \ifRTL\setbox2=\lastbox\beginR\box2\fi % if RTL text this paragraph needs to be RTL
  % if note omitting caller from note (i.e. all callers are *'s)
  \testomitc@ller{#2}\ifomitc@ller\else
    % save copy of caller in temporary box, if non-empty add a little space
    \setbox0=\hbox{#3}%
    \ifdim\wd0>0pt\ifdim\wd0<\NoteCallerWidth% Allow for wide callers, but standardise normal callers to \NoteCallerWidth, for better alignment
      \setbox0=\hbox{\hbox to \NoteCallerWidth{\hfil\box0\hfil}}%
    \fi\fi
    \setbox1=\copy0\unhbox1\ifdim\wd0>0pt\kern.2em\fi
  \fi
  % currently we do not allow footnotes to break to the next page, so this may not be necessary
%  \splittopskip\ht\f@@tstrut % top baseline for broken footnotes
%  \splitmaxdepth\dp\f@@tstrut
  \mcpush{N+#2}%
  %\getp@ram{fontsize}{#2}\edef\c@rrfontsize{\ifx\p@ram\relax12\else\p@ram\fi}%
  \s@tfont{#2}%
  \futurelet\next\fo@t}% use plain.tex footnote processor
%-c_vmakenote

%+c_endnotes

\def\NoteAtEnd#1{%Treat the specified note as an end-note.
        \x@\newb@x\csname endn@te-#1\endcsname
        \x@\gdef\csname addt@endnote-#1\endcsname{%thanks to afterassignment, this gets put immediately after the start of the vbox
          \checkp@ranotes{#1}%
          \ifp@ranotes
            \hsize=\maxdimen
            \x@\ifvoid \csname endn@te-#1\endcsname\else
              %\x@\showbox\csname endn@te-#1\endcsname
              \vbox{}%Sacrificial box for makehboxofhboxes to consume
              \x@\unvbox\csname endn@te-#1\endcsname\makehboxofhboxes%
              %\showbox0
              \setbox0=\hbox{\unhbox0 \removehboxes}%
              \unhbox0 %
            \fi
          \else
            \x@\ifvoid \csname endn@te-#1\endcsname
              \hbox{}%Empty hbox to force some baselineskip at the top of the box
            \else
              %\x@\showbox\csname endn@te-#1\endcsname
              \unvbox\csname endn@te-#1\endcsname
            \fi
          \fi
          }%
        \x@\gdef\csname note-no-insert-#1\endcsname{\x@\afterassignment\csname addt@endnote-#1\endcsname\global\setbox\csname endn@te-#1\endcsname\vbox}%
        \x@\gdef\csname zplacenotes-#1\endcsname{% Set the @ndnotesfound flag based on one type of note. 
            \ifvoid\csname endn@te-#1\endcsname\@ndnotesfoundfalse\else\@ndnotesfoundtrue\fi}%
        \x@\gdef\csname zplacenotes-#1\endcsname{\ifvmode\else\par\fi \dimen0=\prevdepth %
          %\showbox\csname endn@te-#1\endcsname
          \checkp@ranotes{#1}%
          \ifp@ranotes
            \ifdim \dimen0>0pt\kern-\dimen0\fi
            \ifvoid\csname endn@te-#1\endcsname\else
              \maken@tepara{\csname endn@te-#1\endcsname}{#1}%
            \fi
          \else 
            \s@tbaseline{#1}%
            {%\x@\showbox\csname endn@te-#1\endcsname
            \setbox0=\vbox{\unvbox\csname endn@te-#1\endcsname}%
            %\showbox0
            \unvbox0}%
          \fi
          }% Individual note placement
        \x@\endn@teclasses\x@{\the\endn@teclasses \\{#1}}%
        \x@\plac@ndnotes\x@{\the\plac@ndnotes\csname zplacenotes-#1\endcsname}%
}
\let\newb@x=\newbox
\let\newc@unt=\newcount
\let\newdim@n=\newdimen
\newtoks\endn@teclasses
\newtoks\plac@ndnotes
\newif\if@ndnotesfound
\plac@ndnotes{\ifhmode\endgraf\fi\endn@terule} % Pre-fill the toklist
\def\ch@ckendnotes#1{\x@\ifvoid\csname endn@te-#1\endcsname\else\@ndnotesfoundtrue\fi}
\def\zplaceallnotes{\the\plac@ndnotes}

\newif\ifnotesEachBook
\notesEachBooktrue
\NoteAtEnd{fe}

%-c_endnotes

% use \OmitCallerInNote{f} to omit callers from the note at foot of page
% but leave them in the body text (e.g. all the callers are *'s)
\def\OmitCallerInNote#1{%
  \expandafter\let\csname omit-in-note #1\endcsname=1}
%
\def\testomitc@ller#1{\expandafter\ifx\csname omit-in-note #1\endcsname\relax
  \omitc@llerfalse \else \omitc@llertrue \fi}
\newif\ifomitc@ller

% create a "strut" (see TeXbook) of suitable size for the note style
\def\footstrut{\s@tfont{\newn@testyle}%
  \s@tbaseline{\newn@testyle}%
  \setbox\f@@tstrut=\hbox to 0pt{\XeTeXuseglyphmetrics=0 \char32 \hss}%
  \dimen0=\ht\f@@tstrut \dimen2=\dp\f@@tstrut
  \dimen4=\dimen0 \advance\dimen4 by \dimen2
%  \ifdim\dimen4<\baselineskip
    \dimen6=100\baselineskip \divide\dimen6 by \dimen4
    \multiply\dimen0 by \dimen6 \divide\dimen0 by 100
    \multiply\dimen2 by \dimen6 \divide\dimen2 by 100
%  \fi
  \setbox\f@@tstrut=\hbox{}\ht\f@@tstrut=\dimen0 \dp\f@@tstrut=\dimen2
  \copy\f@@tstrut}

%+c_foot
% called at end of note
\def\@foot{\ifp@ranotes \parfillskip=0pt \else\strut\fi
  \par
  \ifp@ranotes\else\getp@ram{spaceafter}{\n@tetype}\trace{f}{note(\n@tetype) spaceafter: \p@ram}%
  \ifx\p@ram\relax\else\vskip\p@ram\verticalsp@ceunit\fi\fi
  \egroup\ifdiglot\ifRTL\endR\fi\fi\end@llpoppedstyles{N*}%
  \def\d@##1+##2\E{\if ##1N\else\MSG{Bad marker ##2\space but expected a closing note marker}\fi}\mctopnoms
  \mcpop}
\newbox\f@@tstrut
\def\n@teglue{2em plus 1em minus .5em\relax} % glue to be used between paragraphed notes
%-c_foot

% set baseline appropriately for the given style (may be using much smaller font than body)
% baselineskip = leading
\def\s@tbaseline#1{%
  \trace{F}{s@tbaseline #1 \c@rrdstat}%
  \def\s@urce{no data}%
  \def\f@ntstyle{#1\c@rrdstat}%
  \getp@ram{baseline}{#1}\ifx\p@ram\relax
    \getp@ram{fontsize}{#1}\ifx\p@ram\relax\else
      \def\s@urce{calcn:\f@ntstyle}%
      \dimen0=\p@ram\le@dingunit
      \multiply\dimen0 by \LineSpaceBase \divide\dimen0 by 12 % default .75 shift of .85ex (ex=.5 fontsize) against 14/12
      \trace{F}{baseline [\f@ntstyle] = \the\dimen0 = \p@ram * \the\le@dingunit  * \LineSpaceBase / 12}%
      \setp@ram{baseline}{\f@ntstyle}{\the\dimen0}\baselineskip=\dimen0
      \should@xist{\f@ntstyle}%
     \fi
    \else
    \def\s@urce{store:\f@ntstyle}%
    \baselineskip=\p@ram\fi
  \trace{j}{set baselineskip=\the\baselineskip (\s@urce)}}

\def\ins@rtn@tecl@ss#1{% insert the given note class, either paragraphed or separately
  \iff@rstnote\setn@tewidth{#1}\fi % set appropriate hsize width for diglot or not.
  \checkp@ranotes{#1}\ifp@ranotes\let\n@xt=\parains@rtn@tecl@ss
    \else\let\n@xt=\separateins@rtn@tecl@ss\fi
  \n@xt{#1}}

% insert a note class in which each note is on its own line
\def\separateins@rtn@tecl@ss#1{%
  \def\cl@ss{#1\g@tndstat}%
  \TRACE{seperateins@rtn@tecl@ss \cl@ss}%
  \x@\let\x@\th@cl@ss\csname note-\cl@ss\endcsname % make \th@cl@ss be a synonym for the current note class
  % if the noteclass has content to output ...
  \ifvoid\th@cl@ss\TRACE{no note}\else%
    \iff@rstnote\ifvoid\verybottomins\vfil\fi\fi % ignore depth of body text; fill space
    \kern\AboveNoteSpace % output above note class space
    \iff@rstnote\kern-\dp\pstr@t \footnoterule\global\f@rstnotefalse\fi % output rule before first note
    \hbox{\hskip\columnshift \vbox{\unvbox\th@cl@ss}}\fi}% output notes

% insert a note class in which each note is in the same paragraph
\def\parains@rtn@tecl@ss#1{%
  \def\cl@ss{#1\g@tndstat}%
  \x@\let\x@\th@cl@ss\csname note-\cl@ss\endcsname % make \th@cl@ss be a synonym for the current note class
  % if the noteclass has content to output ...
  \ifvoid\th@cl@ss\else
    \iff@rstnote\ifvoid\verybottomins\vfil\fi %\kern-\lastd@pth\vfil % ignore depth of body text; fill space
      \dimen5=\AboveNoteSpace\advance\dimen5 by -\BelowNoteRuleSpace\advance\dimen5 by -0.2pt
      \vskip\ifdim\dimen5>0pt \AboveNoteSpace minus \dimen5\else\AboveNoteSpace\fi
      %\kern-\dp\pstr@t
      {\footnoterule}\global\f@rstnotefalse % output rule before first note
    \else\vskip\InterNoteSpace\fi
    {\maken@tepara{\th@cl@ss}{#1}}%
  \fi}

\def\BelowNoteRuleSpace{0.5\AboveNoteSpace}
\newif\iff@rstnote
\f@rstnotetrue
\def\footnoterule{\kern-\BelowNoteRuleSpace
  \setn@tewidth{-}%
  \dimen0=\n@tewidth
  \ifdiglot\else
     \advance\dimen0 by -\columnshift %handled differently in diglot
  \fi
  \toks0=\everypar\everypar={}\parskip=0pt\baselineskip=0pt\parindent=0pt\let\par=\endgraf\parfillskip=0pt%
%  \noindent\hbox{\noindent\kern\columnshift\vbox{\hrule width \dimen0}}\par
  \hbox{\ifdiglot\else\kern\columnshift\fi
    \vrule height 0.4pt width \dimen0}\kern-.4pt % the \hrule is .4pt high
    \vskip\BelowNoteRuleSpace minus \BelowNoteRuleSpace
\everypar=\toks0}

\def\EndNoteRuleWidth{0.5}
\def\EndNoteRuleThickness{0.4}
\def\AboveEndNoteRule{1.2}
\def\BelowEndNoteRule{0.8}

\def\endn@terule{\relax
  \@ndnotesfoundfalse
  \let\\=\ch@ckendnotes\the\endn@teclasses
  \if@ndnotesfound\zendnoterule\fi
}
\def\EndNoteSeparator{\hbox to \hsize{\hss\vrule width \EndNoteRuleWidth\hsize  height \EndNoteRuleThickness pt\hss}%
      \kern-\EndNoteRuleThickness pt %
} 
\def\zendnoterule{{%
    \toks0=\everypar\everypar={}\parskip=0pt\parindent=0pt\let\par=\endgraf\parfillskip=0pt%
%  \noindent\hbox{\noindent\kern\columnshift\vbox{\hrule width \dimen0}}\par
    \dimen0=\prevdepth\ifdim \dimen0>0pt\kern-\dimen0\fi
    \vbox{\kern \AboveEndNoteRule\baselineskip
      \EndNoteSeparator
      \kern \BelowEndNoteRule\baselineskip}%
    \everypar=\toks0 
  }%
  \penalty 5000 %Not a good place to break. Also protects from unboxing
}

\def\zpostendnoterule{\if@ndnotesfound{%
    \toks0=\everypar\everypar={}\parskip=0pt\parindent=0pt\let\par=\endgraf\parfillskip=0pt%
%  \noindent\hbox{\noindent\kern\columnshift\vbox{\hrule width \dimen0}}\par
    \par
    \dimen0=\prevdepth\ifdim \dimen0>0pt\kern-\dimen0\fi
    \vbox{\kern 0.5\baselineskip
      \EndNoteSeparator
      \kern 0.5\baselineskip}%
    \everypar=\toks0 
  }\fi%
}

% determine if a given note class is to be paragraphed
%+c_paragraphedNotes
\def\ParagraphedNotes#1{\Par@gr@phedNotes{#1\g@tndstat}}
\def\Par@gr@phedNotes#1{\TRACE{Par@gr@phedNotes #1}\x@\let\csname paranotes-#1\endcsname=1}
\newif\ifp@ranotes
\def\checkp@ranotes#1{\x@\ifx\csname paranotes-#1\endcsname\relax
  \p@ranotesfalse\else\p@ranotestrue\fi}
%-c_paragraphedNotes

% Notewidth for diglots depends on settings and column. 
%+c_setnotewidth
\newdimen\n@tewidth
\def\setn@tewidth#1{%
  \trace{f}{setn@tewidth}%
  \x@\let\x@\th@sins\csname note-no-insert-#1\endcsname
  \ifx\th@sins\relax % Normal footnote
   \ifdiglot
     \trace{d}{setn@tewidth (\show@dstat)}%
     \ifdiglotSepNotes
        \ifnum 1=\ifx\c@rrdstat\empty 0\else \ifcsname column\c@rrdstat width\endcsname 1 \else 0\fi\fi
          \n@tewidth=\csname column\c@rrdstat width\endcsname
        \else
          \trace{d}{c@rrdstat currently set to '\c@rrdstat'.  No column width}%
          \n@tewidth=\csname columnLwidth\endcsname
        \fi
     \else\n@tewidth=\textwidth\fi
   \else\n@tewidth=\textwidth\fi
  \else
    %Assume that the note will be inserted using the current text width.
    \ifnum\c@rrentcols=1
      \n@tewidth=\textwidth
    \else
      \n@tewidth=\colwidth
    \fi
    %\advance\n@tewidth by -\columnshift
  \fi
  \trace{f}{end-setn@tewidth: \the\n@tewidth}%
}
%-c_setnotewidth

% reformat the contents of a note class insertion into a single paragraph.
% this is usually done for \x. It is sometimes done for \f.
% (based on code from the TeXbook, appendix D)
% #1 is vbox containing notes as individual paragraphs.
%+c_makenotepara
\newif\ifNoteTracing \NoteTracingfalse
\newskip\internoteskip \internoteskip=15pt plus 12pt minus 7pt
\newskip\noteRag\noteRag=0pt plus 36pt
\def\maken@tepara#1#2{%
  \setn@tewidth{#2}%
  \hsize=\n@tewidth%\advance\hsize by -\columnshift % width is full page size
  \let\par=\endgraf\ch@pterfalse
  \everypar={}% don't do body text formatting
  \unvbox#1 % open up the vbox of notes to get at the list of individual note boxes
  \makehboxofhboxes % make a single hbox for all notes of this class
  \setbox0=\hbox{\unhbox0 \removehboxes}% add internote space                   %(1)
  \trace{j}{maken@tepara #2 \c@rrdstat: baseline was \the\baselineskip}%
  %\getp@ram{baseline}{#2}\ifx\p@ram\relax\else\baselineskip=\p@ram\fi
  \s@tbaseline{#2}%
% Enable justification according to marker.
  \trace{j}{maken@tepara #2 \c@rrdstat: baseline now \the\baselineskip}%
  \lineskiplimit=-10pt\leftskip=0pt\rightskip=0pt\parskip=0pt\parfillskip=0pt plus 1fil%\lineskip=10pt
  \getp@ram{justification}{#2}%
  \ifx\p@ram\c@nter
     \leftskip=\noteRag\rightskip=\noteRag
  \else\ifx\p@ram\l@ft
     \rightskip=\noteRag
  \else\ifx\p@ram\r@ght
     \leftskip=\noteRag
  \fi\fi\fi
  \ifdiglot\else
    \advance\leftskip by \columnshift%
  \fi
  %\showbox0
  \edef\@seglyphmetrics{\the\XeTeXuseglyphmetrics}%
  \XeTeXuseglyphmetrics=3
  \noindent % starting making new paragraph
  \ifRTL\beginR\fi % respect directionality
  \ifNoteTracing\tracingparagraphs=1\fi
  \unhbox0 % unbox the text so it can be line-wrapped
  \unskip\unpenalty\unskip\unskip % remove internote skip info after last note
  % set penalty which allows breaking between notes unless this would cause
  % an extra line to be created.
  \linepenalty50
  \trace{f}{Note #2 baselineskip=\the\baselineskip, useglyphmetrics=\the\XeTeXuseglyphmetrics}%
  \par\leftskip=0pt\XeTeXuseglyphmetrics=\@seglyphmetrics\ifNoteTracing\tracingparagraphs=0\fi}
%-c_makenotepara
% make box0 = an hbox contining all the contents of this class
%+c_makehboxofhboxes
\def\makehboxofhboxes{%
  \setbox0=\hbox{}%
  \loop\setbox2=\lastbox \ifhbox2\setbox0=\hbox{\box2\unhbox0}\repeat} 
%
% remove inside level of boxing and adding inter note space after each
%     [[a][b][c]] --> [a \internotespace b \internotespace c \internotespace]
\def\removehboxes{%
  \setbox0=\lastbox 
  \ifhbox0{\removehboxes}\unhbox0\internotespace\fi}
%
% skip between notes in paragraph. skip is good place to break.
\def\internotepenalty{-10}
%\def\internotespace{\hfil\hskip\intern@teskip\penalty\internotepenalty\hfilneg}
\def\internotespace{\penalty\internotepenalty\hskip\internoteskip}%\kern 0pt after \hskip, to force gap
%\def\internotespace{\hfil\hskip\intern@teskip\penalty-10\hfilneg}
%-c_makehboxofhboxes

% don't allow stretching between notes.

%%%%%%%%%%%%%% OUTPUT ROUTINES %%%%%%%%%%%%%% 
% default output routine is single-column, somewhat based on Plain TeX output routine (see TeXbook)
%+c_onecol
\global\output={\onecol}
\global\holdinginserts=1
\def\onecol{%
  \global\setbox\galley=\copy255                                        %(1)
  \trace{b}{BALANCE pagebuild: cols=1: textheight=\the\textheight\space with ht=\the\ht255 \space and partial=\the\ht\partial}%
  % tempoarily split and see if there are marks in this text
  \bgroup\setbox0=\copy255 \setbox1=\vsplit0 to \maxdimen\egroup        %(+)
  \edef\t@mp{\splitbotmark}%
  \ifx\t@mp\empty\else\global\m@rksonpagetrue\trace{H}{Found mark \splitbotmark}\fi
  \global\galleypenalty=\outputpenalty                                  %(+)
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \global\output={\onecoltrial}%
  % No marks on the page, and it didn't fit, so add a blank mark
  \ifm@rksonpage\else\gdef\p@gefirstmark{}\trace{H}{No marks found. Setting empty mark}\fi
  \global\holdinginserts=0
  \unvbox255
  \penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi         %(+)
}
%-c_onecol
%+c_onecoltrial_intro
\def\onecoltrial{% single-column version of \twocoltrial (see below)
  \tracingparagraphs=0
  %\tracingall=1\tracingoutput=0\tracingpages=0\tracingparagraphs=0\tracingassigns=0\tracingscantokens=0
  \trace{i}{1c TRIAL with ht=\the\trialheight, vsize=\the\vsize, hIns=\the\holdinginserts}%
  \c@lcavailht
  %\xdef\p@gebotmark{\botmark}% remember last \mark for running header
  %\xdef\t@st{\p@gefirstmark}%
  %\ifx\t@st\empty\xdef\p@gefirstmark{\firstmark}\fi % remember first, if not already set
  %\availht=\trialheight % amount of space we think is available             %(1)
  %\f@rstnotetrue
  %\let\\=\reduceavailht \the\n@tecl@sses % reduce it by the space needed for each note class
  %\decr{\availht}{\topins}% and by the space needed for spanning pictures
  %\decr{\availht}{\bottomins}%And post-footnote inserts
  %\decr{\availht}{\verybottomins}%
  \setbox\s@vedpage=\copy255
  % split the galley to the actual size available
  \setbox\colA=\vsplit255 to \availht \setbox0\copy\colA \setbox0=\vbox{\unvbox0}
  \decr{\availht}{0}
  \ifdim\availht<0pt                                                        %(2)
    \MSG{Page overfull with inserts. Perhaps a little more text and less pictures would help}%
  \fi
  %\setbox\colA=\vbox{\unvbox\colA}
  % and check if it all fit; if not, we'll have to back up and try again
  \ifvoid255 \fitonpagetrue \else \fitonpagefalse \fi
%-c_onecoltrial_intro
%+c_onecoltrial_pagecontents
  \iffitonpage
    \trace{i}{1 SUCCEEDED, shipping page hIns=\the\holdinginserts}%
% at this point:
%   \box\colA is the page content
%   \availht is ht that definitely works
    \def\pagecontents{%                                                     %(3)
%      \msg{upwards mode = \the\XeTeXupwardsmode}
      \dimen1=\textwidth \advance\dimen1 -\ExtraRMargin
      \trace{b}{BALANCE pageoutins: cols=1: text=\the\ht\colA, \the\dp\colA: partial=\the\ht\partial, \the\dp\partial: topins=\the\ht\topins: bottomins=\the\ht\bottomins}%
      \dimen9=\ht\partial
      \ifvoid\partial\else \vbox{\hbox to \dimen1{\hskip\columnshift\vbox{\unvbox\partial}}} \fi
      \ifvoid\topins\else \vbox{\hbox to \columnshift{}\box\topins} \vskip\skip\topins \fi
      \iflastpage\setbox\colA\vbox{\unvbox\colA}\fi
      \lastd@pth=\dp\colA
      \hbox to \dimen1{\hbox to \columnshift{}%
        \box\colA\hbox to \ExtraRMargin{}\hfil}%
      \ifvoid\bottomins\else \vfil\kern-\lastd@pth
        \lastd@pth=0pt \vskip\skip\bottomins \hbox{\hbox to \columnshift{}\box\bottomins} \fi % ouput bottom spanning pictures
      \f@rstnotetrue%
      \m@kenotebox
      \trace{b}{BALANCE pageouttxt: notes=\the\ht2 , \the\dp2 \space Leaving \the\ht255, \the\dp255}%
      \ifdim\ht2<-\lastd@pth\trace{b}{Strange notes height: \the\ht2}\fi
      \unvbox2 %\kern-\lastd@pth\lastdepth=\dp2\unvbox2
      \ifvoid\verybottomins\else\ifdim\availht > 0pt\vfil % \kern-\dimen0
        \trace{o}{verybottomins(onecoltrial): height=\the\ht\verybottomins , availht=\the\availht, textheight=\the\textheight, htpartial=\the\dimen9}
        \lastd@pth=0pt \vskip\skip\verybottomins \hbox{\hbox to \columnshift{}\vbox{\unvbox\verybottomins}}\fi\fi
    }%
%-c_onecoltrial_pagecontents
%+c_onecoltrial_pagefit
    \resetvsize
    \ifdim\ht\colA>\baselineskip\plainoutput\trace{p}{plainoutput from onecoltrial}%    %(+)
      \s@tpage
    \else\setbox0=\box255\deadcycles=0\fi % dump empty pages (typically at end)
    \fin@lverybottom
    \global\holdinginserts=1
    \ifrerunsavepartialpaged\trace{o}{onecoltrial: rerunsavepartialpage}%
      \global\output={\savepartialpage}% leave flag set to allow caller to trigger extra \eject   %(+)
    \else\global\output={\onecol}\fi
    \global\setbox255=\box\voidb@x
%-c_onecoltrial_pagefit
%+c_onecoltrial_fail
  \else % the contents of the "galley" didn't fit into the actual page,
        % so reduce \vsize and try again with an earlier break
    \trace{i}{1c REDUCING VSIZE hIns=\the\holdinginserts}%
    \global\advance\vsize by -\baselineskip
    \trace{b}{BALANCE 1col go round vsize=\the\vsize}%
    \res@tpage
    \global\let\whichtrial=\onecoltrial
    \global\output={\backingup}%
    \unvbox\galley \penalty\ifnum\galleypenalty=10000 0 \else \galleypenalty \fi
  \fi
}
%-c_onecoltrial_fail

%+c_pagebody
\def\pagebody{\vbox to\textheight{\boxmaxdepth\maxdepth \pagecontents}}
\def\makeheadline{%
  \g@tfontname{h}%
  \vbox to 0pt{\kern-\topm@rgin
   \vbox{\kern\HeaderPosition\MarginUnit
    \setbox0=\vbox{\hbox to \textwidth{\the\headline}}%
    \ht0=0.7\fontdimen6\csname font<\f@ntstyle>\endcsname \dp0=0pt \box0
    \ifrhr@le\ifdim\RHruleposition=\maxdimen\else
      \kern\RHruleposition \hrule
    \fi\fi}\vss}\nointerlineskip}
\newif\ifrhr@le
\def\makefootline{%
  \vbox to 0pt{\dimen0=\textwidth\advance\dimen0 by -\columnshift
    \kern\bottomm@rgin
    \kern-\FooterPosition\MarginUnit
     \hbox to \textwidth{\the\footline}\vss}}
\newdimen\RHruleposition \RHruleposition=\maxdimen
%-c_pagebody

%+c_doublecolumns
\def\PageFullFactor{0.9}
\def\doublecolumns{
  \ifnum\c@rrentcols=1
    % make switch from single to double column
    \vskip-\lastdepth
    \ifhe@dings\endhe@dings\fi % if headings in process, end headings
    \penalty-100\vskip\baselineskip % ensure blank line between single and double column material
    \global\output={\savepartialpage}\eject
    \ifrerunsavepartialpaged\eject\rerunsavepartialpagedfalse\fi % save any partially-full page
	% if single column material already fills 3/4 page, go to next page to start double columns
    \dimen0=\ht\partial
    \trace{o}{DoubleColumns: \the\dimen0\space > \PageFullFactor\space * \the\textheight}%
    \ifdim\dimen0>\PageFullFactor\textheight
%%%      \msg{Output full page from 1 to 2 columns}%
      \global\output={\onecol} % but output it immediately if 75% full
      \loop\ifdim\dimen0>\textheight\advance\dimen0-\textheight\repeat
      %\vbox{\hskip-\columnshift\box\partial}
      \unvbox\partial
      \ifdim\dimen0>\PageFullFactor\textheight\vfill\eject
        \else\global\output={\savepartialpage}\eject
      \fi
    \else
      %\hsize=\textwidth
      %\setbox\partial=\vbox{\hskip\columnshift\box\partial}
    \fi
    % reset parameters for 2-column formatting
    \global\hsize=\colwidth\trace{o}{doublecolumn vsize doubles}%
    \global\vsize=2\textheight % in 2 col mode you can put twice the height of text
	\global\advance\vsize by -2\ht\partial % subtract height of 1 column material
	\global\advance\vsize by 2\baselineskip % don't get caught short by 1/2 line or so
	% make a macro reset vsize for remaining pages which do not have 1 column material
    \trace{o}{Going to 2 col, textheight \the\textheight - \the\ht\partial}%
    \gdef\resetvsize{\trace{o}{resetvsize2}\global\vsize=2\textheight \global\advance\vsize by \baselineskip} 
    \global\output={\twocols}%
    \global\c@rrentcols=2
    % top and bottom inserts effectively use twice their height
	% (\count of an insertion class is a scaling factor)
    \count255=2000
    \global\count\topins=\count255
    \global\count\bottomins=\count255
    \global\count\verybottomins=\count255
    \let\\=\s@tn@tec@unt \the\n@tecl@sses % reset \count for each note class
    \global\holdinginserts=1 % don't pull out inserts yet, we are still adjusting page
    %\msg{Starting 2col partial: \the\ht\partial, pagetotal: \the\pagetotal, vsize: \the\vsize}
  \fi}
%-c_doublecolumns

%+c_setnotecount
% iterate over note classes, set \count for each class  
\def\s@tn@tec@unt#1{%
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname
  \checkp@ranotes{#1}%
  % notes made into paragraphs (e.g. \x) are counted as 0 height for now,
  % later we will backup making page size smaller until things fit
  % Diglot prefers to get things closer 1st time round...
  %\global\count\th@cl@ss=\ifp@ranotes \ifdiglot 500\else 0\fi \else 0\fi %\count255 \fi
  \global\count\th@cl@ss=\ifdiglot 100\else 0\fi
  \global\skip\th@cl@ss=\AboveNoteSpace }
%-c_setnotecount

%+c_resetvsize
\def\resetvsize{\trace{o}{resetvsize}\global\vsize=\textheight} 
%-c_resetvsize

\def\msg#1{\immediate\write16{#1}}

%+c_savepartialpage
\def\savepartialpage{% save a partially-full page when switching to 2-column format,
  \xdef\p@gebotmark{\botmark}%
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \c@lcavailht
  \setbox\s@vedpage=\copy255
  % split the galley to the actual size available
  \setbox\colA=\vsplit255 to \availht
  \setbox\colA=\vbox{\unvbox\colA}%
  % and check if it all fit; if not, we'll have to back up and try again
  \ifvoid255 \fitonpagetrue \else \fitonpagefalse \fi
  \trace{o}{savepartialpage \the\ht\colA rem=\the\ht255}%
  \iffitonpage
    \global\setbox\partial=\vbox{
      \ifvoid\partial\else \unvbox\partial \fi
      \ifvoid\topins\else \unvbox\topins \vskip\skip\topins \fi
      \lastd@pth=\dp\colA
      \dimen1=\textwidth \advance\dimen1 -\ExtraRMargin \advance\dimen1 -\columnshift
      \hbox to \dimen1{%\hbox to \columnshift{}%
        \box\colA\hbox to \ExtraRMargin{}\hfil}%
      \ifvoid\bottomins\else%
        \kern-\lastd@pth \lastd@pth=0pt \vskip\skip\bottomins \unvbox\bottomins \fi
      \f@rstnotetrue
      \m@kenotebox
      \trace{b}{BALANCE pageouttxt: notes=\the\ht2 , \the\dp2}%
      \unvbox2 %\kern-\lastd@pth\lastdepth=\dp2\unvbox2
      \ifvoid\verybottomins\else\ifdim\availht > 0pt%
        \trace{o}{verybottomins(savepartialpage): height=\the\ht\verybottomins , availht=\the\availht, textheight=\the\textheight}
        \kern-\lastd@pth \lastd@pth=0pt \vskip\skip\verybottomins \unvbox\verybottomins \fi\fi
    }%
    \resetvsize%
    \ifdim\ht\colA>\baselineskip\plainoutput\fin@lverybottom
      \s@tpage
    \else\trace{o}{Page empty cols=\the\ht\colA, \the\ht\colB, partial=\the\ht\partial}\setbox0=\box255\deadcycles=0\fi % dump empty pages (typically at end)
    \tempfalse%
    \ifdim\ht\partial>\PageFullFactor\textheight \temptrue\fi%
    \ifnum\outputpenalty<-10000 \temptrue\fi%
    \iftemp\def\pagecontents{\box\partial}\plainoutput 
      \s@tpage
    \fi
    \fin@lverybottom
    \global\holdinginserts=1
  \else % the contents of the "galley" didn't fit into the actual page,
        % so reduce \vsize and try again with an earlier break
    \trace{i}{2c REDUCING VSIZE hIns=\the\holdinginserts}%
    \res@tpage
    %\global\advance\vsize by -\baselineskip
    \global\let\whichtrial=\onecoltrial
    \global\output={\backingup}%
    \global\rerunsavepartialpagedtrue
    \ifm@rksonpage\else\gdef\p@gefirstmark{}\trace{H}{No marks found. Setting empty mark}\fi%No marks on the page, and it didn't fit, so add a blank mark
    \unvbox\s@vedpage \penalty\ifnum\galleypenalty=10000 0 \else \galleypenalty \fi
  \fi}%
  % save 1 column material since we are switching to 2 columns
\newbox\partial
%-c_savepartialpage

%+c_twocols
\def\twocols{% primary output routine in 2-col mode
  \trace{i}{TWOCOLS @ \ch@pter:\v@rse, txtht=\the\textheight, partial=\the\ht\partial, hIns=\the\holdinginserts}%
  % save copy of current page so we can retry with different heights
  \trace{b}{BALANCE pagebuild: cols=2: textheight=\the\textheight}%
  \global\setbox\galley=\copy255
  \bgroup\setbox0=\copy255 \setbox1=\vsplit0 to \maxdimen\egroup
  \edef\t@mp{\splitbotmark}%
  \ifx\t@mp\empty\else\global\m@rksonpagetrue\trace{H}{Found mark \splitbotmark}\fi
  \global\galleypenalty=\outputpenalty % save current penalty so we can restore it at (A)
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \global\output={\twocoltrial}%
  \global\holdinginserts=0 % when doing trial place insertions into boxes
  \unvbox255 % force invoking \twocoltrial
  \penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi % (A) restore output penalty
  }
\newbox\galley
\newcount\galleypenalty
\newdimen\trialheight
\newdimen\lastd@pth
%-c_twocols

% for measuring the space needed for each class of notes;
% this will decrease \availht by the space needed for the given class
%+c_reduceavailht
\def\reduceavailht#1{%
  \checkp@ranotes{#1}%
  %\TRACE{av: \the\availht =>}
  \ifp@ranotes\let\n@xt=\reduceavailht@para
    \ifdiglot\ifdiglotSepNotes\ifdiglotBalNotes\let\n@xt=\reduceavailht@para@bal\fi\fi\fi
  \else\let\n@xt=\reduceavailht@sep
    \ifdiglot\ifdiglotSepNotes\ifdiglotBalNotes\let\n@xt=\reduceavailht@sep@bal\fi\fi\fi
  \fi
  \iff@rstnote\else\global\noteseentrue\fi\n@xt{#1}}
%-c_reduceavailht

%+c_reduceavailht_para
\def\reduceavailht@para#1{
  \def\cl@sss{#1\g@tndstat}%
  \trace{n}{class \cl@sss}%
  \x@\let\x@\th@cl@ss\csname note-\cl@sss\endcsname
  \ifvoid\th@cl@ss\else
    \setbox0=\copy\th@cl@ss
    \setbox0=\vbox{\maken@tepara{0}{#1}}%
    \advance\availht by -\ht0
    \advance\availht by -\dp0
    \iff@rstnote
      \advance\availht by -\AboveNoteSpace
      \advance\availht by -\BelowNoteRuleSpace
      \f@rstnotefalse
    \else \advance\availht by -\InterNoteSpace\fi
    %\getp@ram{baseline}{#1}\ifx\p@ram\relax\else\advance\availht-\p@ram\fi
  \fi}
%-c_reduceavailht_para

\def\max@boxpara#1{%paragraph notes of type \v@lpfx#1 and find the max height amongst them
  \trace{n}{max@boxpara \v@lpfx\if #1L\else #1\fi}%
  \x@\let\x@\t@st\csname \v@lpfx\if #1L\else #1\fi\endcsname
  \ifvoid\t@st \else
    \setbox0=\copy\t@st
    \let\t@mpdstat\c@rrdstat
    \edef\c@rrdstat{#1}% make sure that maken@tepara can work with the right width
    \setbox0=\vbox{\maken@tepara{0}{\v@lpfx}}%
    \dimen0=\ht0 \advance\dimen0 by \dp0
    \ifdim\dimen1<\dimen0
      \dimen1=\dimen0
    \fi
    \let\c@rrdstat\t@mpdstat %don't forget to restore value
    \trace{n}{\the\dimen0, \the\dimen1}%
  \fi
}

\def\reduceavailht@para@bal#1{%
  \TRACE{reduceavailht@para@bal #1}%
  \bgroup%leave dimen0 etc unchanged
  \dimen0=0pt
  \edef\v@lpfx{note-#1}\edef\v@lsfx{}%
  \let\col@do=\max@boxpara\dimen1=0pt
  \x@\each@col\diglot@list\E % max@boxsz sets dimen1 to max ht+dp
  \ifdim\dimen1>0pt
    \global\advance\availht by -\dimen1
    \iff@rstnote\global\advance\availht by -\AboveNoteSpace \f@rstnotefalse
    \else \global\advance\availht by -\InterNoteSpace\fi
    \trace{n}{reduced by=\the\dimen1}%
  \fi\egroup}

%+c_reduceavailhtsep
\def\reduceavailht@sep#1{
  \def\cl@sss{#1\g@tndstat}%
  \TRACE{class \cl@sss}%
  \x@\let\x@\th@cl@ss\csname note-\cl@sss\endcsname
  \ifvoid\th@cl@ss\else
    \f@rstnotefalse
    \advance\availht by -\ht\th@cl@ss
    \advance\availht by -\dp\th@cl@ss
    \iff@rstnote\advance\availht by -\AboveNoteSpace
     \advance\availht -\dp\pstr@t \f@rstnotefalse % ensure we don't impinge on the depth
    \else \advance\availht by -\InterNoteSpace\fi
    \advance\availht by -\AboveNoteSpace
  \fi}
%-c_reduceavailhtsep

\def\reduceavailht@sep@bal#1{%
  \TRACE{reduceavailht@sep@bal}%
  \edef\v@lpfx{note-#1}\edef\v@lsfx{}%
  \let\col@do=\max@boxszB\dimen1=0pt
  \x@\each@col\diglot@list\E % max@boxsz sets dimen1 to max ht+dp
  \ifdim\dimen1>0pt 
    \advance\availht by -\dimen1
    \iff@rstnote\advance\availht by -\AboveNoteSpace \f@rstnotefalse
      \advance\availht -\dp\pstr@t  % ensure we don't impinge on the depth
    \else \advance\availht by -\InterNoteSpace\fi
  \fi}

%+c_clearnoteclass

\def\cle@rn@tecl@ss#1{%
  \ifdiglot
    \ifdiglotSepNotes
       \diglotcle@rn@tecl@ss{#1}%
    \else\cle@rn@t@cl@ss{#1}\fi
  \else\cle@rn@t@cl@ss{#1}\fi
}

\def\cle@rn@t@cl@ss#1{%
  \trace{n}{cle@rn@t@cl@ss{#1}}%
  \x@\let\x@\th@cl@ss\csname note-#1\endcsname
  \global\setbox\th@cl@ss=\box\voidb@x}

\def\s@venotes#1#2{\trace{nS}{Saving footnotes}\edef\n@tesavelevel{#2}\edef\n@t@sfx{#1}\let\\=\s@ven@te \the\n@tecl@sses}
\def\s@veallnotes#1{%
  \ifdiglot
    \ifdiglotSepNotes
      \let\sncdst@t=\c@rrdstat
      \def\col@do##1{\edef\c@rrdstat{##1}\s@venotes{\g@tndstat}{#1}}%
      \x@\each@col\diglot@list\E
      \let\c@rrdstat\sncdst@t
    \else
      \s@venotes{}{#1}%
    \fi
  \else
    \s@venotes{}{#1}%
  \fi
}
  
\def\r@storenotes#1#2{\trace{nS}{Restoring footnotes}\edef\n@tesavelevel{#2}\edef\n@t@sfx{#1}\let\\=\r@storen@te \the\n@tecl@sses}
\def\tw@{2}
\def\s@ven@te#1{% Level2 save saves to notesave1-X to notesave2-X
  \ifx\tw@\n@tesavelevel
    \x@\let\x@\tmp@note\csname notesave1-#1\n@t@sfx\endcsname
  \else
    \x@\let\x@\tmp@note\csname note-#1\n@t@sfx\endcsname
  \fi
  \x@\let\x@\tmp@save\csname notesave\n@tesavelevel-#1\n@t@sfx\endcsname
  \global\setbox\tmp@save=\copy\tmp@note
  \trace{n}{#1\n@t@sfx(\n@tesavelevel): \the\ht\tmp@save+\the\dp\tmp@save}%
}
\def\r@storen@te#1{% either notesavelevel restores to note-X
  \x@\let\x@\tmp@note\csname note-#1\n@t@sfx\endcsname
  \x@\let\x@\tmp@save\csname notesave\n@tesavelevel-#1\n@t@sfx\endcsname
  \trace{n}{#1\n@t@sfx(\n@tesavelevel): \the\ht\tmp@note+\the\dp\tmp@note -> \the\ht\tmp@save+\the\dp\tmp@save }%
  \global\setbox\tmp@note=\copy\tmp@save
}
%-c_clearnoteclass

% increment or decrement a given \dimen by the height of a given \box, unless void
% round to baselineskip assuming 0.5\baselineskip already added
%+c_incrdecr
\def\incr#1#2{\ifvoid#2\else\advance#1 by \skip#2\advance#1 by \ht#2\fi}
\def\decr#1#2{\ifvoid#2\else\advance#1 by -\skip#2\advance#1 by -\ht#2\fi}
%-c_incrdecr

% allocate some named registers for the \trial routine to use
\newbox\s@vedpage % to save the page contents for re-splitting columns
\newdimen\availht % overall available height
\newdimen\shortavail % shortened version of \availht for re-balancing loop
\newdimen\colhtA \newdimen\colhtB % dimen registers for calculating available ht for each col
\newbox\colA \newbox\colB % box registers to hold contents of the columns
\newcount\loopcount
\newif\ifrem@inder \rem@indertrue
\newif\ifunbalanced \unbalancedfalse% \unbalancedtrue
\newif\ifnoteseen \noteseenfalse% A trigger to help alert user that note might have gone missing
\newif\ifinextended \inextendedfalse % Test for sidebars (ptx extended)

%+c_setcolhts
\def\s@tcolhts#1{
    \colhtA=#1 \decr{\colhtA}{\topleftins}\decr{\colhtA}{\bottomleftins}%
    \colhtB=#1 \decr{\colhtB}{\toprightins}\decr{\colhtB}{\bottomrightins}%
    \trace{o}{s@tcolhts: colhtA=\the\colhtA, colhtB=\the\colhtB, toprightins=(\the\skip\toprightins, \the\ht\toprightins), bottomrightins=(\the\skip\bottomrightins, \the\ht\bottomrightins)}%
}
%-c_setcolhts

%+c_getcolhts
\def\g@tcolhts{
    \colhtA=\ht\colA \incr{\colhtA}{\topleftins}\incr{\colhtA}{\bottomleftins}%
    \colhtB=\ht\colB \incr{\colhtB}{\toprightins}\incr{\colhtB}{\bottomrightins}%
    \trace{o}{g@tcolhts: colhtA=\the\colhtA, colhtB=\the\colhtB}%
}
%-c_getcolhts

%+c_splitcols
\newif\ifswapcol
\def\spl@tcols#1{
    % even if \vsplit to 0pt, TeX will always pull one line from the input box over
    %\trace{o}{split params maxdepth=\the\splitmaxdepth, topskip=\the\splittopskip, colhtA=\the\colhtA, colhtB=\the\colhtB}
    \splittopskip=\topskip
    \setbox9=\copy#1
    \setbox\colA=\vsplit#1 to \colhtA \ifnum\badness>999999\setbox#1=\box9\setbox\colA\box\voidb@x\else\setbox\colA=\vbox{\unvbox\colA}\fi
    \setbox9=\copy#1
    \setbox\colB=\vsplit#1 to \colhtB \ifnum\badness>999999\setbox#1=\box9\setbox\colB\box\voidb@x\else\setbox\colB=\vbox{\unvbox\colB}\fi
    % swap boxes if either, colA is empty and colB full, or colB is empty and colA is over full.
    \ifvoid\colA\ifvoid\colB\else\ifswapcol\ifdim\colhtA<\ht\colB\else
      \trace{o}{splitcols swapping B->A}\setbox\colA=\box\colB\fi\fi\fi\fi
    \ifdim\ht\colA>\colhtA\ifdim\ht\colB<1pt\ifdim\ht\colA<\colhtB\setbox\colB=\box\colA\fi\fi\fi
    \xdef\p@gebotmark{\splitbotmark}%
}
%-c_splitcols

%+c_balanced_intro
\newdimen\availA \newdimen\availB
\def\BalanceThreshold{0}

\def\balanced{
  \setbox0=\copy\s@vedpage
  \s@tcolhts{\availht}\spl@tcols0                                               %(1)
  \ifnum\BalanceThreshold>0
    \availA=\colhtA \availB=\colhtB
    \advance\availA by -\BalanceThreshold\baselineskip
    \advance\availB by -\BalanceThreshold\baselineskip
  \else
    \availA=0pt \availB=0pt
  \fi
  % and check if it all fit; if not, we'll have to back up and try again
  \ifvoid0 \fitonpagetrue \else \fitonpagefalse \fi
  \rebalancefalse
  \trace{o}{first \the\availht . col=\the\ht\colA, \the\colhtA . second col=\the\ht\colB, \the\colhtB . rem=\the\ht0}%
  \ifdim\ht\colA<.5\baselineskip\ifdim\ht\colB<.5\baselineskip\MSG{I can't break this page!}    %(2)
    \iffitonpage\s@ve@nd \trace{o}{Abandoning ship}% the split failed and there is nothing left!
    \else\setbox\colA=\box0\setbox\s@vedpage=\box\voidb@x \trace{o}{Everything to colA}% dump it all in colA and bail
  \fi\fi\fi
  \iffitonpage
    \shortavail=\colhtB \advance\shortavail by -\ht\colB                        %(3)
    \advance\shortavail by \colhtA \advance\shortavail by -\ht\colA
    \ifdim\shortavail>5\baselineskip
      \trace{o}{Rebalance trying from average \the\shortavail\space of
                \the\colhtA =\the\ht\colA, \the\colhtB =\the\ht\colB}%
      \divide\shortavail 2% \advance\shortavail by -0.5\ht\colA \advance\shortavail by -0.5\ht\colB
      \advance\colhtA by -\shortavail \advance\colhtB by -\shortavail
      \loop\setbox0=\copy\s@vedpage
        \advance\colhtA by \baselineskip
        \advance\colhtB by \baselineskip
        \advance\shortavail by -\baselineskip
        \spl@tcols0
        \trace{o}{Rebalance average loop(\the\shortavail): \the\ht\colA=\the\colhtA,
                  \the\ht\colB=\the\colhtB\space remainder \the\ht0}%
        \ifdim\ht0>0pt \temptrue\else\tempfalse\fi
        \ifdim\shortavail<\baselineskip\tempfalse\fi
        \iftemp\repeat
      \trace{o}{Rebalance starting with \the\colhtA=\the\colhtA, \the\colhtB=\the\colhtB}%
    \fi
    \g@tcolhts                                                                  %(4)
    \shortavail=\colhtA
    \ifunbalanced\shortavail=\availht\else\ifdim\colhtB<\colhtA \rebalancetrue \shortavail=\colhtA\fi\fi
    \advance\colhtA -\baselineskip\ifdim\colhtA<\colhtB \rebalancetrue \shortavail=\colhtB\fi
    \advance\shortavail \baselineskip
%-c_balanced_intro
%+c_balanced_loop
    \loopcount=0
    \ifrebalance
      \vfuzz=\maxdimen
      \loop                                                                     %(5)
        \advance\loopcount by 1
        \advance\shortavail by -\baselineskip
        \setbox0=\copy\s@vedpage
        \dimen0=\shortavail\advance\dimen0 by \ifdim\dp\colA>\dp\colB \dp\colA\else\dp\colB\fi
        \s@tcolhts{\dimen0}\spl@tcols0
		% if something left in box0, it didn't fit, quit loop
        \trace{o}{re-balancing cols=\the\ht\colA =\the\colhtA, \the\ht\colB =\the\colhtB, from \the\shortavail, rem \the\ht0}%
        \ifrem@inder\else\ifvoid0\else
          \advance\shortavail by \baselineskip
          \advance\shortavail by \ifdim\dp\colA>\dp\colB \dp\colA\else\dp\colB\fi
          \trace{o}{rebalance found extra back to \the\shortavail}\rebalancefalse
          \setbox0=\copy\s@vedpage
          \s@tcolhts{\shortavail}\spl@tcols0
        \fi\fi
        % if either column height ends up negative, rollback and bail           %(6)
        \ifrebalance\ifnum\ifdim\colhtA<\availA 1\else\ifdim\colhtB<\availB 1\else 0\fi\fi =1
          \advance\shortavail by \baselineskip
          \trace{o}{rebalance found column height < 0, back to \the\shortavail}\rebalancefalse
          \setbox0=\copy\s@vedpage
          \s@tcolhts{\shortavail}\spl@tcols0
        \fi\fi
		% if second column longer than first column by more than .3*line height, quit loop
        \colhtA=\ht\colA \colhtB=\ht\colB
        \dimen0=\colhtB \incr{\dimen0}{\toprightins} \incr{\dimen0}{\bottomrightins}%
        \advance\dimen0 by -\colhtA \decr{\dimen0}{\topleftins} \decr{\dimen0}{\bottomleftins}%
        \ifdim\dimen0<.95\baselineskip\ifdim\dimen0>-.95\baselineskip           %(7)
          \shortavail=\colhtB\incr{\shortavail}{\toprightins}\incr{\shortavail}{\bottomrightins}%
          \ifdim\dimen0>0pt\else\advance\shortavail by -\dimen0\fi
          \advance\shortavail by \ifdim\dp\colA>\dp\colB \dp\colA\else\dp\colB\fi
          \trace{o}{Best height \the\shortavail}\rebalancefalse
        \fi\fi
		% give up if target size less than 2 lines (should not happen)
        \ifdim\shortavail<\baselineskip \MSG{Rebalancing bailed for short block}%   %(8)
          \shortavail=\availht \rebalancefalse\fi
        \ifnum\loopcount>20 
          \advance\shortavail by \baselineskip
          \rebalancefalse\MSG{Rebalancing loop count bail}\fi
        \ifrebalance\repeat
    \fi
    \advance\shortavail by \ifdim\dp\colA>\dp\colB \dp\colA\else\dp\colB\fi     %(9)
    \s@tcolhts{\shortavail}\spl@tcols\s@vedpage
    \trace{o}{A = \the\colhtA , B = \the\colhtB , remaining = \the\ht\s@vedpage}%
  \fi
}
%-c_balanced_loop

%+c_calcboxheights
\def\c@lcboxheights{
  \g@tcolhts
  \trace{b}{BALANCE pageout: cols=2: texta=\the\ht\colA , \the\dp\colA : textb=\the\ht\colB , \the\dp\colB : partial=\the\ht\partial, \the\dp\partial : topins=\the\ht\topins+\the\skip\topins, \the\ht\topleftins+\the\skip\topleftins, \the\ht\toprightins+\the\skip\toprightins : bottomins=\the\ht\bottomins+\the\skip\bottomins, \the\ht\bottomleftins+\the\skip\bottomleftins, \the\ht\bottomrightins+\the\skip\bottomrightins}%
  \dimen9=\textheight
  \decr{\dimen9}{\partial}\decr{\dimen9}{\topins}\decr{\dimen9}{\bottomins}\decr{\dimen9}{\verybottomins}%
  \ifdim\dimen9<\baselineskip
    \message{No space for text on page!}%
  \else
    \ifdim\ht\topleftins>\dimen9
      \setbox5=\vsplit\topleftins to \dimen9
      \trace{i}{topleft split to \the\dimen9 (\the\ht\topleftins)}%
    \else
      \setbox5=\box\topleftins
    \fi
    \ifdim\ht\toprightins>\dimen9
      \setbox6=\vsplit\toprightins to \dimen9
      \trace{i}{topleft split to \the\dimen9 (\the\ht\toprightins)}%
    \else
      \setbox6=\box\toprightins
    \fi
    \dimen8=\dimen9
    \advance\dimen9 by -\ht5
    \ifdim\ht\bottomleftins>\dimen9
      \setbox7=\vsplit\bottomleftins to \dimen9
      \trace{i}{topleft split to \the\dimen9 (\the\ht\bottomleftins)}%
    \else
      \setbox7=\box\bottomleftins
    \fi
    \dimen9=\dimen8
    \advance\dimen9 by -\ht6
    \ifdim\ht\bottomrightins>\dimen9
      \setbox8=\vsplit\bottomrightins to \dimen9
      \trace{i}{topleft split to \the\dimen9 (\the\ht\bottomrightins)}%
    \else
      \setbox8=\box\bottomrightins
    \fi
  \fi
  \lastd@pth=\dp\colA \setbox\colA=\vbox to \availht{\unvbox5\box\colA\vfil\unvbox7}\dp\colA=\lastd@pth
  \ifdim\ht\colB<1pt\setbox\colB\vbox{\noindent\par}\else\ifdim\lastd@pth<\dp\colB\lastd@pth=\dp\colB\fi\fi
  \setbox\colB=\vbox to \availht{\unvbox6\box\colB\vfil\unvbox8}\dp\colB=\lastd@pth
  \ifdim\colhtA>\colhtB \dimen3=\colhtA\lastd@pth=\dp\colA\dp\colB=\lastd@pth\else
    \dimen3=\colhtB\lastd@pth=\dp\colB\dp\colA=\lastd@pth\fi
  \advance\dimen3 by \lastd@pth
}
%-c_calcboxheights

\def\@mptyinserts{%
  \trace{i}{Emptying Inserts}%
  \global\setbox\topins=\box\voidb@x
  \global\setbox\bottomins=\box\voidb@x
  \global\setbox\topleftins=\box\voidb@x
  \global\setbox\toprightins=\box\voidb@x
  \global\setbox\bottomleftins=\box\voidb@x
  \global\setbox\bottomrightins=\box\voidb@x
  \global\setbox\verybottomins=\box\voidb@x
}
\def\res@tpage{%Restore page to post-setup state
  \trace{i}{Restoring inserts}%
  \r@storeinserts{chunk}%
  \global\setbox255=\box\voidb@x
  \global\holdinginserts=1
  \let\\=\cle@rn@tecl@ss \the\n@tecl@sses
}

\def\s@tpage{%Save post-shipout state / reset other stuff that needs to happen after shipout 
  \trace{i}{Saving inserts}%
  \s@veinserts{chunk}%
  \xdef\p@gefirstmark{}\xdef\p@gebotmark{}%
  \nextshipout
}

%+c_calcavailht
\xdef\p@gebotmark{}% No guarantee this will be universally set
\def\c@lcavailht{
  \edef\t@st{\p@gefirstmark}%
  \ifx\t@st\empty\xdef\p@gefirstmark{\firstmark}\fi% remember first, if not already set
  \edef\t@st{\p@gebotmark}%
  \ifx\t@st\empty\xdef\p@gebotmark{\botmark}\fi
  %NOT HERE! \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \availht=\trialheight % amount of space we think is available
  \trace{i}{C@lcavailht partial:\the\ht\partial \space available:\the\availht}%
  \f@rstnotetrue
  \let\\=\reduceavailht\the\n@tecl@sses % reduce it by the space needed for each note class
  \trace{i}{after inserts: \the\availht}%
  \trace{o}{availht = \the\availht, depth = \the\dp\pstr@t}%
  % Round to lines accurate to 1/8pt in lineskip. 1/10pt causes overflow on longer pages. Support two column legal.
  \dimen0=8\baselineskip
  \multiply\availht by 8 \divide\availht by\dimen0 \multiply\availht by\dimen0 \divide\availht by 8
  \decr{\availht}{\topins}% and by the space needed for spanning pictures
  \decr{\availht}{\bottomins}%
  \decr{\availht}{\verybottomins}%
  %\advance\availht -\dp\pstr@t
  %\advance\availht by \dp255 % split includes depth so give it space for that
  \trace{o}{new availht=\the\availht, topins=\the\ht\topins, bottomins=\the\ht\bottomins, baselineskip=\the\baselineskip}%
  \splittopskip=\topskip
}
%-c_calcavailht

%+c_savepartialpaged_intro
\newif\ifrerunsavepartialpaged
\def\savepartialpaged{%
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \c@lcavailht
  \setbox\s@vedpage=\vbox{\unvbox255}%
  \trace{o}{balancing from savepartialpaged, height=\the\ht\s@vedpage, hIns:\the\holdinginserts, vsz=\the\vsize}%
  \ifdim\ht\partial>\baselineskip\swapcolfalse\else\swapcoltrue\fi
  \ifdim\availht<\baselineskip 
    \rem@indertrue % No, I don't know what this does, but once If i  didn't do it then we get lost verses. 
    %\rem@inderfalse
    \balanced\fitonpagetrue % There's certainly no point shrinking past this
  \else
    \rem@inderfalse\balanced
  \fi
  \iffitonpage
    \c@lcboxheights
    \locs@startstop{\colA}%
    \locs@startstop{\colB}%
    \ht\colA=\dimen3 \ht\colB=\dimen3
    \dimen4=\ht\partial \dimen5=\dp\partial
    \global\setbox\partial=\vbox{
      % bodge the partial box which should really have been properly textually merged
      % the problem is that savepartialpaged can get called twice in succession because
      % not all the output text (after a \singlecolumn) was passed the first time
      \ifvoid\partial\else\trace{o}{nested partial}\unvbox\partial\vskip -2\dimen5\fi
      \ifvoid\topins\else \hbox{\hbox to \columnshift{}\box\topins} \vskip\skip\topins \fi % output top spanning pictures
      \dimen5=\textwidth\advance\dimen5 by -\ExtraRMargin\advance\dimen5 by -\columnshift %
      \vbox{\hbox to \dimen5{%\hbox to \columnshift{}
        \ifRTL \hbox to \ExtraRMargin{}\box\colB\makecolumngutter{\the\dimen3}{\the\dimen3}{\the\lastd@pth}\box\colA %
        \else \box\colA\makecolumngutter{\the\dimen3}{\the\dimen3}{\the\lastd@pth}\box\colB\hbox to \ExtraRMargin{}\fi}}}%
    %\advance\dimen3 by \dimen4 \ht\partial=\dimen3
%-c_savepartialpaged_intro
%+c_savepartialpaged
    \trace{o}{sppd: saved partial, ht:\the\ht\partial\space rem:\the\ht\s@vedpage}%
    \global\holdinginserts=1
    \global\setbox255=\box\voidb@x
    \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
    \c@lcavailht
    \trace{o}{spdd: partial=\the\ht\partial, textheight=\the\textheight, availht=\the\availht}%
    \ifdim\availht<2\baselineskip \twocolp@geout \fi
    \unvbox\s@vedpage\penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi
  \else
    \trace{o}{sppd: Not fit on page}%
    \trace{i}{sppd: emptyinserts hIns=\the\holdinginserts, \the\ht\partial, vs:\the\vsize}%
    \res@tpage
    %\global\advance\vsize by -\baselineskip
    %\global\let\whichtrial=\savepartialpaged
    \global\let\whichtrial=\twocoltrial
    \global\rerunsavepartialpagedtrue
    \global\output={\backingup}%
    \tempfalse%\ifvoid\partial\else\temptrue\fi%
    % remember \holdingInserts=1 from \@emptyinserts
    \ifvoid\galley\temptrue\fi
    \ifm@rksonpage\else\gdef\p@gefirstmark{}\trace{H}{No marks found. Setting empty mark}\fi%No marks on the page, and it didn't fit, so add a blank mark
    \iftemp
     \trace{i}{Using savedpage.pen=\the\outputpenalty}%
     \unvbox\s@vedpage\penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi
    \else%
     \trace{i}{Using galley. pen=\the\galleypenalty}%
     \unvbox\galley\penalty\ifnum\galleypenalty=10000 0 \else \galleypenalty \fi
    \fi%
  \fi%
}
%-c_savepartialpaged

%+c_makenotebox
\def\m@kenotebox{
  \setbox2=\vbox{
  \let\\=\ins@rtn@tecl@ss \the\n@tecl@sses % output all note classes
  \iff@rstnote % no notes actually occurred!
    \trace{i}{No notes}%
    \ifnoteseen\MSG{Page \the\pageno\space is being printed without any footnotes/xrefs, etc. But at least one was seen earlier. Maybe it's ended up on the previous page or moved to the next one, or maybe it's vanished. Human checking is needed.}\fi
    \vfil
  \else
    \setbox0=\lastbox
    \trace{i}{Inserted notes, ht \the\ht0, dp \the\lastd@pth,\the\dp0}%
    \lastd@pth=\dp0 \dp0=0pt \box0 \kern\lastd@pth
  \fi}}
%-c_makenotebox

%+c_twocoltrial_intro
\def\twocoltrial{% trial formatting to see if current contents will fit on the page
  \tracingparagraphs=0
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \c@lcavailht%
  \ifdim\availht<0pt
    \MSG{Page overfull with inserts. Perhaps a little more text and less pictures would help}%
  \fi
  \setbox\s@vedpage=\copy255
  \trace{o}{balance from twocoltrial height \the\ht\s@vedpage}%
  \ifdim\ht\partial>\baselineskip\swapcolfalse\else\swapcoltrue\fi
  \rem@indertrue\balanced
  \iffitonpage\ifvoid\s@vedpage\else\fitonpagefalse\fi
  \else\ifnum\vsize<0 \fitonpagetrue\fi % no fit so dump the page we have now and try again with a new one.
  \fi
%-c_twocoltrial_intro
%+c_twocoltrial
  \iffitonpage
    \c@lcboxheights
    \locs@startstop{\colA}%
    \locs@startstop{\colB}%
    \ifdim\ht\colB<1pt\setbox\colB\vbox{\noindent\par}\fi
    \ht\colA=\the\availht \ht\colB=\the\availht                             %(1)
    \def\pagecontents{%
      \trace{o}{Topins=\the\ht\topins, Bottomins=\the\ht\bottomins, tlins=\the\ht\topleftins, blins=\the\ht\bottomleftins, trins=\the\ht\toprightins, brins=\the\ht\bottomrightins}%
      \dimen1=\textwidth\advance\dimen1 by -\ExtraRMargin
      \ifvoid\partial\else %\msg{2colout partial: \the\ht\partial}\hskip\columnshift
        \vbox{\hbox to \dimen1{\hskip\columnshift\vbox{\unvbox\partial}}}\fi % output partial page
      \ifvoid\topins\else \hbox{\hbox to \columnshift{}\box\topins} \vskip\skip\topins \fi % output top spanning pictures
      \iflastpage\setbox\colA=\vbox{\unvbox\colA}\setbox\colB=\vbox{\unvbox\colB}%
        \ifdim\ht\colA>\ht\colB\ht\colB=\ht\colA\else\ht\colA=\ht\colB\fi\fi
      \trace{p}{Text depth = \the\dimen3}%\showthe\lastd@pth
      \hbox to \dimen1{\hbox to \columnshift{}%
        \ifRTL \hbox to \ExtraRMargin{}\box\colB\makecolumngutter{\the\dimen3}{\the\availht}{\the\lastd@pth}\box\colA
        \else \box\colA\makecolumngutter{\the\dimen3}{\the\availht}{\the\lastd@pth}\box\colB\hbox to \ExtraRMargin{}\fi}%
      \ifvoid\bottomins\else \kern-\lastd@pth
        \lastd@pth=0pt \vskip\skip\bottomins \hbox{\hbox to \columnshift{}\vbox{\unvbox\bottomins}}\fi % ouput bottom spanning pictures
      \f@rstnotetrue
      \m@kenotebox
      \trace{b}{BALANCE pageouttxt: notes=\the\ht2 , \the\dp2}%
      \unvbox2 %\kern-\lastd@pth\lastdepth=\dp2\unvbox2
      \global\noteseenfalse%
      \ifvoid\verybottomins\else\vfil
        \trace{o}{verybottomins(twocoltrial): height=\the\ht\verybottomins , availht=\the\availht, textheight=\the\textheight}
        \kern-\lastd@pth \lastd@pth=0pt \vskip\skip\verybottomins \hbox{\hbox to \columnshift{}\vbox{\unvbox\verybottomins}}\fi % ouput bottom spanning picture
    }%
    \global\setbox255=\box\voidb@x                                          %(+)
    \resetvsize % reset size of next page since it will not have any 1 column material
    \plainoutput 
    \s@tpage
    \global\holdinginserts=1
    \ifrerunsavepartialpaged
      \global\output={\savepartialpaged}\global\rerunsavepartialpagedfalse\unvbox\s@vedpage
    \else\global\output={\twocols}\unvbox\s@vedpage\fi
    \ifnum\interactionmode=2
      \showlists
    \fi
  \else % the contents of the "galley" didn't fit into the columns,         %(+)
        % so reduce \vsize and try again with an earlier break
    \trace{o}{Reducing vsize \the\vsize, by \the\baselineskip}%
    \global\advance\vsize by -\baselineskip
	% clear insertions
    \trace{i}{2coltrial: emptyinserts hIns=\the\holdinginserts}%
    \res@tpage
    \global\let\whichtrial=\twocoltrial                                     %(+)
    \global\output={\backingup}%
    \ifm@rksonpage\else\gdef\p@gefirstmark{}\trace{H}{No marks found. Setting empty mark}\fi%No marks on the page, and it didn't fit, so add a blank mark
    \unvbox\galley \penalty\ifnum\galleypenalty=10000 0 \else \galleypenalty \fi
  \fi}
\newif\iffitonpage
\newif\ifrebalance
%-c_twocoltrial

%+c_makecolumngutter
\newdimen\columnshift \columnshift=0pt
\newdimen\ColumnGutterRuleSkip \ColumnGutterRuleSkip=0pt

%makecolumngutter{rule height}{vbox height}{depth}
\def\makecolumngutter#1#2#3{\hfil
  \dimen4=#1\advance\dimen4-\ColumnGutterRuleSkip%\advance\dimen4 by #3
  \ifColumnGutterRule
    \setbox4=\vbox to #2{
      \vskip\ColumnGutterRuleSkip
      \hbox to 1pt{\hfil\vrule height \the\dimen4\hfil}%\dp5=#3 \box5
      \vfil}%
    \dp4=#3 \box4
  \fi
  \hfil
  \hbox to \columnshift{}}
\newif\ifColumnGutterRule
%-c_makecolumngutter

%+c_backingup
\def\backingup{% this output routine is used when we reduce \vsize;
               % it will cause a new page break to be found, and then the \trial routine is called again
  \trace{o}{backingup hIns=\the\holdinginserts(==1)}%
  \global\deadcycles=0
  \global\setbox\galley=\copy255
  \global\galleypenalty=\outputpenalty
  \global\output={\whichtrial}%
  \global\holdinginserts=0
  \unvbox255% eject
  \penalty\ifnum\outputpenalty=10000 0 \else \outputpenalty \fi
}
%-c_backingup

%+c_savepartialpagedbounce
\xdef\p@gefirstmark{}
\def\savepartialpagedbounce{
  % This output routine gets the partial galley (input text) before a 2->1 column transition
  % so that it can be re-run with holdinginserts=0, so footnotes etc can be seen.
  \global\trialheight=\textheight \global\advance\trialheight by -\ht\partial
  \c@lcavailht
  \vsize=2\availht
  \advance\vsize by \baselineskip
  \global\output={\savepartialpaged}%
  \global\setbox\galley=\copy255 \global\setbox\galley=\vbox{\unvbox\galley}%
  \bgroup\setbox0=\copy255 \setbox1=\vsplit0 to \maxdimen\egroup
   \edef\t@mp{\splitbotmark}%
   \ifx\t@mp\empty\else\global\m@rksonpagetrue\trace{H}{Found mark \splitbotmark}\fi
  \trace{o}{sppb hIns=\the\holdinginserts, pt:\the\ht\partial, g:\the\ht255, \the\ht\galley}%
  \global\holdinginserts=0
  \unvbox255\eject
}
%-c_savepartialpagedbounce


% to switch back to diglot columns, first set the page  so far 
% and then change the rest.
\def\diglotcolumns{
  \trace{o}{DiglotColumns: partial:\the\ht\partial. Pff:  \PageFullFactor\space\the\textheight}%
  \ifx\@netimesetup\relax%Skip ending diglot if there's no possibily we've started.
    \ifdiglot
      \enddigl@t
    \fi
  \fi
  \global\diglottrue\diglots@tup
}

\def\diglots@tup{%
  % reset parameters for diglot-column formatting
  \kill@PossParamCache
  \global\hsize=\columnLwidth % always start with left column
  \global\vsize=\textheight
  \global\BodyColumns=2
  \global\advance\vsize by \baselineskip % don't get caught short by 1/2 line or so
  \global\advance\vsize by -\ht\partial % Don't mis-inform TeX
  % make a macro reset vsize for remaining pages which do not have 1 column material
  \gdef\resetvsize{\global\vsize=\textheight \global\advance\vsize by -\ht\partial \global\advance\vsize by 0.5\baselineskip} 
  \global\availht=\vsize
  \global\c@rrentcols=2
  \global\output={\diglotCollect}%
  
  % (\count of an insertion class is a scaling factor)
  \count255=1000
  \global\count\topins=\count255
  \global\count\bottomins=\count255
  %\let\\=\s@tn@tec@unt \the\n@tecl@sses % NECESSARY? reset \count for each note class
  \global\holdinginserts=1 % don't pull out inserts yet, we are still adjusting page
  %\msg{Starting diglot partial: \the\ht\partial, pagetotal: \the\pagetotal, vsize: \the\vsize}
} 

%+c_twocolpageout
\def\twocolp@geout{%This gets used a few times
  \trace{o}{twocolp@geout cols=1: partial=\the\ht\partial , \the\dp\partial : topins=\the\ht\topins : bottomins=\the\ht\bottomins}%
  \def\pagecontents{
    \trace{b}{BALANCE pageout: cols=1: partial=\the\ht\partial , \the\dp\partial : topins=\the\ht\topins : bottomins=\the\ht\bottomins}%
    \vbox{\dimen1=\textwidth \advance\dimen1 -\ExtraRMargin
      \ifvoid\partial\else \vbox{\hbox to \dimen1{\hskip\columnshift\box\partial}} \fi
	  \lastd@pth=\dp\partial
      \ifvoid\bottomins\else % \kern-\dimen0
        \lastd@pth=0pt \vskip\skip\bottomins \hbox{\hbox to \columnshift{}\vbox{\unvbox\bottomins}}\fi
      \f@rstnotetrue%
      \m@kenotebox
      \trace{b}{BALANCE pageouttxt: notes=\the\ht2 , \the\dp2}%
      \unvbox2 %\kern-\lastd@pth\lastdepth=\dp2\unvbox2
      \ifvoid\verybottomins\else\ifdim\availht > 0pt % \kern-\dimen0
        \trace{o}{verybottomins(twocolp@geout): height=\the\ht\verybottomins , availht=\the\availht, textheight=\the\textheight}
        \lastd@pth=0pt \vskip 0pt plus 1fill\vskip\skip\verybottomins \hbox{\hbox to \columnshift{}\vbox{\unvbox\verybottomins}}\fi\fi
    }}\plainoutput
    \s@tpage
    \fin@lverybottom
}
\def\fin@lverybottom{%
  \ifvoid\verybottomins\else
      %\setbox0=\vbox{\unvbox\verybottomins\setbox1=\lastbox}
    \loop
      \trace{o}{verybottom(fin@lverybottom) height=\the\ht\verybottomins, textheight=\the\textheight, vsize=\the\vsize,
                verybottomins=\the\count\verybottomins, \the\dimen\verybottomins}
      \setbox0=\vsplit\verybottomins to \textheight
      \def\pagecontents{\vfil\hbox{\hbox to \columnshift{}\vbox{\unvbox0}}}
      \plainoutput
      \s@tpage
      \ifvoid\verybottomins\tempfalse\else\temptrue\fi\iftemp\repeat
  \fi
}
%-c_twocolpageout

%+c_singlecolumn
% to switch back to single column, we reset the page size parameters
\def\singlecolumn{%
  \trace{o}{singlecolumn hIns=\the\holdinginserts}%\tracingmacros=1
  \ifnum\c@rrentcols>1
    \ifhe@dings\endhe@dings\fi
    %\temptrue
    \global\output={\savepartialpagedbounce}\eject\eject % save any partially-full page into a box.
    %LOTS happens before this line is reached!
    \global\hsize=\textwidth \advance\hsize by -\columnshift
    \global\vsize=\textheight
    %\tempfalse
    \trace{o}{SingleColumn: \the\ht\partial > \PageFullFactor\space\the\textheight}%
    \ifdim\ht\partial>\PageFullFactor\textheight\iflastptxfile\else
      \twocolp@geout \fi\fi%Set up pagecontents and call \plainoutput
    \global\c@rrentcols=1
    \trace{o}{resetting resetvsize for singlecolumn}\def\resetvsize{\trace{o}{resetvsize}\global\vsize=\textheight} 
    \global\output={\onecol}%
    \global\holdinginserts=1
    \count255=1000
    \global\count\topins=\count255
    \global\count\bottomins=\count255
    \let\\=\s@tn@tec@unt \the\n@tecl@sses % reset \count for each note class
    \ifdim\ht\partial>\baselineskip \vbox{\unvbox\partial}%
      \ifendbooknoeject\ifx\p@gefirstmark\t@tle \else\vskip\baselineskip\iflastptxfile\else\hskip-\columnshift\hrule\vskip2\baselineskip\fi\fi\fi
    \fi
  \fi}%
%-c_singlecolumn

\newread\t@mpfile
\def\includeifpresent#1{%
  \openin\t@mpfile="#1"
  \ifeof\t@mpfile\closein\t@mpfile
    \immediate\write-1{Optional file "#1" Cannot be found}%
  \else
    \closein\t@mpfile
    \immediate\write-1{Reading optional file "#1"}%
    \input "#1"
  \fi}


\def\includepdf{\@netimesetup % in case \ptxfile hasn't been used yet
  \ifx\XeTeXpdfpagecount\undefined
    \MSG{*** sorry, \string\includepdf\space requires XeTeX 0.997 or later}%
    \let\n@xt\relax
  \else \let\n@xt\incl@depdf \fi
  \n@xt}
\def\incl@depdf{\begingroup
  \m@kedigitsother \catcode`\[=12 \catcode`\]=12
  \futurelet\n@xt\t@stincl@de@ptions}
\def\t@stincl@de@ptions{\ifx\n@xt[\let\n@xt\incl@de@ptions
  \else\let\n@xt\incl@deno@ptions\fi\n@xt}
\def\incl@deno@ptions#1{\incl@de@ptions[]{#1}}
\def\incl@de@ptions[#1]#2{%
  \totalp@ges=\XeTeXpdfpagecount "#2"\relax
  \whichp@ge=0
  \loop \ifnum\whichp@ge<\totalp@ges
    \advance\whichp@ge by 1
    \setbox0=\hbox{\XeTeXpdffile "#2" page \whichp@ge #1}%
    \ifdim\wd0>\pdfpagewidth
      \setbox0=\hbox{\XeTeXpdffile "#2" page \whichp@ge #1 width \pdfpagewidth}%
    \fi
    \ifdim\ht0>\pdfpageheight
      \setbox0=\hbox{\XeTeXpdffile "#2" page \whichp@ge #1 height \pdfpageheight}%
    \fi
    {\def\c@rrID{#2 #1 page \number\whichp@ge}% for lower crop-mark info, if requested
      \shipcompletep@gewithcr@pmarks{\vbox{\box0}}}%
    \advancepageno
    \repeat
  \endgroup % begun in \incl@depdf
}
\newcount\totalp@ges
\newcount\whichp@ge
\newcount\im@gecount

\newif\ifendbooknoeject \endbooknoejectfalse
\def\pagebreak{
  \ifsk@pping \egroup \fi%
  \ifhe@dings\endhe@dings\fi%
  \vfill\eject%
}
\def\bookendpagebreak{
  \ifsk@pping \egroup \fi%
  \ifhe@dings\endhe@dings\fi%
  \ifendbooknoeject\else%
  \vfill\eject\fi%
}
\let\pb=\pagebreak

\def\columnbreak{\vfill\eject}

\newcount\badspacepenalty \badspacepenalty=100
\tolerance=9000
\hbadness=10000
% how much space to happily insert before allowing overfull lines. Must be >27pt for emergencypass to run
\emergencystretch=1in
\vbadness=10000
\vfuzz=2pt
\frenchspacing

\XeTeXdashbreakstate=1 % allow line-break after en- and em-dash even if no space

%% various Unicode characters that we handle in TeX... and protect in TOC and PDF bookmarks

\def\SFTHYPHEN{\-}
\def\NBSP{\nobreak\space} % make Unicode NO-BREAK SPACE into a no-break space
\def\ZWSP{\hskip0pt\relax} % ZERO WIDTH SPACE is a possible break
\def\WJ{\leavevmode\nobreak} % WORD JOINER
\def\ZWNBSP{\WJ} % ZERO WIDTH NO-BREAK SPACE
\def\NBHYPH{\leavevmode\hbox{-}} % NON-BREAKING HYPHEN
\def\NQUAD{\penalty\the\badspacepenalty\hskip 0.4em} % subvert Unicode En-Quad as BAD BREAKING SPACE
\def\MQUAD{\penalty\the\badspacepenalty\hskip 1em}
\def\MSPACE{\hskip 1em}
\def\NSPACE{\space}
\def\THREEPEREMSPACE{\hskip .333em}
\def\FOURPEREMSPACE{\hskip .25em}
\def\SIXPEREMSPACE{\hskip .1666em}
\def\THINSPACE{\hskip .2em}
\def\HAIRSPACE{\penalty\the\badspacepenalty\hskip 1sp}
\def\HYPHEN{\-}
\def\emdash{\char"2014\relax}
%endash defined in ptx-references.tex

\let\pr@tect=\relax
\def\pr@tectspecials{%
  \let\SFTHYPHEN=\relax
  \let\NBSP=\relax
  \let\ZWSP=\relax
  \let\ZWNBSP=\relax
  \let\WJ=\relax
  \let\NBHYPH=\relax
  \let\NQUAD=\relax
  \let\MQUAD=\relax
  \let\MSPACE=\relax
  \let\NSPACE=\relax
  \let\THREEPEREMSPACE=\relax
  \let\FOURPEREMSPACE=\relax
  \let\SIXPEREMSPACE=\relax
  \let\THINSPACE=\relax
  \let\HAIRSPACE=\relax
  \let\HYPHEN=\relax
}

\catcode"A0=12
\catcode"AD=12
\catcode"200B=12
\catcode"2060=12
\catcode"FEFF=12
\catcode"2000=12
\catcode"2001=12
\catcode"2002=12
\catcode"2003=12
\catcode"2004=12
\catcode"2005=12
\catcode"2006=12
\catcode"2009=12
\catcode"200A=12
\catcode"2010=12
\def\liter@lspecials{%
  \def\pr@tect{}%
  \def\NBSP{^^a0}%
  \def\SFTHYPHEN{^^ad}%
  %\def\ZWSP{^^^^200b}%
  \def\WJ{^^^^2060}%
  \def\ZWNBSP{^^^^feff}%
  \def\NBHYPH{^^^^2011}%
  \def\NQUAD{^^^^2000}%
  \def\MQUAD{^^^^2001}%
  \def\NSPACE{^^^^2002}%
  \def\MSPACE{^^^^2003}%
  \def\THREEPEREMSPACE{^^^^2004}%
  \def\FOURPEREMSPACE{^^^^2005}%
  \def\SIXPEREMSPACE{^^^^2006}%
  \def\THINSPACE{^^^^2009}%
  \def\HAIRSPACE{^^^^200a}%
  \def\HYPHEN{^^^^2010}%
}

\catcode"A0=\active   \def^^a0{\pr@tect\NBSP}
\catcode"AD=\active   \def^^ad{\pr@tect\SFTHYPHEN}
\catcode"200B=\active \def^^^^200b{\pr@tect\ZWSP}
\catcode"2060=\active \def^^^^2060{\pr@tect\WJ}
\catcode"FEFF=\active \def^^^^feff{\pr@tect\ZWNBSP}
\catcode"2011=\active \def^^^^2011{\pr@tect\NBHYPH}
\catcode"2000=\active \def^^^^2000{\pr@tect\NQUAD}
\catcode"2001=\active \def^^^^2001{\pr@tect\MQUAD}
\catcode"2002=\active \def^^^^2002{\pr@tect\NSPACE}
\catcode"2003=\active \def^^^^2003{\pr@tect\MSPACE}
\catcode"2004=\active \def^^^^2004{\pr@tect\THREEPEREMSPACE}
\catcode"2005=\active \def^^^^2005{\pr@tect\FOURPEREMSPACE}
\catcode"2006=\active \def^^^^2006{\pr@tect\SIXPEREMSPACE}
\catcode"2009=\active \def^^^^2009{\pr@tect\THINSPACE}
\catcode"200A=\active \def^^^^200a{\pr@tect\HAIRSPACE}
\catcode"2010=\active \def^^^^2010{\pr@tect\HYPHEN}
\lccode"2010="2010
\catcode`\@=12

\parskip=0pt
\lineskip=0pt
% NOTE: The baselineskip is set negative here. Later on it will
% be set to the default of 14pt unless the user has specified
% another setting. If that is the case, that setting will be
% used and text can then move off the baseline which makes
% balancing easier but causes text to move off the grid in
% some instances.
\baselineskip=-14pt

\widowpenalty=10000
\clubpenalty=10000
\brokenpenalty=50

\endinput
