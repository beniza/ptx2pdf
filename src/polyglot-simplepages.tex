%:strip
% polyglot-simplepages.tex: multi-page polyglot processing for xetex paratext2.tex
% Copyright (c) 2021 by SIL International 
% written by David Gardner
% 
% This optional module (see ptx-modules) extends the basic diglot engine to
% provide polyglot options
%
% Permission is hereby granted, free of charge, to any person obtaining
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\module@startif{polyglot-simplepages}
\newcount\p@lyp@geno

\def\p@lyp@ges{0}
\def\p@lyp@gestring{\the\p@lyp@geno}
\def\p@lyp@gesuffx{@poly@\p@lyp@gestring}
\def\s@tpolyp@ge#1{%
  \trace{dmp}{ #1 is on page \p@lyp@gestring}%
  \x@\xdef\csname p@lyp@ge#1\endcsname{\p@lyp@gestring}}

\def\s@tpolyp@ges#1\E{%
  \let\spp@d@=\d@
  \xdef@cseq{p@lyp@gecols\the\p@lyp@geno}{#1}% p@lyp@gecols0 ... p@lyp@gecolsN give list the columns for the respective page
  \let\col@do=\s@tpolyp@ge
  \each@col#1\E
  \xdef\p@lyp@ges{\the\p@lyp@geno}
  \ifnum \p@lyp@geno>0  % new@poly@page doesn't get run for page0, as those take over the standard boxes
    \edef\tmpname{partial\p@lyp@gesuffx }
    \ifcsname \tmpname\endcsname\else
      \new@poly@page
    \fi
  \fi
  \global\advance\p@lyp@geno by 1
  \let\d@=\spp@d@
  }

\def\new@poly@page{%called with p@lyp@geno=new page
  \let\d@=\m@kepolyb@x
  \x@\cstackdown\p@lyins@rts,\E
}

\def\e@tcomma#1,\E{#1} %Remove the trailing comma from a list.
%
% Boxes
% Each page-related box (\partial and picture insert boxes) has a separate copy for each page. 
% on switching between columns / pages, the appropriate page's copy becomes 'active' i.e. \partial points to \partial@poly@0
\def\polyglot@onetime@setup{%
  \edef\@ut{\x@\e@tcomma\ins@rts\E}%
  \let\d@\gen@p@lyins@rts %populates \@ut with insert save names
  \x@\cstackdown \s@veclasses\E
  \xdef\p@lyins@rts{partial,n@xtpartialNrml,n@xtpartialRev,\@ut,}%
  \trace{dmp}{poly@inserts defined as: \p@lyins@rts}%
  % Now setup copies of boxes.
  \addtoinithooks{%
    %\tracingassigns=1
    \let\d@=\poly@setup@inserts
    \x@\cstackdown \p@lyins@rts,\E
    %\tracingassigns=0
    }%
  \global\let\polyglot@onetime@setup\relax
} 
\def\polyglot@eachtime@setup{%
}

\def\poly@setup@inserts#1\E{\x@\let\x@\tmp@ins\csname #1\endcsname \x@\global\x@\let\csname #1@poly@0\endcsname\tmp@ins} %Make each valid insert type have a page-number suffix

\def\poly@rename@inserts#1\E{%
  \x@\let\x@\tmp@ins\csname #1\p@lyp@gesuffx\endcsname
  \x@\global\x@\let\csname #1\endcsname\tmp@ins
} %Point the normal insert name to the page-numbered version

\def\m@kepolyb@x#1\E{\x@\newb@x\csname #1\p@lyp@gesuffx\endcsname}

\def\switch@polypage#1{%Switch to the relevant page for the column selected.
  \x@\let\x@\sp@lynum\csname p@lyp@ge#1\endcsname
  \ifnum\p@lyp@geno=\sp@lynum\relax
    \trace{dmp}{switch@polypage #1, on \the\p@lyp@geno already}%
  \else
    \trace{dmp}{switch@polypage #1 -> \sp@lynum}%
    \@s@tp@lypage{\sp@lynum}%
  \fi
}

\def\@s@tp@lypage#1{%
    \global\p@lyp@geno=#1\relax
    \let\d@=\poly@rename@inserts
    \x@\cstackdown \p@lyins@rts,\E
}
\def\gen@p@lyins@rts#1\E{\edef\s@veclass{#1}\let\gpiD@=\d@\let\d@=\cs@apply\let\do@it=\s@veclass@name
  \x@\cstackdown\ins@rts\E
  \let\d@=\gpiD@
}

\def\polyglotpages#1{%comma separated list of concatenated columns to put on different pages (e.g. LR,AB) specifies 2 pages, pg1 shows L+R, pg2 A+B
  \trace{dmp}{polyglotpages #1}%
  \polyglot@onetime@setup
  \polyglot@eachtime@setup
  \p@lyp@geno=0
  \let\d@=\s@tpolyp@ges
  \cstackdown#1,\E
  \message{Polyglot: layout across \the\p@lyp@geno pages}%
  \ifnum\p@lyp@geno=1 
    \edef\diglotlayout{simplecols}
  \else
    \edef\diglotlayout{simplepages}
  \fi
}
 
%%%% Diglot module interface functions.

\let\@do@prepare@simplepages=\@do@prepare@simplecols
\def\@do@setup@simplepages{}%No special setup


\def\@@do@simplepage@{%
  \x@\let\x@\layout@list\csname p@lyp@gecols\the\p@lyp@geno\endcsname
  \trace{dmp}{\spt@sk \the\p@lyp@geno:\layout@list\space \the\ht\partial+\the\dp\partial}%
  %make reverse layout list
  \let\col@do=\mkrev@list
  \xdef\rev@layout@list{}\def\list@type{layout}%
  \x@\each@col\layout@list\E%
  \trace{dmp}{revlist: \rev@layout@list}%
  %pick correct inserts
  \let\d@=\poly@rename@inserts
  \x@\cstackdown \p@lyins@rts,\E
  %populate page
  \scol@cmd
  %Itterate
  \ifnum\p@lyp@geno<\p@lyp@ges\relax
    \advance\p@lyp@geno by 1
    \let\n@xtlsp=\@@do@simplepage@
  \else
    \let\n@xtlsp=\relax
  \fi
  \n@xtlsp
}

\def\@writep@ge@simplepages{%
  \edef\spt@sk{@writep@ge@simplepages }%
  \p@lyp@geno=0 \let\scol@cmd=\@writep@ge@simplecols
  \@@do@simplepage@
}
\def\@do@layout@simplepages{%
  \edef\spt@sk{@do@layout@simplepages \space0:\l@gdims{\csname partial@poly@0\endcsname}, 1:\l@gdims{\csname partial@poly@1\endcsname} p:\l@gdims{\partial}}%
  \p@lyp@geno=0 \let\scol@cmd=\@do@layout@simplecols
  \@@do@simplepage@
  %\pagecontents{\x@\box\csname partial@poly@0\endcsname}\plainoutput
  %\pagecontents{\x@\box\csname partial@poly@1\endcsname}\plainoutput
  %\@@do@simplepage@B
  \@s@tp@lypage{0}%
}
\def\@do@arrange@balnotes@simplepages{
  \@do@arrange@balnotes@simplecols
}%
\def\@do@arrange@unbalnotes@simplepages{
  \@do@arrange@unbalnotes@simplecols
}%

\def\@postswap@simplepages#1{}

\def\count@dim@simplepages#1{%Is the dimension non non-zero? Count using curactivecols and add tag to list IF it is on the present page
  \x@\ifdim \csname \v@lpfx#1\v@lsfx\endcsname=0pt\else
    \advance\curactivecols by 1
    \x@\let\x@\sp@lynum\csname p@lyp@ge#1\endcsname
    \ifnum\p@lyp@geno=\sp@lynum\relax
      \edef\cts@list{\cts@list#1}%
    \fi
  \fi
}

\def\@preswap@simplepages#1{%
  %\tracingmacros=1
  %\tracingassigns=1
  \let\log@ut\empty\def\v@lpfx{}\def\v@lsfx{box}%
  \l@gm@dims
  %\tracingmacros=0
  %\tracingassigns=0
  \trace{dmp}{@preswap@simplepages #1 \log@ut}%
  \tracingassigns=1
  \x@\let\x@\ps@sp@tmp\csname p@lyp@ge#1\endcsname
  \tracingassigns=0
  \ifnum\p@lyp@geno=\ps@sp@tmp\relax
  \else
    \switch@polypage{#1}%
  \fi
}
%\let\@do@layout@simplepages=\@do@layout@simplecols
%\let\@do@setup@simplepages=\@do@setup@simplecols
%\let\@do@cleanup@simplepages=\@do@cleanup@simplecols
%\let\end@writep@ge@simplepage=\end@writep@ge@simplecols


\module@endif
