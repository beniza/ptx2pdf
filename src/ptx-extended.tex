%:skip
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Part of the ptx2pdf macro package for formatting USFM text
% copyright (c) 2007 by SIL International
% written by Jonathan Kew
%
% Permission is hereby granted, free of charge, to any person obtaining  
% a copy of this software and associated documentation files (the  
% "Software"), to deal in the Software without restriction, including  
% without limitation the rights to use, copy, modify, merge, publish,  
% distribute, sublicense, and/or sell copies of the Software, and to  
% permit persons to whom the Software is furnished to do so, subject to  
% the following conditions:
%
% The above copyright notice and this permission notice shall be  
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  
% NONINFRINGEMENT. IN NO EVENT SHALL SIL INTERNATIONAL BE LIABLE FOR  
% ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF  
% CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION  
% WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
%
% Except as contained in this notice, the name of SIL International  
% shall not be used in advertising or otherwise to promote the sale,  
% use or other dealings in this Software without prior written  
% authorization from SIL International.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%+c_ext_intro
% Declare things we need.

\newbox\extb@x % Box in which extended study matter is placed
\newbox\extchunkb@x % Box in which extended study matter is placed
\newbox\sid@barnotes % Box in which notes are placed in a sidebar
\newtoks\old@bx %store old definition of \everyhbox
\def\c@tegory{}
\gdef\sb@rmarker{esb} % future-proofing. What's the current sidebar marker?

\def\setsbp@ram#1#2{\trace{sc}{Styling cat \c@tegory:#1 #2}\setp@ram{#1}{\sb@rmarker}{#2}}
\def\getsbp@ram#1{\getp@ram{#1}{\sb@rmarker}\let\cp@ram\p@ram\ifx\cp@ram\empty\global\let\cp@ram\relax\fi\trace{sc}{Got result for (\c@tegory)\sb@rmarker:#1: \cp@ram}}
\def\getsbp@ramNoInh#1{\edef\d@sf{\g@tdstat}%
  \getp@r@m{#1}{\c@tprefix\sb@rmarker\d@sf}\ifx\p@ram\relax\getp@ram{#1}{\c@tprefix\sb@rmarker}\fi
  \let\cp@ram\p@ram
  \ifx\cp@ram\empty\global\let\cp@ram\relax\fi
  \ifx\cp@ram\relax
    \trace{sc}{No result for \c@tprefix\sb@rmarker:#1}\else
    \trace{sc}{Got result for \c@tprefix\sb@rmarker:#1: \cp@ram}%
  \fi
}
%\setsbp@ram{hascol}{T}
%\setsbp@ram{bgcolour}{0 1 0}
%\setsbp@ram{alpha}{0.2}% 1=solid 0=invisible
\setsbp@ram{bgfigscale}{1}%
\setsbp@ram{fgfigsize}{box}%What is image scaled to?
\setsbp@ram{fgfigscale}{0.2}%
\setsbp@ram{fgfigpos}{cl}%Default is cutout left
\setsbp@ram{bgfigscale}{1}%Full size
\setsbp@ram{bgfigpos}{pc}%Horizontally centred
\setsbp@ram{hascol}{F}%No default colour.
\setsbp@ram{alpha}{0.2}% 1=solid 0=invisible
\setsbp@ram{borderwidth}{0.5}% in FontSizeUnit
\setsbp@ram{posn}{b}
\setsbp@ram{fgfigspec}{}%Normally no picture.
\setsbp@ram{bgfigspec}{}%Normally no picture.
\def\fb@hpadding{1pt}%Added left and right of feintbox content
\def\fb@vpadding{1pt}%added above and below feintbox content

\newcount\feintb@xnum
\feintb@xnum=1
\addtoendhooks{\ifinextended\errmessage{Reached end of book without finding \\esbe.}\fi}
\def\feintb@x#1#2#3#4#5{%
  % 1 - alpha
  % 2 - colour (r g b)
  % 3 4 5 height, depth, width of colour block
  \trace{e}{feintbox #1 #2 #3 #4 #5}%
  \bgroup
  \hbox to 0pt{%
    \dimen0=#3\advance\dimen0 by \fb@vpadding
    \dimen1=#4\advance\dimen1 by \fb@vpadding
    \dimen3=\fb@hpadding
    \dimen2=#5\advance\dimen2 by 2\dimen3
    \hskip -\dimen3 % Backup so the expanded box is centred properly
    \edef\thisalpha{#1 }%
    \special{pdf:put @resources << /ExtGState << /GS0\the\feintb@xnum\space << /Type /ExtGState /CA \thisalpha /ca #1 /AIS false >>  >> >>}%
     \x@\special\x@{pdf:code q /GS0\the\feintb@xnum\space gs #2 rg}%
     \vrule height \dimen0 depth \dimen1  width \dimen2 %should be possible to get this working in pdf code, but this works.
     \special{pdf:code Q}%
     \hss
  }%
  \egroup\global\advance\feintb@xnum by 1}

\def\feintbox#1#2#3{% Set a (transparent) coloured box as background for box given in #3. #1: alpha, #2: {r g b}  (all numbers in range 0-1.0)
  \vskip-\fb@vpadding% preserve grid
  \setbox0#3%
  \trace{e}{pre-feintbox, ht=\the\ht0, dp=\the\dp0}%
  \setbox0\hbox{\feintb@x{#1}{#2}{\ht0}{\dp0}{\wd0}\box0}%
  \trace{e}{post-feintbox, ht=\the\ht0, dp=\the\dp0}%
  \box0
  %\vskip-\fb@vpadding % preserve grid
  }

\def\minip@rs@two#1#2\end{%
   \edef\tempc{#1}\edef\tempd{#2}}%
\def\minip@rsepos#1#2\mid#3\end{%Parse just enough of the FgImagePos and pos parameters to determine the \hsize
   \edef\tempa{#1}\edef\tempb{#2}%
   \x@\minip@rs@two#3\end
   \trace{e}{parsed: \tempa(\tempb), \tempc(\tempd)}%
}

\def\p@rseBorder#1 #2\relax{
  \let\n@xtB=\p@rseBorder
  \def\t@st{#1}%
  \trace{e}{Parsing border parameter '#1' '#2'}%
  \ifx\t@st\empty
    \let\n@xtB\endP@rseBorder
  \else
    \uppercase{\def\uc@ption{#1}}%
    \x@\let\x@\t@st\csname B@rder\uc@ption\endcsname
    \ifx\t@st\relax
      \message{Could not parse Border #1}%
    \else
      \t@st \relax
    \fi
  \fi
  \def\t@st{#2}%
  \ifx\t@st\empty
    \let\n@xtB\endP@rseBorder
  \fi
  \n@xtB#2 \relax
}

\def\endP@rseBorder#1 \relax{
  \trace{e}{Finished parsing border}% 
}

\def\s@tsb@rwidth{%Set default / specific width of esb box
 %h*,c*,p* take the current page width as their base
 %tX,bX take the column width 
 %t,b,B take the text width
 \trace{e}{setsb@rwidth c:\the\colwidth, t:\the\textwidth, h:\the\hsize, \the\c@rrentcols}%
 \getsbp@ram{posn}%
 \ifx\cp@ram\relax
   \gdef\sb@rpos{b}%
   \setsbp@ram{posn}{\sb@rpos}%
 \else
   \global\let\sb@rpos\cp@ram
 \fi
 \getsbp@ram{fgfigpos}\let\fgfigp@s\cp@ram
 \getsbp@ram{fgfigspec}\let\fgfigsp@c\cp@ram
 \getsbp@ramNoInh{w@dth}% Width must NOT be inherited.
 \ifx\cp@ram\relax
   \x@\minip@rsepos\fgfigp@s\mid\sb@rpos\end
   \dimen1=\ifnum \c@rrentcols=1 \textwidth \else \colwidth\fi
   \trace{sc}{Initial width set to \the\dimen1}%
   \ifx\tempd\empty
     \if\tempc t\relax\dimen1=\textwidth\else
       \if\tempc b\relax\dimen1=\textwidth\else
         \if\tempc B\relax\dimen1=\textwidth\fi\fi\fi
   \else
     \if\tempc t\relax\dimen1=\colwidth\else
       \if\tempc b\relax\dimen1=\colwidth\fi\fi
   \fi
   % Now apply scale..
   \getsbp@ram{scale}\ifx\cp@ram\relax\else
      \dimen1=\cp@ram\dimen1
   \fi
   \getsbp@ram{\ifodd\pageno borderoddleft\else borderevenleft\fi}\let\b@drleft\cp@ram
   \getsbp@ram{\ifodd\pageno borderoddright\else borderevenright\fi}\let\b@drright\cp@ram
   \getsbp@ram{borderwidth}\let\b@drwidth\cp@ram
   \trace{e}{basic width of \sb@rpos: \the\dimen1}%
   % And shrink further if s has been specified for the fg picture
   \ifx\fgfigsp@c\empty\else
     \if\tempa s
     \getsbp@ram{fgfigscale}%
     \ifx\cp@ram\relax
       \dimen0=0.2\dimen1
     \else
       \dimen0=\cp@ram\dimen1
     \fi
     \advance\dimen1 by -\dimen0
   \fi\fi
   \ifx\b@drleft\tr@e \advance\dimen1 by -\b@drwidth\FontSizeUnit
     \advance\dimen1 by \fb@hpadding\fi
   \ifx\b@drright\tr@e \advance\dimen1 by -\b@drwidth\FontSizeUnit
     \advance\dimen1 by \fb@hpadding\fi
   \if h\tempc\relax\else
     \setsbp@ram{w@dth}{\the\dimen1}%
   \fi
 \else
   \dimen1=\cp@ram
 \fi
 \hsize=\dimen1
}
% Sidebar 
\def\@sb{\let\oldc@tegory\c@tegory\let\oldc@prefix\c@tprefix 
  \trace{e}{Starting side bar from \m@rker}%
  %\ifhmode\par\fi
  % kill cached possParam-\m@rker values  
  \kill@PossParamCache
  \edef\hs@ze{\the\hsize}%
  \s@tc@tpr@fix
  \getsbp@ram{w@dth}\end@llpoppedstyles{s}\mcpush{s+\sb@rmarker}\trace{e}{ESB}\setbox\extb@x\vbox\bgroup
    \s@tsb@rwidth\inextendedtrue
    \global\sb@rchunkh@ight=\maxdimen
    \global\c@th@@ks{\st@rtsb@r}%
}
\newdimen\sb@rchunkh@ight
\newdimen\sb@rus@dheightl
\newdimen\sb@rus@dheightr
\def\st@rtsb@r{%Gets run by \cat..\cat*, if one is used. 
 \c@th@@ks{}%Once per box is enough!
 \s@tsb@rwidth
 \trace{e}{startESB \the\dimen1}%
 \kill@PossParamCache
 \global\sb@rchunkh@ight=\maxdimen
 \getsbp@ram{break}\ifx\cp@ram\relax\else \if\cp@ram F\else
   \ifx\cp@ram\tr@e
     \global\sb@rchunkh@ight=0.2\textheight
   \else
     \global\sb@rchunkh@ight=\cp@ram\textheight
   \fi
   \floatingpenalty=500\insertpenalties=0
 \fi\fi
 %\egroup\setbox\extb@x\vbox\bgroup
 \getsbp@ram{fgfigspec}\ifx\cp@ram\relax\else\x@\fig \cp@ram\fig*\fi
}
\def\sb@rb@x{sidebarBox}%one word
\def\tr@e{T}
\def\false{F}

\newbox\b@rderbox
\def\mkb@rder#1{%Put a border around a box
  \x@\setbox\x@\b@rderbox\x@\box#1
  \tempfalse\t@mpfalse
  \ifx\b@drleft\tr@e\temptrue\trace{eb}{Border: left}\fi
  \ifx\b@drright\tr@e\temptrue\trace{eb}{Border: right}\fi
  \ifx\b@drtop\tr@e\temptrue\t@mptrue\trace{eb}{Border: Top}\fi
  \ifx\b@drbottom\tr@e\temptrue\t@mptrue\trace{eb}{Border: Bottom}\fi
  \def\v@dj{0pt}%
  \iftemp\def\v@dj{\fb@vpadding}\fi
  \dimen0=\fb@vpadding
  \dimen1=0pt % should include padding already
  \advance\dimen0 by \ht\b@rderbox
  \advance\dimen1 by \dp\b@rderbox
  \iftemp % if ANY border, add horizontal padding and any vertical lines
    \setbox\b@rderbox\vbox{%
      \hbox{\ifx\b@drleft\tr@e\trace{eb}{Drawing Border:left}%
         \vrule width \b@drwidth\FontSizeUnit height \dimen0 depth \dimen1
       \else
         \vrule width 0pt height \dimen0 depth \dimen1 %Strut to sort out vertical padding
       \fi
       \hskip \fb@hpadding
       \box\b@rderbox
       \hskip \fb@hpadding
       \ifx\b@drright\tr@e \trace{eb}{Drawing Border: right}%
         \vrule width \b@drwidth\FontSizeUnit height \dimen0 depth \dimen1 
       \fi}%
     }%
  \fi
  \dimen4=-\b@drwidth\FontSizeUnit
  \ifdim\dimen4< -0.1\baselineskip
    \advance\dimen4 by \baselineskip
  \fi
  \edef\b@xadj{\the\dimen4}%
  \advance \dimen4 by -\dimen1
  \ifdim\dimen4< -0.1\baselineskip
    \advance\dimen4 by \baselineskip
  \fi
  \trace{eb}{Border box: \the\ht\b@rderbox+\the\dp\b@rderbox, bdr:\b@drwidth , \the\dimen4, \the \dimen0}%
  \ift@mp %Horizontal lines
    \edef\b@xw@dth{\the\wd\b@rderbox}%
    \dimen0=\ht\b@rderbox
    \advance\dimen0 by \dp\b@rderbox
    \advance\dimen0 by \b@drwidth\FontSizeUnit
    \advance\dimen0 by \b@drwidth\FontSizeUnit
    \setbox\b@rderbox\vbox{\baselineskip=0pt%
      \ifx\b@drtop\tr@e\vskip\b@xadj\trace{eb}{Drawing Border:top}\hbox{\vrule height\b@drwidth\FontSizeUnit width \b@xw@dth}\fi%
      \unvbox\b@rderbox
      \ifx\b@drbottom\tr@e\trace{eb}{Drawing Border:bottom}\hbox{\vrule depth\b@drwidth\FontSizeUnit width \b@xw@dth}\vskip\dimen4\fi
    }%
    %\nonstopmode
    %\showbox\b@rderbox
  \fi
  \x@\setbox#1\box\b@rderbox
}

\def\@sbe{%
  \ifhe@dings\endhe@dings\fi
  \relax
  \ifinextended
   \end@llpoppedstyles{\ss@Sbar*}% May also close groups
   \kill@PossParamCache
   \ifhmode\par\fi
   \global\let\c@t@gory=\c@tegory\egroup 
  \else\global\let\c@t@gory=\empty \trace{e}{\\ebse called without \\esb}%
  \fi
  \trace{e}{ESBE \the\sb@rchunkh@ight}%
  \let\c@tegory=\c@t@gory %recover value from box, without making global changes.
  \s@tc@tpr@fix
  \trace{e}{ESBE \c@tprefix}%
  \inextendedfalse
  \let\s@vedvpadding=\fb@vpadding%
  \getsbp@ram{bgfigspec}\let\bgf@gsp@c\cp@ram
  \getsbp@ram{bgfiglow}\let\bgf@gl@w\cp@ram%
  \getsbp@ram{hascol}\let\h@scol\cp@ram%
  \getsbp@ram{\ifodd\pageno borderoddleft\else borderevenleft\fi}\let\b@drleft\cp@ram
  \getsbp@ram{\ifodd\pageno borderoddright\else borderevenright\fi}\let\b@drright\cp@ram
  \getsbp@ram{bordertop}\let\b@drtop\cp@ram
  \getsbp@ram{borderbottom}\let\b@drbottom\cp@ram 
  \getsbp@ram{borderwidth}\let\b@drwidth\cp@ram
  \tempfalse
  \ifx\bgf@gsp@c\relax\else
    \if\bgf@gl@w F
      \temptrue
    \fi
    \if\h@scol F
      \temptrue
    \fi
  \fi
  \ifx\bgf@gsp@c\relax\else % Background images and page-broken chunks are incompatible 
    \sb@rchunkh@ight=\maxdimen
  \fi
  \iftemp
    %modify the esbbox to include the picture
    \setbox\extb@x\vbox to \ht\extb@x{\vbox to 0pt{\vbox to\ht\extb@x{\vfil\d@figure{\bgf@gsp@c}\vfil}\vss}\extb@x}%
    \let\bgf@gsp@c\relax %used it, so if it's still there later, we need to use it.
  \fi
  \let\w@tsit\sb@rb@x % Make sure the item is identified properly - used in debugging and .delayed file
  \let\loc@ption\sb@rpos
  \picUsesInstrue
  \x@\p@rsePicUse\loc@ption\end  %set loc@ption and discover if there's to be an insert. (sets \picUsesInsfalse if not)
  \ifx\h@scol\tr@e
    \getsbp@ram{alpha}\global\let\pdf@lpha=\cp@ram
    \getsbp@ram{bgcolour}\let\pdfBGc@l=\cp@ram
  \fi
  \loop %Breakable box:
    \ifdim\ht\extb@x>\sb@rchunkh@ight % to enable page splitting, the box should be chunked.
      \dimen1=\sb@rchunkh@ight
      {% 
        \loop
          \setbox2=\copy\extb@x
          \global\setbox\extchunkb@x=\vsplit\extb@x to \dimen1
          \ifnum\badness>999999
            \setbox\extb@x=\box2
            \advance\dimen1 by \baselineskip %Couldnt split, make the chunk bigger.
            \trace{e}{Chunk grown to \the\dimen1}%
        \repeat
      }%
      \setbox\extchunkb@x=\vbox{\unvbox\extchunkb@x}% Reset to natural size
      \ifvoid\extb@x\else \dp\extchunkb@x=0pt\fi
    \else
      \setbox\extchunkb@x=\box\extb@x
      \let\fb@vpadding=\s@vedvpadding
    \fi
    \trace{e}{Chunk of extbox is \the\ht\extchunkb@x+\the\dp\extchunkb@x (\the\ht\extb@x)}%
    \ifx\h@scol\tr@e
      \setbox\extchunkb@x\vbox{%
       \ifx\bgf@gsp@c\relax\else\vbox to 0pt{\vbox to\ht\extchunkb@x{\vfil\d@figure{\bgf@gsp@c}\vfil}\vss}\fi
       % \vskip\baselineskip
       \feintbox{\pdf@lpha}{\pdfBGc@l}{\box\extchunkb@x}}%
       \trace{e}{Chunk is (with box) \the\ht\extchunkb@x+\the\dp\extchunkb@x}%
    \fi
    \mkb@rder{\extchunkb@x}%
    \trace{e}{Chunk is  now \the\ht\extchunkb@x+\the\dp\extchunkb@x}%
    \x@\let\x@\@xtins\csname ins-\loc@ption\endcsname
    \ifpicUsesIns
      \trace{e}{using ins-\loc@ption}%
      \insert\@xtins{%\vskip\baselineskip
	    \vskip-\v@dj
        \dimen0=\dp\extchunkb@x
        \penalty10000\box\extchunkb@x\vskip-\the\dimen0}%
    \else
      \ifx\picl@c\empty
        \message{Could not interpret position \loc@ption for \c@tegory:\sb@rmarker}%
      \else
        \dimen0=\ht\extchunkb@x \advance\dimen0 by \dp\extchunkb@x \advance\dimen0 by 0.5\baselineskip % Rounding correction
        \divide\dimen0 by \baselineskip \count255=\dimen0
        \advance\count255 by 1
        \trace{g}{Inline \w@tsit takes \the\count255 lines}%
        \ifx\picl@c\loc@Inl
	  %\vskip -\lastdepth
	      \ifx\h@scol\tr@e
	        \ifdim\lastdepth>0.2pt\vskip\baselineskip\fi%
	      \fi
	      \d@figureInl\extchunkb@x
	    \fi
        \ifx\picl@c\loc@Par
  	      \d@figurePar\extchunkb@x
  	    \fi
        \ifx\picl@c\loc@Page
          \d@figurePage\extchunkb@x
        \fi
        \ifx\picl@c\loc@Full
          \d@figureFull\extchunkb@x
        \fi
        \ifx\picl@c\loc@Cut
          \penalty 3
          \d@figureCut\extchunkb@x
          %\ifhmode |+\fi
        \fi
        \ifvoid\extchunkb@x\else
          \message{Could not understand / interpret position \loc@ption for \c@tegory:\sb@rmarker}%
        \fi
      \fi
    \fi
    \ifdim\ht\extb@x>0pt
      \def\fb@vpadding{0pt}%
  \repeat
  \let\c@tegory\oldc@tegory 
  \s@tc@tpr@fix
  \ifvoid\sid@barnotes\else
    \unvbox\sid@barnotes
  \fi
  \kill@PossParamCache
  %\ifhmode +\fi
}

% Category file parsing 
\def\Category   #1\relax{%Store name of current category and defaults
  \S@tCat{#1}%
  \xdef\m@rker{esb}%
  \initc@t
}
\def\initc@t{
  \ifx\c@tprefix\empty
    \edef\t@stname{\m@rker\ds@ffix:is_defined}%
  \else 
    \edef\t@stname{\c@tprefix \m@rker\ds@ffix:is_defined}%
  \fi
  \x@\xdef\csname m@rkerexists-\c@tprefix\m@rker\endcsname{t}%
  \x@\let\x@\t@st\csname \t@stname\endcsname
  \ifx\t@st\relax 
    \trace{e}{First definition of \c@tprefix\m@rker\ds@ffix}%
    \x@\xdef\csname \t@stname\endcsname{Done}%
  \fi
}
\def\Position   #1\relax{\initc@t\setsbp@ram{posn}{#1}}% Where does it go on the page? (like figures, but also B for below notes)
\def\Scale      #1\relax{\initc@t\setsbp@ram{scale}{#1}}% Where does it go on the page? (like figures, but also B for below notes)
\def\Breakable   #1\relax{\initc@t\tempfalse\setbox0\hbox{\ifcat 1#1 \global\temptrue\fi}\iftemp\setsbp@ram{break}{#1}\else\setsbp@ram{break}{\uppercase{#1}}\fi} %Can the box page-break?
\def\FgImage      #1\relax{\initc@t\setsbp@ram{fgfigname}{#1}\GenC@tFig{fg}}
\def\FgImagePos   #1\relax{\initc@t\setsbp@ram{fgfigpos}{#1}\GenC@tFig{fg}}
\def\FgImageScale   #1\relax{\initc@t\setsbp@ram{fgfigscale}{#1}\GenC@tFig{fg}}
\def\BgImage      #1\relax{\initc@t\setsbp@ram{bgfigname}{#1}\GenC@tFig{bg}}
\def\BgImageScale   #1\relax{\initc@t\setsbp@ram{bgfigscale}{#1}\GenC@tFig{bg}}
\def\BgImageLow   #1\relax{\initc@t\setsbp@ram{bgfiglow}{\uppercase{#1}}}% What's the right sequence for colour layer and background image

\def\BgColour   #1\relax{\initc@t\tempfalse\uppercase{\edef\t@st{#1}}\setbox0\hbox{\if F\t@st \global\temptrue\trace{e}{Cancelling colour}\else\if\tr@e\t@st\global\temptrue\fi\fi}\iftemp\setsbp@ram{hascol}{\t@st}\else\setsbp@ram{hascol}{T}\setsbp@ram{bgcolour}{#1}\fi}%For British/Australian/NZ/etc.
\let\BgColor\BgColour%For Americans
\def\Alpha   #1\relax{\initc@t\setsbp@ram{alpha}{#1}}% 1=solid 0=invisible
\def\BorderWidth        #1\relax{\initc@t\setsbp@ram{borderwidth}{#1}}
\def\BorderColour       #1\relax{\initc@t\setsbp@ram{bordercolour}{#1}}
\let\BorderColor=\BorderColour%for Americans
\def\Border	#1\relax{\initc@t\x@\p@rseBorder#1 \relax \relax}

\def\GenC@tFig#1{
 \getsbp@ram{#1figname}\ifx\cp@ram\relax\let\cp@ram\empty\fi\ifx\cp@ram\empty\else
   \let\c@tfigname\cp@ram
   \getsbp@ram{#1figsize}%
 \fi
}
\def\EndCategory{\gdef\c@tegory{}\global\let\c@tprefix\empty}

\def\S@tCat#1{\trace{sc}{Started Category #1}%
  \gdef\c@tegory{#1}%
  \s@tc@tpr@fix%
}
\def\showTheCategory{\c@tegory\message{The category is \c@tegory}}

\def\StyleCategory#1#2{\S@tCat{#1}#2\EndCategory}
\def\categorysheet#1{%Just wrap \stylesheet with category-blanking commands
  \subc@lltrue
  \EndCategory\stylesheet{#1}\EndCategory
  \subc@llfalse
}
\def\B@rderTOP{\setsbp@ram{bordertop}{T}}
\def\B@rderBOTTOM{\setsbp@ram{borderbottom}{T}}
\def\B@rderLEFT{\setsbp@ram{borderoddleft}{T}\setsbp@ram{borderevenleft}{T}}
\def\B@rderRIGHT{\setsbp@ram{borderoddright}{T}\setsbp@ram{borderevenright}{T}}
\def\B@rderINNER{\ifBookOpenLeft\setsbp@ram{borderoddright}{T}\setsbp@ram{borderevenleft}{T}\else\setsbp@ram{borderoddleft}{T}\setsbp@ram{borderevenright}{T}\fi}
\def\B@rderOUTER{\ifBookOpenLeft\setsbp@ram{borderoddleft}{T}\setsbp@ram{borderevenright}{T}\else\setsbp@ram{borderoddright}{T}\setsbp@ram{borderevenleft}{T}\fi}
\def\B@rderALL{\setsbp@ram{borderoddleft}{T}\setsbp@ram{borderevenleft}{T}\setsbp@ram{borderoddright}{T}\setsbp@ram{borderevenright}{T}\setsbp@ram{bordertop}{T}\setsbp@ram{borderbottom}{T}}
\def\B@rderNone{\setsbp@ram{borderoddleft}{F}\setsbp@ram{borderevenleft}{F}\setsbp@ram{borderoddright}{F}\setsbp@ram{borderevenright}{F}\setsbp@ram{bordertop}{F}\setsbp@ram{borderbottom}{F}}

\addtoinithooks{\let\@SB=\esb\let\@SBE=\esbe \let\esb=\@sb\let\esbe=\@sbe}

