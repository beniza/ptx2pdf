% This TeX code provides a way to have marginal verses
% Caution, it is still under heavy development


%+cmargin_verse
\catcode`\@=11
%\let\myoldv=\v
%\newif\multipleverses
\newtoks\myeverypar
\newdimen\mybaseline
\newif\ifmarginverseleft
\def\marginv@rseleft{\marginverselefttrue
  %\ifnum\c@rrentcols=1\ifodd\pageno\marginverseleftfalse\fi\fi
}
{\catcode`\~=12 \lccode`\~=32 \catcode`\*=12 \lowercase{%
\gdef\marginverse #1 {%
    \gdef\v@rse{#1}\xdef\print@bleVerse{#1}%
    \the\prev@rsehooks\spl@tprintableverse
    \global\setbox2\hbox{\ifc@ncelfirstverse\else\ch@rstylepls{v}~\printv@rse\ch@rstylepls{v}*\fi}%
    \egroup\str@t\dimen0=\ht2\advance\dimen0 by \dp\str@tbox
    \myeverypar=\everypar\everypar={}%
    \dimen1=\columnshift\advance\dimen1 by -\AfterVerseSpaceFactor\FontSizeUnit
    \m@rkverse \the\v@rsehooks \gdef\reference{\ch@pter:\v@rse}%
    \getp@ram{baseline}{v}\ifx\p@ram\relax\let\p@ram\baselineskip\fi
    \vadjust{\kern -\dimen0\marginv@rseleft
      \ifmarginverseleft
        \setbox1=\vbox{\llap{\vbox{\leftskip=0pt plus 1fill %
            \rightskip=\z@skip\hsize=\dimen1 \baselineskip=\p@ram
            \trace{v}{LMarginal Verse (\print@bleVerse): hs=\the\hsize , bl=\the\baselineskip, wd=\the\wd2}%
            \noindent \unhbox2 \marginremovehboxes}%
          \kern\AfterVerseSpaceFactor\FontSizeUnit}}%
      \else
        \setbox1=\vbox{\hfill\rlap{\kern\AfterVerseSpaceFactor\FontSizeUnit
          \vbox{\rightskip=0pt plus 1fill %
            \leftskip=\z@skip\hsize=\dimen1 \baselineskip=\p@ram
            \trace{v}{RMarginal Verse (\print@bleVerse): hs=\the\hsize , bl=\the\baselineskip, wd=\the\wd2}%
            \noindent \unhbox2 \marginremovehboxes}}}%
      \fi
      \ht1=\dimen0\dp1=0pt\tracingparagraphs=0
      \trace{v}{\reference - tolerance=\the\tolerance}\box1
    }\nobreak
    %\m@rkverse % generate a milestone for running headers
    % run the hooks for picture insertion, paragraph adjustments, etc.
    % these hooks were added via \addtoversehooks
    %\the\v@rsehooks
    % remember current chapter:verse, not currently used. Could potentially be used
    % to insert chapter:verse in footnotes.
    %\gdef\reference{\ch@pter:\v@rse}%
    \nobreak\hskip 1sp% *%
    \everypar=\myeverypar}}}

\gdef\marginremovehboxes{%
  \setbox0=\lastbox 
  \ifhbox0{\removehboxes}\unhbox0\fi}
%-cmargin_verse

%+cmargin_init
\def\myv{%
    \ifvmode\xdef\prev@rsemode{\m@rker}\else\global\let\prev@rsemode\empty\fi
    \leavevmode\c@ncelfirstversefalse
    \ifnum\spacefactor=\n@wchaptersf \kern0sp %
     \ifOmitVerseNumberOne \c@ncelfirstversetrue \fi\fi
    \bgroup\marginverse} % ensure we are in horizontal mode to build paragraph
\def\initmyverse{\let\myoldv=\@V\let\v=\myv}
%\def\initmyverse{\let\v=\myv}
\addtoinithooks{\initmyverse}%
\let\printv@rse=\hangprintv@rse
%-cmargin_init
\endinput
