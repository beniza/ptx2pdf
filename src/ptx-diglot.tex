% ptx-diglot.tex: Diglot processing for xetex paratext2.tex
%
\newcount\diglotTRcount%
\newcount\diglotDbgJoinboxes%
\diglotDbgJoinboxes=-1% Set to the debug message of a joinboxes to execute showbox on that join

%\def\TRshipout#1{\shipout#1}
\def\TRshipout#1{}
\def\b@xbotmark{}
% THis is a crude hack to make main titles line up nicely. For some reason
% they seem to already be vtops with depth info lost. 
%
\def\dstrut#1{{\setbox0\hbox{#1}\hbox{\vrule height \ht0 depth \dp0 width 0pt}}}
%
%
\newif\ifLeftMarks%
\LeftMarkstrue
\newif\ifVisTrace% Show lines where boxes are joined. 
\VisTracefalse%
\def\oldRmark{}
\def\p@gebotmark{}
\def\doTRACEdiglot#1{\global\advance\diglotTRcount by 1 \MSG{\the\diglotTRcount: #1}}%
\def\noTRACEdiglot#1{\relax}%
\let\TRACEdiglot=\noTRACEdiglot%
\newif\ifdiglot %If there is diglot material
\def\setsid@{\ifdiglotL\xdef\sid@{L}\else\xdef\sid@{R}\fi}
%
\diglotfalse%
\newif\ifdiglotSepNotes %If the footnotes from the versions should be split (true) or merged together
\diglotSepNotestrue%
\newif\ifdiglotBalNotes %If a left column footnote steals space from the right column also
\diglotBalNotesfalse%
\global\def\n@xtc@mmand{}%

%\partial % fully set Partial page (both columns)
\newbox\partialL \setbox\partialL=\vbox{} % Partial page, on the left side
\newbox\excessL \setbox\excessL=\vbox{} % Excess left material, once we know we're on the next page (added to partialL on shipout)
\newbox\excessR \setbox\excessR=\vbox{} % Excess right material, once we know we're on the next page 
\newbox\partialR \setbox\partialR=\vbox{} % Partial page on the right side

%\newbox\partialPage \setbox\partialPage=\vbox{}
%\diglotLeft={\hsize=\columnLwidth\global\setbox\partialL=\vbox{\unvbox\partialL\unvbox255}}

\newif\ifrunLtrial % logic test in diglotLeft
\newif\ifintrial %flag to let setbox know...

% Not \c@lcavailht from paratext2.tex
\def\calc@vailht{%
   \ifdiglotL%
     \TRACEdiglot{calc@vailht L}%
   \else%
     \TRACEdiglot{calc@vailht R}%
   \fi%
   \global\availht=\textheight %
   \global\advance\availht by \adjustp@ge % Panic measure..
   \global\advance\availht by -\ht\partial %
   \global\advance\availht by -\dp\partial %
   \let\\=\reduceavailht \the\n@tecl@sses % reduce it by the space needed for each note class
   \decr{\availht}{\topins}%pictures
   \ifdim\ht\topleftins>\ht\toprightins %
     \decr{\availht}{\topleftins}%
   \else%
     \decr{\availht}{\toprightins}%
   \fi%
   \ifdim\ht\bottomleftins>\ht\bottomrightins %
     \decr{\availht}{\bottomleftins}%
   \else%
     \decr{\availht}{\bottomrightins}%
   \fi%
   \decr{\availht}{\bottomins}%
   \ifdiglotL%
     \global\availhtL=\availht %
   \else%
     \global\availhtR=\availht %
   \fi%
   \TRACEdiglot{...\the\availht}%
}
\newif\ifnastybox  % Signal that box must be treated specially
\newif\ifrepeatok  % Signal that an unusual calling sequence has happend
\newif\ifearlyLrefill % In some circumstances partialL is empty deliberatly, other times it isn't
\repeatoktrue

\newcount\savedpenalty% The \lastpenalty before a \lefttext or \righttext issues a fake one, or similarly penalty to apply at end of trial text, and scratch space
\newcount\tmppenalty%scratchspace
\newcount\Lchunkpenalty% The penalty that should be applied at the end of the L text, according to the first output routine
\newcount\Lboxpenalty% The penalty that goes between LeftBox and partialL
\newcount\partialLpenalty% The penalty that goes between partialL and excessL
\newcount\Rchunkpenalty%
\newcount\Rboxpenalty% The penalty that goes between RightBox and partialR
\newcount\partialRpenalty% The penalty that goes between partialR and excessR

\newcount\lastsavedLpenalty% The penalty for page breaks at the \partial / new boundary
\newcount\lastsavedRpenalty%
\newif\ifLneedsemptying
% Initial \output routine for left scripture
\def\diglotLeft{% 
 %This gets called every time that there's new material that the computer thinks
 %fills the rest of the page with text - maybe multiple times - and also on
 %a column switch.
 % It should put the text into different boxes, depending on how much text
 % we have relative to the space available. It should also re-run the text
 % through TeX  to apply footnotes, but ONLY those portions of text that will
 % really fit on this page.
 % assumes: \availht is correct, \ifleftfull set false on page output
 % Fills: \partialL, \excessL
 % Empties: \box255
 \TRACEdiglot{diglotLeft O:\the\outputpenalty, P:\the\savedpenalty, LP:\the\lastsavedLpenalty, vs:\the\vsize, pg:\the\pagegoal, pt:\the\pagetotal, bs:\the\baselineskip, ilp:\the\interlinepenalty }%
 \runLtrialfalse%
 \makevtop{255}%
 \tmppenalty=\outputpenalty %
 \ifnum\outputpenalty=10000% Nothing wrong with breaking here
   \tmppenalty=0\relax%
    \Lneedsemptyingfalse%
 \else%
   \ifnum\outputpenalty=-10001%Got to the end of the \lefttext
     \tmppenalty=\savedpenalty\relax%
     \Lneedsemptyingtrue%
   \fi%
 \fi%
 \ifleftfull%
   \TRACEdiglot{left is full already, adding extra (\the\ht255+\the\dp255) mtl to end of excessL (\the\ht\excessL+\the\dp\excessL)}
   %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeft -> excessL:}\copy255}}
   \global\setbox\excessL=\vtop{\joinboxes{\excessL}{255}{1}{\Lchunkpenalty}}%
   \global\Lchunkpenalty=\tmppenalty %
   %\shipout\copy\excessL
   %\showbox\excessL
   \global\vsize=\textheight
   %Text in partialL has already be re-processed. 
 \else%
   \TRACEdiglot{adding mtl (\the\ht255+\the\dp255) to partialL pl:\the\ht\partialL, av:\the\availht}%
   %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeft -> partialL:}\copy255}}%
   \global\setbox\partialL=\vtop{\joinboxes{\partialL}{255}{2}{\partialLpenalty}}%
   \global\partialLpenalty=\tmppenalty %
   \TRACEdiglot{pL: (\the\ht\partialL+\the\dp\partialL), av:\the\availht, p:(\the\ht\partial+\the\dp\partial), vs:\the\vsize}%
   \global\nastyboxfalse
   %No more uses for original tmppenalty, can use it here for the penalty that starts the next box if we're splitting.
   \tmppenalty=\lastsavedLpenalty\ifnum\lastsavedRpenalty>\tmppenalty \tmppenalty=\lastsavedRpenalty \fi%
   %\bgroup%
   \dimen0=\availht %
   \dimen1=0pt % Use ifnastybox as a flag that the box should be split to dimen1, unless it stays 0pt in which case pass it on to the next page
   \ifnum\partialLpenalty=10000 %This place must not be the last on the page. How nasty is that?
     \TRACEdiglot{Checking what to do with this box}
     \advance\dimen0 by -\ht\partialL %
     \advance\dimen0 by -\dp\partialL %
     \ifdim\dimen0>-0.3\baselineskip % The box fits..
        \TRACEdiglot{box itself fits}
        \dimen1=\availht%Default: put it on the page
        \ifdim\dimen0<2\baselineskip %
          \TRACEdiglot{...without enough space after}
	  \global\nastyboxtrue %only just fits. Very nasty - no space for even another line after this one. 
	  %{\showboxbreadth=13\nonstopmode\showbox\partialL}
	  \ifdim\dp\partialL>3\baselineskip
	    %this box is of reasonable size, split it earlier?
	    \dimen1=\ht\partialL
	    \advance\dimen1 by \dp\partialL
	    \advance\dimen1 by -1\baselineskip
	  \else
	    %It is small. Probably a heading, best to promote it to next page.
	    \dimen1=0pt
            \ifnum\tmppenalty>10000
	      %But on the other hand we can't put it on the next page
	      %so try splitting it after all
	      \global\nastyboxfalse %only just fits. Very nasty - no space for even another line after this one. 
	      \TRACEdiglot{Box must not move on to next page} \dimen1=\ht\partialL
	      \global\advance\adjustp@ge by 1\baselineskip
	      \global\advance\availht by 1\baselineskip
	      \advance\dimen1 by \dp\partialL
	      \advance\dimen1 by -1\baselineskip
	    \fi
	  \fi
	\fi%
     \else % Box is too big to fit
	\ifdim\dp\partialL>3\baselineskip
	  %this box is of reasonable size, just split it
	  \dimen1=\availht
	\else
	  %It is small. Probably a heading, best to promote it 
	  \global\nastyboxtrue
	  \dimen1=0pt
          \ifnum\lastsavedLpenalty=10000
	    %But on the other hand we can't put it on the next page
	    %so try splitting it after all
	    \dimen1=\ht\partialL
	    \advance\dimen1 by \dp\partialL
	    \advance\dimen1 by -1\baselineskip
	  \fi
	\fi
     \fi
   \fi


   \ifdim \dimen1<0pt
     \dimen1=0pt
     \global\leftfulltrue
   \fi
   \ifnastybox% 
     \TRACEdiglot{Nasty box \the\ht\partialL+\the\dp\partialL, resizing to \the\dimen1, somewhere near \the\inputlineno, \botmark}
   \else
     \dimen0=\availht
     \advance\dimen0 by -\ht\partialL
     \advance\dimen0 by -\dp\partialL
     \dimen1=\availht %Cutting length...
     \ifdim \dimen1<0pt
       \dimen1=0pt
       \global\leftfulltrue%
     \fi
     \ifdim\dimen0<0pt %might cut
       \ifdim\dimen0>-0.3\baselineskip %Tiny overshoot
	 \advance\dimen1 by \baselineskip %ignore it.
       \else
	 \TRACEdiglot{Oversized box \the\ht\partialL+\the\dp\partialL, resizing to \the\dimen1, (\the\dimen0) somewhere near \the\inputlineno, \botmark}
       \fi
     \fi
   \fi
   %\leftfull is set, so Nastybox won't get touched until the page is output. Therefore use
   % it to tell code below that we've moved everything to the next page.
   \global\nastyboxfalse 
   \TempDim=\dimen1% dimen1 is size of the box to fit into
   \advance\TempDim by -\dp\partialL %TempDim is how much space would be left over
   % altered test, 2015.jul.15 - we must not skip if it's a nastybox
   \ifdim\TempDim<-0.0\baselineskip% Only split for significant amounts...
     %Want the first chunk in partialL, the residue in excessL, so vsplit
     %gets it backwards for us.
     %Use box0 as a temporary store
     \ifdim\dimen1>\baselineskip % was 0pt
       %\bgroup%
       \dimen2=\dp\partialL% compare original size...
       \TRACEdiglot{Splitting to \the\dimen1}%
       %{\tracingonline=0\showbox\partialL}%
       %\setbox\partialL=\vbox{\penalty\tmppenalty\unvbox\partialL}%
       \setbox0=\vsplit\partialL to \dimen1%
       \setbox0=\vtop{\unvbox0}
       \global\runLtrialtrue%
       \global\leftfulltrue%
       \TempDim=\ht0
       \advance\TempDim by \dp0
       \ifdim\TempDim>0pt % It split something off..
	 \TRACEdiglot{spare material to excessL (\the\ht0, \the\dp0, \the\ht\partialL,\the\ht\excessL,\the\dp\partialL,\the\dp\excessL}%
	 %\showbox\excessL%
	 \global\earlyLrefilltrue%
	 \global\setbox\excessL=\vtop{\joinboxes{\partialL}{\excessL}{4}{\partialLpenalty}}%
	 \global\setbox\partialL=\box0
	 \global\partialLpenalty=0
       \else %The whole lot got left in partialL- potential problem
	 \ifnum\tmppenalty>9999 % honour the penalty, pay the price...
	   \TRACEdiglot{No material split off, but must leave box on page. \the\ht0+\the\dp0, \the\ht\partialL+\the\dp\partialL, \the\ht\excessL+\the\dp\excessL}%
	   %\showbox\partialL%
	   \global\setbox\partialL=\vtop{\unvbox\partialL}
	   \global\partialLpenalty=0
	   \global\runLtrialtrue%
	 \else
	   \TRACEdiglot{No material split off. Leaving box unchanged and pushing onward (\the\ht0+\the\dp0, \the\ht\partialL+\the\dp\partialL, \the\ht\excessL+\the\dp\excessL.. \the\tmppenalty)}%
	   \global\setbox\partialL=\vtop{\unvbox\partialL}
	   %\makevtop{\partialL}%
	   \global\runLtrialfalse% Don't add this box
	   \global\availht=0pt
	   \global\nastyboxtrue% Signal to rightbox that the box has moved
	 \fi
       \fi
       %\egroup
     \else
       \global\setbox\LeftBox=\vbox to \availht{\vfil}%
       \global\Lboxpenalty=0
       \global\availht=0pt
       %\global\setbox\excessL=\vtop{\joinboxes{\partialL}{\excessL}{5}}
       \global\runLtrialfalse%Don't add this text, leave it in partialL
       \global\leftfulltrue%
       \global\nastyboxtrue% Signal to rightbox that the box has moved
     \fi
   \else
     \global\runLtrialtrue%
   \fi%
   %\egroup
   \ifnum\outputpenalty=-10000
     %Must relase footnotes, this is end of page.
     \runLtrialtrue%
     \global\leftfulltrue%
   \fi%
   \ifnum\outputpenalty=-10001
     %Must release footnotes, this section of page is about to be committed
     \runLtrialtrue%
   \fi%
   \ifdim\dp\partialL=0pt
     %No point in releasing footnotes on an empty chunk
     \runLtrialfalse%
   \fi%
   \ifdim\availht=0pt
     %If there's no space (or the box has been postponed), don't add anything
     \runLtrialfalse%
   \fi%
 \fi%
 \ifrunLtrial %Apply inserts.
   \ifnum\holdinginserts=0
     \TRACEdiglot{Inserts not held (!?) will not re-run}%
   \else%
     \global\holdinginserts=0
     \TRACEdiglot{Re-processing partialL (\the\ht\partialL, \the\availht)}%
     \global\trialheight=\availht
     \doDiglotLeftTrial%
   \fi%
 \else
   \ifnastybox %THis box is forcing a page break before itself. Therefore do that pagebreak 
     \TRACEdiglot{Box must start page, forcing page output.  digl@t\ifdigl@tL L\else R\fi}
     \global\nastyboxfalse
     \global\repeatokfalse
     \global\pagefulltrue
     \global\setbox\RightBox=\box\voidb@x%
     \upd@tep@rtial%
   \fi
 \fi%
} %



\newif\ifboxmoved%
\def\diglotLeftTrial{%
% Secondary left hand \output routine.
% Should normally get called once per box when that's about to be set. Puts set
% material in LeftBox. If material (e.g. due to footnotes) is too big,
% shrink vsize and try again.
% \LeftBox and \partialL are empty
  \TRACEdiglot{diglotLeftTrial, \the\holdinginserts, Op:\the\outputpenalty,
  LP:\the\lastsavedLpenalty, LBP:\the\Lboxpenalty, PLP:\the\partialLpenalty,  DCyc:\the\deadcycles, LB:\the\ht\LeftBox+\the\dp\LeftBox, av:\the\availht, vs:\the\vsize, pg:\the\pagegoal}%
  \makevtop{255}% NB: If box255 does need to go through makevtop, then when the box is unzipped to try again, the kerns would need removing somehow.
  \global\setbox\LeftBox=\vtop{\unvbox 255}
  \tmppenalty=\outputpenalty %
  \ifnum\tmppenalty=10000 %
    \tmppenalty=0 %
  \fi
  \ifLeftMarks%
    \edef\t@st{\botmark}%
    \ifx\t@st\empty%
      \TRACEdiglot{Bottom mark was empty}%
    \else%
      \TRACEdiglot{oldRmark: \oldRmark, firstmark: \firstmark, botmark: \botmark}
      \edef\t@st{\firstmark}
      \ifx\t@st\oldRmark\else%
        \TRACEdiglot{Setting (default) bottom mark to \botmark, may revise later}%
	\xdef\b@xbotmark{\botmark}%
	\edef\t@st{\p@gefirstmark}%
	\ifx\t@st\empty%
	  \xdef\p@gefirstmark{\firstmark}%
	\fi%
      \fi% remember first, if not already set
    \fi% botmark empty or not
  \fi% LeftMarks

  %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeftTrial:}\copy\LeftBox}}%
  \TRACEdiglot{Box=\the\ht\LeftBox+\the\dp\LeftBox}%
  \ifnum\holdinginserts=0 %
    \global\deadcycles=0 %
    \global\holdinginserts=1 % inserts inactive again
    %Footnotes may have been added that fill up the available space even if
    %it wasn't full before - recalculate.
    \calc@vailht%
  \fi%
  \TempDim=\availht %
  \boxmovedfalse%
  \advance\TempDim by -\the\ht\LeftBox %
  \advance\TempDim by -\the\dp\LeftBox %
  \TRACEdiglot{av: \the\availht, remaing:\the\TempDim, bs:\the\baselineskip}
  \ifdim\trialheight<\baselineskip %It's not going to work, give up somehow
    \TRACEdiglot{Box will not fit. td:\the\TempDim lb:\the\ht\LeftBox+\the\dp\LeftBox}
    \ifdim\TempDim<-1.5\baselineskip % better move it onto next page.
      \TRACEdiglot{Box size means it moves}
      \ifnum\lastsavedLpenalty=10000 %
        \MSG{Bad column break on \count0}%
      \fi%
      \global\setbox\partialL=\box\LeftBox%
      \boxmovedtrue%
    \fi
    \ifnum\savedpenalty=10000 % it can't stay here
      \TRACEdiglot{Box penalty means it moves}%
      \ifnum\lastsavedLpenalty=10000 %
        \MSG{Bad column break on \count0}%
      \fi%
      \global\setbox\partialL=\box\LeftBox
      \boxmovedtrue%
    \fi%
    \TempDim=0pt % 
  \fi
  \ifdim\TempDim<-0.7\baselineskip % Rerun trial.
    \ifnum\deadcycles=0 
      \TRACEdiglot{Footnotes make left column over full. Trying again}%
    \else%
      \global\advance\trialheight by -\baselineskip
      \TRACEdiglot{Left column still too full. Try again th:\the\trialheight}%
      \global\vsize=\trialheight
    \fi%
    \unvbox\LeftBox\ifdim\lastkern<0pt \unkern\fi%FIXME? Only want to unkern makevtop's kerns.
    \penalty\tmppenalty\relax% tmppenalty might be an end of data or anything else. We put it back as we rerun the trial
  \else% Not rerunning the trial. 
    \ifdim\TempDim<\baselineskip % 
      \global\leftfulltrue%
    \fi
    \ifnum\outputpenalty=-10005 %
      \TRACEdiglot{Final penalty found \the\outputpenalty}%
      \intrialfalse
      \ifx\n@xtc@mmand\empty \TRACEdiglot{no next command set?}
      %\ifboxmoved\setboth\fi
      \fi
      \global\Lboxpenalty=\savedpenalty %
      \global\savedpenalty=0 %
      \n@xtc@mmand %
      \global\def\n@xtc@mmand{} %
      %start returning to processing input..
      \ifdigl@tL%
	\global\output={\diglotLeft}\relax%
      \else%
	\global\output={\diglotRight}%
	\global\diglotLfalse%
	\global\hsize=\columnRwidth
	\global\holdinginserts=0 %
	\calc@vailht%
	\global\vsize=\availhtR%
      \fi%
    \else% 
      \TRACEdiglot{Other penalty found}%
      \global\leftfulltrue% can't fit more here
      \global\Lboxpenalty=\tmppenalty %
      \let\do@nce=\n@xtc@mmand %
      \global\def\n@xtc@mmand{} %
      \do@nce%
      \global\output={\diglotLeftAfterTrial}\relax%
      \relax%
    \fi%
  \fi%
  %\ifboxmoved\global\setbox\LeftBox=\box\partialL\fi
}

\def\diglotLeftAfterTrial{%
  %LeftBox holds a pagefull and should not be touched.
  %partialL is empty first time round, this will be called multiple times until reaching the end marker
  \TRACEdiglot{diglotLeftAfterTrial \the\outputpenalty, \the\deadcycles,
   av:\the\availht, vs:\the\vsize, pg:\the\pagegoal, pt:\the\pagetotal}%
  \makevtop{255}%
  \tmppenalty=\outputpenalty %
  \ifnum\tmppenalty=10000 %
    \tmppenalty=0 %
  \fi
  \ifnum\tmppenalty=-10005 %
    \tmppenalty=\savedpenalty
      \global\savedpenalty=0 %
  \fi
  \ifvoid\partialL%
    \global\setbox\partialL=\box255 %
  \else%
    \global\setbox\partialL=\vtop{\joinboxes{\partialL}{255}{6}{\partialLpenalty}}\relax%
  \fi
  \global\partialLpenalty=\tmppenalty %
  \TRACEdiglot{\the\ht\partialL+\the\dp\partialL}%
  %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotLeftAfterTrial:}\copy\aftertri@lbox}}%
  \ifnum\outputpenalty=-10005\relax%
    \intrialfalse
    \ifdigl@tL%
      \global\output={\diglotLeft}\relax%
    \else%
      \global\output={\diglotRight}\relax%
      \global\holdinginserts=0 %
      \global\diglotRtrue%
      \calc@vailht%
    \fi%
     \n@xtc@mmand%
     \global\def\n@xtc@mmand{}%
  \fi
}


\def\doDiglotLeftTrial{%
  %empties LeftBox and partialL back onto stack, with holdinginserts=0
  \TRACEdiglot{doDiglotLeftTrial LB:\the\ht\LeftBox+\the\dp\LeftBox, pL:(\the\ht\partialL+\the\dp\partialL)}%
  \ifdiglotL%Save current state
    \global\digl@tLtrue%
  \else%
    \global\digl@tLfalse%
    \global\diglotLtrue%
    \global\hsize=\columnLwidth\relax%
  \fi%
  \calc@vailht%
  \TRACEdiglot{av: \the\availht, tr: \the\trialheight}%
  % don't know why it might not be, but...
  \ifdim\availht<\trialheight
  \global\trialheight=\availht
  \fi
  \global\output={\diglotLeftTrial}\relax%
  \global\vsize=\trialheight\relax%
  \global\holdinginserts=0%
  \global\savedpenalty=\partialLpenalty %
  \intrialtrue
  %\bgroup
  \penalty\lastsavedLpenalty\joinboxes{\LeftBox}{\partialL}{10}{\Lboxpenalty}\par\penalty-10005
\relax{\aftergroup\relax}%
}

\def\diglotRightExtra{%
  %Tertiary output routine for right hand side - collect all the extra stuff.
  \TRACEdiglot{diglotRightExtra, \the\outputpenalty, (\the\ht255+\the\dp255) (\the\ht\excessR+\the\dp\excessR) dc:\the\deadcycles }%
  \makevtop{255}%
  \tmppenalty=\outputpenalty %
  \ifnum\tmppenalty=10000 %
    \tmppenalty=0 %
  \fi
  \ifnum\tmppenalty=-10006 %
    \tmppenalty=\savedpenalty
    \global\savedpenalty=0 %
  \fi%
%
  \global\setbox\excessR=\vtop{\joinboxes{\excessR}{255}{3}{\Rchunkpenalty}}%
  \global\Rchunkpenalty=\tmppenalty %
  \ifnum\outputpenalty=-10006%% All OK. drop through to digl@tRight
    \intrialfalse
    %digl@tRight will reset \output
    \setbox255=\box\partialR% digl@tright expects this
    \digl@tRight%
  \fi%
}


\def\diglotRightTrial{%
% Secondary right hand \output routine. 
% assumptions:
  %   \RightBox contains previously set material - don't touch. Really?-FIXME
  %   \partialR has been emptied by doDiglotRightTrial
  %   Box255 holds new data
% Should normally get called once per box when that's about to be set. Leaves set
% material in 255 and calls setboth via digl@tRight.
%If material (e.g. due to footnotes) is too big for page, shrink vsize and try again.
% if not all material was set, hold stuff in \partialR and use \diglotRightExtra to put that into \excessR
  \TRACEdiglot{diglotRightTrial, \the\holdinginserts, \the\outputpenalty, 
  \the\deadcycles, Rb:\the\ht\RIghtBox+\the\dp\RIghtBox, pR:\the\ht\partialR+\the\dp\partialR, av:\the\availht, vs:\the\vsize, pg:\the\pagegoal}%
 \makevtop{255}%
 %\global\setbox\RightBox=\box255
 %\TRshipout{\vbox{\hbox{\the\diglotTRcount diglotRightTrial:}\copy\RightBox}}%
 \TRACEdiglot{Box=\the\ht\LeftBox+\the\dp\LeftBox}%
  \tmppenalty=\outputpenalty %
  \ifnum\tmppenalty=10000 %
    \tmppenalty=0 %
  \fi
  \ifnum\tmppenalty=-10006 %
    \tmppenalty=\savedpenalty
    \global\savedpenalty=0 %
  \fi%
 %\bgroup%
 \ifnum\outputpenalty=-10006 %
    \TRACEdiglot{Final penalty found \the\outputpenalty}%
    \global\TempDim=\the\availht
    {\setbox0=\copy255\setbox1=\vtop{\unvbox0}%
    \global\advance\TempDim by -\dp1}%
    \ifdim\TempDim>-1\baselineskip% All OK. drop through to digl@tRight
     \global\holdinginserts=1 % inserts inactive again
     \aftergroup\digl@tRight
    \else% Not a nice choice by output routine...
     \TRACEdiglot{Shrinking trialsize and trying again}%
     \global\advance\trialheight-\baselineskip
     \global\vsize=\trialheight
     \global\savedpenalty=\tmppenalty %
     \unvbox255%
     \penalty-10006%
     \aftergroup\relax%
    \fi%
  \else%
    \TRACEdiglot{Remembering right hand data, but final penalty not found}%
    \global\deadcycles=0
    \global\partialRpenalty=\tmppenalty %
    \global\holdinginserts=1 % inserts inactive again
    \setbox\partialR=\box255%
    \global\output={\diglotRightExtra}\relax\aftergroup\relax%
  \fi%\egroup%
}

\def\doDiglotRightTrial{%
  % assumptions: called from output routine handler. 
  %   \RightBox contains previously set material - don't touch. FIXME - really?
  %   \partialR contains unset material.
  %\Rchunkpenalty has been set by caller
  %   Box255 holds new data
  %\tmppenalty contains the penalty that goes after box255
  % need to stop holding inserts
  \TRACEdiglot{doDiglotRightTrial RB:\the\ht\RightBox+\the\dp\RightBox, pR:(\the\ht\partialR+\the\dp\partialR) 255:(\the\ht255+\the\dp255)}%
  \ifdiglotL%Save current state
    \global\digl@tLtrue%
    \global\diglotLfalse%
    \global\hsize=\columnRwidth\relax%
  \else%
    \global\digl@tLfalse%
  \fi%
  \calc@vailht%
  \TRACEdiglot{av: \the\availht, tr: \the\trialheight}%
  \global\output={\diglotRightTrial}\relax%
  \global\vsize=\trialheight\relax%
  \global\holdinginserts=0 %
  \global\savedpenalty=\tmppenalty %
  %\bgroup
  \joinboxes{\partialR}{255}{12}{\partialRpenalty}%
  \par\penalty-10006
  %\egroup%
  \relax{\aftergroup\relax}%
}


% Initial \output routine for right scripture
\def\diglotRight{%
 %Assumptions: Called by output routine. box255 is set with new data.
 %\RightBox and \partialR are empty, 
 %Calls appropriate handler based on whether inserts are held or not
 % (traditionally they weren't)
 \TRACEdiglot{diglotRight \the\outputpenalty, \the\savedpenalty, \the\Rchunkpenalty, (\ifnum\holdinginserts=0 Not\fi holding)}%
 \tmppenalty=\outputpenalty %
 \ifnum\outputpenalty=10000\relax% Nothing wrong with breaking here
   \tmppenalty=0 %
   \Rchunkpenalty=\tmppenalty %
 \else%
   \ifnum\outputpenalty=-10001\relax%Got to the end of the \righttext
     \Rchunkpenalty=\savedpenalty %
     \tmppenalty=\savedpenalty %
     \global\savedpenalty=0 %
   \else%
     \ifnum\outputpenalty=-10006\relax%Got to the end of the trialtext. why are we here?
       \tmppenalty=\savedpenalty %
       \global\savedpenalty=0 %
       %\Rchunkpenalty should already have been set.
     \else%
       \Rchunkpenalty=\tmppenalty %
     \fi%
   \fi%
 \fi%
 \ifnum\holdinginserts=0 %Inserts not held, continue
 	\digl@tRight%
 \else%
 	%\doDiglotRightTrial% FIXME - still broken?
 	\digl@tRight%
 \fi%
}

\def\digl@tRight{
 %Assumptions: Old bottom half of diglotRight
 %\tmppenalty contains the penalty that goes after box255
 %\Rchunkpenalty has been set
 %Fills: partialR
 %Empties 255
 %Sets partialRpenalty, and some provisional page marking
 %
 % Do marking stuff...
 \edef\t@st{\botmark}%
 \ifx\t@st\empty\else
   \xdef\oldRmark{\botmark}
   \ifLeftMarks\else%
     \TRACEdiglot{Setting (default) bottom mark to \botmark, may revise later}%
     \xdef\b@xbotmark{\botmark}
     \edef\t@st{\p@gefirstmark}%
     \ifx\t@st\empty
       \xdef\p@gefirstmark{\firstmark}\fi % remember first, if not already set
   \fi% LeftMarks
 \fi
 \hsize=\columnRwidth\relax%
 \makevtop{255}%
 % put collected following material into partialR, adding to existing if
 % necessary
 \ifvoid\partialR%
   \global\setbox\partialR=\vtop{\unvbox255}
 \else%
   \global\setbox\partialR=\vtop{\joinboxes{\partialR}{255}{11}{\partialRpenalty}}\relax%
 \fi%
 \partialRpenalty=\tmppenalty %
 %\ifnum\Lchunkpenalty=0\relax\else%restore any penalty that might have been just before the column swap
   %\global\setbox\partialR=\vtop{\unvbox\partialR\penalty\savedpenalty}
 %\fi
 %\ifnum\pageno=21\showbox\partialR\fi
 \setboth%
} %
%
%
% Change which side we're adding to
\outer\def\lefttext{%
  \TRACEdiglot{lefttext ilp=\the\interlinepenalty}%
  \ifsk@pping \egroup \sk@ppingfalse\fi% if we were skipping nonpublishable text, end that mode
  \ifhe@dings\endhe@dings\fi%
  \ifinn@te\MSG{lefttext called from inside footnote?!?}\fi
  \Lneedsemptyingtrue%
  \global\savedpenalty=\lastpenalty\relax%
  \calc@vailht%
  \n@xtc@mmand%
  \par\penalty-10001%
  \relax%
  \global\digl@tLtrue%
  \global\diglotLtrue%
  \ifleftfull % Already full, just swallow text...
    \global\vsize=\textheight
    \global\availht=\vsize
  \else%
    \calc@vailht%Recalculate for this column
    \global\vsize=\availht\relax%
  \fi
  %Other Left parameters
  \output={\diglotLeft}\relax%
  \swapfonts{L}%
  \global\hsize=\columnLwidth\relax\global\holdinginserts=1}%

\outer\def\righttext{\TRACEdiglot{righttext}\ifhe@dings\endhe@dings\fi\global\savedpenalty=\lastpenalty\n@xtc@mmand\global\holdinginserts=1\par\penalty-10001\relax\calc@vailht\global\digl@tLfalse\global\diglotRtrue\calc@vailht\global\vsize=\availht\relax\output={\diglotRight}\swapfonts{R}\global\hsize=\columnRwidth\relax\global\holdinginserts=0}%
%
% When there's a header on the left but not the right, but we want the verses
% to line up nicely...
\def\norighttext{\global\savedpenalty=\lastpenalty\relax\TRACEdiglot{norighttext}\Lneedsemptyingtrue\par\penalty-10001\relax\global\diglotLtrue\global\digl@tLtrue\Lchunkpenalty=0\relax\setboth\output={\diglotLeft}\global\hsize=\columnLwidth\relax\global\holdinginserts=1}%

%Similarly when there's no left text, copying \righttext seems OK ...
\def\nolefttext{\TRACEdiglot{nolefttext}\global\savedpenalty=\lastpenalty\n@xtc@mmand\par\penalty-10001\relax\global\diglotLtrue\calc@vailht\global\digl@tLfalse\global\diglotRtrue\calc@vailht\global\vsize=\availht\output={\diglotRight}\swapfonts{R}\global\hsize=\columnRwidth\relax\global\holdinginserts=0}%

\newdimen\columnLwidth%
\newdimen\columnRwidth%
\newdimen\availhtL
\newdimen\availhtR
\newdimen\pr@vdepth
\newdimen\adjustp@ge
\adjustp@ge=0pt
\def\m@rkerL{}
\def\m@rkerR{}
\newif\ifdiglotL%
\newif\ifdigl@tL%
\let\diglotRtrue=\diglotLfalse\relax%
\let\diglotRfalse=\diglotLtrue\relax%

\def\swapfonts#1{% Because it might be desirable to set fonts appropriately.
%Swapping fonts isn't actually needed, but do need to set
%baselineskip and other things
\TRACEdiglot{swapfonts #1}%
\def\@@setside{\global\csname diglot#1true\endcsname}%
\TRACEdiglot{t@tle is \ift@tle set\else  not set\fi}%
\TRACEdiglot{he@dingstyle is \ifhe@dingstyle set\else  not set\fi}%
\TRACEdiglot{he@dings is \ifhe@dings set\else  not set\fi}%
%\TRACEdiglot{nsp@cebefore is \ifnsp@cebefore set\else  not set\fi}
\@@setside%
%All sorts of things should follow if m@rker is set properly...
\expandafter\ifx\csname m@rker\endcsname\relax\else%
\ifdiglotL\let\m@rkerR=\m@rker\let\m@rker=\m@rkerL\relax\else%
\let\m@rkerL=\m@rker\let\m@rker=\m@rkerR\relax\fi%
%\message{m@rker now \m@rker}
\fi%
\TRACEdiglot{Leadingunit: \the\le@dingunit}%
\ifdim\le@dingunit>0pt %
  \s@tbaseline{p}%
\fi%
\ifdim\baselineskip=0pt %
  \message{baseline set to 0pt EEK}%
  \global\baselineskip=12pt
\fi%
%Also need to switch hyphenation patterns
\expandafter\ifx\csname language#1\endcsname\relax\else\uselanguage{\csname language#1\endcsname}\fi}%


%\output={\diglotLeft}
%\hsize=\columnLwidth
\newif\ifleftfull % Is the left column full?
\newif\ifpagefull % Is the page full?
\newdimen\Lht
\newdimen\Rht %
\newdimen\TempDim %
\newbox\LeftBox % The part of partialL which fits on the page
\newbox\RightBox % The part of partialR which fits on the page

%when there's no more input, make sure partial gets printed
\def\emitpartial{%
	\@writep@ge\@writep@ge%
	\global\leftfullfalse%
	\global\pagefullfalse%
}

\newif\ifrepeatpermitted  %Not to be confused by repeatok which is set by caller
\newif\ifredocolok%
\def\setboth{%
  %Assumptions:
  %\LeftBox has been filled by diglotLeftTrial.
  %\partialL may have extra material in it, which hasn't been footnoted. 
  %\RightBox needs to be filled from partialR.
  %\Rchunkpenalty et al. correctly  set by caller
  \TRACEdiglot{setboth \the\outputpenalty, \the\savedpenalty, \the\Rchunkpenalty,  \the\Rboxpenalty diglotL\ifdiglotL true\else false\fi}%
  \calc@vailht
  \global\splittopskip=\baselineskip
  \global\topskip=\baselineskip
  \global\Lht=\ht\LeftBox\relax%
  \advance\Lht by \dp\LeftBox
  \global\Rht=\ht\partialR\relax%
  \advance\Rht by \dp\partialR
  % Force page output if user-caused and not by a column swap.
  \redocoloktrue%
  \pagefullfalse%
  \repeatpermittedfalse% in many situations we don't want this looping.
  \ifnum\outputpenalty=-10000
   \pagefulltrue%
  \fi%
  \ifnum\outputpenalty=-10002 %Set on self-repeat calls
   \pagefullfalse%
   \redocoloktrue%
  \fi%
  \ifnum\outputpenalty=-10001 % Column break.
   \pagefullfalse%
   \redocolokfalse%
   \repeatpermittedtrue%
  \fi%
  \ifnum\outputpenalty=-10005 %
    \repeatpermittedtrue%
  \fi%
  \ifnum\partialRpenalty = 10000 %Box is probably a title or similar - never OK to refill here FIXME why not refil? Not ok to break, yes, but wy not refil?
    \redocolokfalse%
  \fi%
  % Don't allow unvboxing the right column if we're in left column modeǃ
  \ifdiglotL%
    \redocolokfalse%
  % I don't understand why this next bit causes problems...
  %\else%  We're in right column mode..
    %\ifnum\outputpenalty>-10000 % and a normal page break
      %\ifvoid\partialR\else%and there's material left to set in the right hand column
        %\repeatpermittedtrue % let this setboth be called again
      %\fi
    %\fi
  \fi%
  \ifdigl@tL%
    \redocolokfalse%
  \fi%
  % Eject a partial page when we're done too, in some cases
  \ifnum\outputpenalty=-20000 % End of document / supereject
   \TRACEdiglot{SuperEject}
   \pagefulltrue%
   \redocolokfalse%
   \aftergroup\emitpartial%
  \fi%
  %\gdef\nextp@gefirstmark{}%
  \ifnum\partialRpenalty=10000\relax% Can't break page here
    \checkn@sty{\availhtL}{\Lht}%
    \TRACEdiglot{Checking what to do with this box (\the\ht\partialR+\the\dp\partialR) av:\the\availhtR, aL:\the\availhtL, \the\Lht, ->\the\TempDim}%
    \checkn@sty{\availhtL}{\Lht}%
    \checkn@sty{\availhtR}{\Rht}%
    \ifdim\TempDim<\Rht %split required
      \availht=\TempDim\relax% Save the cutting length
    \else%
      \TRACEdiglot{No split required}
    \fi%
  \fi%
  \TempDim=\availht\relax%
  \ifnastybox% All the last left box was shifted to the next page. Since the first line of l+r
 	%boxes should line up then the right box should be passed on too
    \TRACEdiglot{Box should move}%
    \global\pagefulltrue%
    \global\TempDim=-10pt %<--that SPACE after pt is critical!
  \else%
  \fi%
  \global\nastyboxfalse %unset it 
  %\TRACEdiglot{\the\TempDim}
  \ifdim\TempDim<0pt %
    %\TRACEdiglot{SKIP2}
    \ifdim\availht<-2\baselineskip %
      %Need to drop something. Picture or text, I don't know
      %FIXME This shouldn't happen... 
      \message{Out of space: av = \the\availht, th=\the\textheight,
      tr=\the\trialheight, part=(\the\ht\partial+\the\dp\partial)}%
    \fi
    %Leave partialR untouched - out of space anyway.
    \TRACEdiglot{Leaving R box for next page}
    \global\setbox\RightBox=\box\voidb@x%
    \global\Rht=0pt 
    \pagefulltrue%
  \else%  
    %pagefulltrue should be set if the left column can't hold more too.
    \ifleftfull
      \pagefulltrue
    \fi
    %Not sure this is needed, but it shouldn't hurt
    \advance\availhtL by -\Lht
    \TempDim=\availhtL
    \ifdim\TempDim<\baselineskip%
      \pagefulltrue%
    \fi%
    %\ifdim\ht\partialL>0pt %
      %\TRACEdiglot{partialL not empty. Not setting extra \the\ht\partialL of material this time}%
    %\fi%
    \ifvoid\partialL
      \TRACEdiglot{Refilling empty partialL from excessL}
      \global\setbox\partialL=\vtop{\unvbox\excessL}%
      \partialLpenalty=\Lchunkpenalty %
    \else
      \ifvoid\excessL\else
	\TRACEdiglot{Refilling non-empty partialL from excessL}
        \global\setbox\partialL=\vtop{\joinboxes{\partialL}{\excessL}{9}{\partialLpenalty}}%
	\partialLpenalty=\Lchunkpenalty %

      \fi
      %\showbox\partialL
    \fi
    \TempDim=\availhtR %
    \advance\TempDim by -\Rht
    \TRACEdiglot{pL:(\the\ht\partialL+\the\dp\partialL) lb:(\the\ht\LeftBox+\the\dp\LeftBox) p:(\the\ht\partial+\the\dp\partial) rb:(\the\ht\RightBox+\the\dp\RightBox) aR:(\the\availhtR) aL:(\the\availhtL)}%
    % It might be possible (look good?) to steal extra space for right if left has overshot, if that's only a little
    \ifdim\availhtL<0pt\ifdim\availhtL>-1\baselineskip\TRACEdiglot{Left overshot by \the\availhtL, allowing right to also}\advance\TempDim by -\availhtL\fi\fi%
    \ifdim\TempDim<-0.3\baselineskip % Is a split required? Allow a little extra for descenders 
      \TRACEdiglot{Splitting right to \the\availhtR}%
      \ifnum\Rboxpenalty=0 \Rboxpenalty=5000 \fi%
      \global\setbox\partialR=\vbox{\penalty \Rboxpenalty\unvbox\partialR}% sometimes we'd rather split everything off than nothing 
      \global\setbox\RightBox=\vsplit\partialR to \availhtR%
      \ifvoid\partialR\Rboxpenalty=\partialRpenalty \else\Rboxpenalty=0 \fi%
      {\setbox 0=\copy\partialR% Split all of what remains and use that for the next page
      \setbox 1=\vsplit 0 to \ht\partialR%
      \gdef\nextp@gefirstmark{\splitfirstmark}}%
      \TRACEdiglot{\the\ht\partialR+\the\dp\partialR left over in partialR after split}%
      \edef\t@st{\splitbotmark}%
      \ifx\t@st\empty\else%
        \ifLeftMarks%
        \TRACEdiglot{Remembering Rhs bottom mark \splitbotmark}%
	\xdef\oldRmark{\splitbotmark}\else%
        \TRACEdiglot{Setting bottom mark to \splitbotmark}%
        \xdef\p@gebotmark{\splitbotmark}%
      \fi\fi%
      \makevtop{\partialR}%
      \global\Rht=\ht\RightBox\relax%
      \pagefulltrue%
    \else% It all fits...
      \global\setbox\RightBox=\box\partialR%
      \Rboxpenalty=\partialRpenalty %
      \edef\t@st{\b@xbotmark}%
      \ifx\t@st\empty
        \TRACEdiglot{Setting page bottom mark to - as emergency measure}%
        \xdef\p@gebotmark{-}%
      \else%
        \TRACEdiglot{Setting page bottom mark to \b@xbotmark, may revise later}%
        \xdef\p@gebotmark{\b@xbotmark}%
      \fi%
    \fi%
    %pagefulltrue should be set if the page can't hold more too.
    \TempDim=\availht %
    \advance\TempDim by -\Rht
    \ifdim\TempDim<\baselineskip%
      \pagefulltrue%
    \fi%
  \fi%
  \TRACEdiglot{av:\the\availht}%
  \TRACEdiglot{L:\the\ht\LeftBox+\the\dp\LeftBox}%
  \TRACEdiglot{R:\the\ht\RightBox+\the\dp\RightBox}%
  \TempDim=\ht\RightBox\relax%
  \advance\TempDim by -\ht\LeftBox
  \advance\TempDim by \dp\RightBox
  \advance\TempDim by -\dp\LeftBox
  %\message{TempDim is \the\TempDim}
  \ifdim \TempDim>0pt %Right box is longest
    \dimen0=\dp\LeftBox\relax%
    \advance\TempDim by -\dp\LeftBox
    \global\setbox\LeftBox=\vtop{\unvbox\LeftBox}%
  \fi%
  \ifdim \TempDim<0pt %Left box is longest
    \advance\TempDim by \dp\RightBox
    \dimen0=\dp\RightBox\relax%
    \ifredocolok%
      \ifpagefull%
        %\makevtop{\RightBox}%
	\global\setbox\RightBox=\vtop{\unvbox\RightBox}%
        \upd@tep@rtial%
      \else %pagefull
	\ifnum\deadcycles<15 %
	  %We can safely have a go at re-setting this column. 
	  \TRACEdiglot{Trying to refill right column}%
	  %\global\setbox\partialL=\vbox{\unvbox\LeftBox\unvbox\partialL}
	  \global\holdinginserts=0
	  \global\Lneedsemptyingfalse%
	  \unvbox\RightBox%
	  \ifnum\outputpenalty = 10000
	    \penalty 10
	  \else %
	    \ifnum\outputpenalty<-100
	      \penalty 999
	    \else%
	      \penalty\outputpenalty %
	    \fi%
	  \fi %outputpenalty
	\else %deadcycles. Set partial with partly empty page
	  \global\setbox\RightBox=\vtop{\unvbox\RightBox}%
	  \upd@tep@rtial%
	\fi%
      \fi %pagefull
    \else %redocolok 
      %\makevtop{\RightBox}%
      \global\setbox\RightBox=\vtop{\unvbox\RightBox}%
      \upd@tep@rtial%
    \fi %redocolok 
  \else %TempDim 
    %\makevtop{\RightBox}%
    \global\setbox\RightBox=\vtop{\unvbox\RightBox}%
    \upd@tep@rtial%
  \fi %TempDim 
  %NB: Code added here gets run during trials too.
  \ifintrial\else\ifLneedsemptying%
    \TRACEdiglot{more to empty  lb:(\the\ht\LeftBox+\the\dp\LeftBox) pL:(\the\ht\partialL+\the\dp\partialL) eL:(\the\ht\excessL+\the\dp\excessL) pR:(\the\ht\partialR+\the\dp\partialR)}%\setboth%
   \setboth%
  \fi\fi%
}
\def\checkn@sty#1#2{%
  %Parameters availht, boxheight
  %If Box needs moving to next page sets ifnastybox and \TempDim
  %Sets \TempDim to #2 if no change needed.
  \TempDim=#1\advance\TempDim by -#2
  \ifdim\TempDim>-0.3\baselineskip% Box would fit 
    \ifdim\TempDim<2\baselineskip% But it only just fits - hardly even another line after it
      \ifdim#2>3\baselineskip% It can be split though 
        \global\TempDim=#1\relax%
	\global\advance\TempDim by -2\baselineskip
      \else%Can't split it and can't fit anything after it. Pass it on to next page
        \global\TempDim=0pt %
	\global\nastyboxtrue% move it.
      \fi%
    \else%more than 2 lines of space after it
      \global\TempDim=#2\relax%No change needed
    \fi%
  \else% Doesn't fit anyway
    \ifdim#2>3\baselineskip% It can be split though
      \global\TempDim=#2\relax%
      \global\advance\TempDim by -\baselineskip
      \global\nastyboxtrue%
    \else %Can't split it and it doesn't fit %
      \global\TempDim=0pt %
      \global\nastyboxtrue%
    \fi%
  \fi%
}
\def\makevtop#1{%There is a strong posibility that a vbox has a depth that
%is unrecoverable on changing it to a vtop, e.g. if the last item in the
%vbox is a \mark. To rejoin boxes on a page accurately we need to preserve
%the depth of the box. We therefore assume the box will be joined and if
%the depth is not recoverable we add a kern to remove the orignial depth.
 \TRACEdiglot{makevtop #1, before vtop dp=\the\dp#1}%
 %\ifnum\diglotTRcount<61\showbox#1\fi
 \pr@vdepth=\dp#1\relax%
 \ifdim\pr@vdepth>\baselineskip \TRACEdiglot{Looks like this is already a vtop}\pr@vdepth=0pt
 \fi%
 %\bgroup
 \setbox0=\copy#1\setbox1=\vtop{\unvbox 0\setbox2=\lastbox}%Work on a copy so we don't break stuff.
 \TRACEdiglot{pd:\the\dp2, ph=\the\ht2, d:\the\pr@vdepth}%
 \global\setbox#1=\vtop{\unvbox#1\ifdim\dp2=0pt\ifdim\pr@vdepth=0pt\else\kern-\pr@vdepth\fi\fi}}%\egroup}%

\def\joinboxes#1#2#3#4{%Join 2 vtops together and preserve baselineskip%
\TRACEdiglot{joinboxes #1 #2 called from locn #3}
\ifnum\diglotTRcount=\diglotDbgJoinboxes
  \showbox#1\showbox#2
\fi\relax
%\bgroup
%\ifnum#3=10\showbox#1\fi%
\ifvoid#1\else%
  \unvbox#1%
  %\showlists
  \setbox0=\lastbox%
  \copy0%
  \TRACEdiglot{final bit of deconstructed first box \the\ht0+\the\dp0}%
  \ifdim\dp0<\baselineskip
    \kern -\dp0
    %\else
    %\showbox0
  \fi%
  \ifnum#3=99\hrule\kern -0.4pt
  \fi% Test code
\fi%
%
\ifvoid#2\else%
  \penalty#4%put the appropriate penalty back 
  \unvbox#2%
\fi%
}%\egroup}

\def\joinb@xes#1#2{%Join a vtop and an hbox together and preserve baselineskip%
%\showbox#1\showbox#2%
%\bgroup
\dimen0=\baselineskip\advance\dimen0 by -\ht#1\unvbox#1\setbox0=\lastbox\box0
\ifdim\dp0<\baselineskip\advance\dimen0 by -\dp0\fi
%\ifdim\dimen0<0pt\dimen0=0pt\fi%
%\vglue\dimen0
\box#2}%\egroup}


\def\upd@tep@rtial{%
  \TRACEdiglot{upd@tep@rtial \the\outputpenalty}%
  \showboxdepth=3 %
  \showboxbreadth=1000 %
  %\ifnum\pageno=1%
  %\showbox\LeftBox%
  %\showbox\RightBox%
  %\fi%
  \global\def\n@xtc@mmand{}%
  \message{|}%
  \hsize=\textwidth%
  \edef\t@st{\p@gebotmark}%
  \ifx\t@st\empty%
    \TRACEdiglot{Setting bottom mark to \b@xbotmark, since it's empty }%
    \xdef\p@gebotmark{\b@xbotmark}%
  \fi%
  %Re-use LeftBox for this page chunk
  %
  \ifVisTrace%
  \setbox0=\vtop to 0pt{\hrule height 0pt depth 0.5pt width 15pt\hbox{\the\diglotTRcount}\vss}\ht0=0pt\dp0=0pt
  \fi%
  \TRACEdiglot{Adding to page: LB:\the\ht\LeftBox+\the\dp\LeftBox RB:\the\ht\RightBox+\the\dp\RightBox}
  \global\setbox\LeftBox=\vtop{\hbox to \textwidth{\ifVisTrace\llap{\box0}\fi%
  \hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
  \columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
  }}%
  \TRACEdiglot{adding box to partial (\the\ht\LeftBox)}%
  \global\setbox\partial=\vtop{\joinb@xes{\partial}{\LeftBox}}%
  \ifleftfull% This box fills the left column (with footnotes)
    \pagefulltrue%
  \fi%
  \calc@vailht
  \ifdim\availht<\baselineskip %
    \pagefulltrue%
  \else%
    \global\trialheight=\availht\relax%
    \global\vsize=\trialheight\relax%
  \fi%
  \deadcycles=0 %
  \global\lastsavedLpenalty=\Lboxpenalty % Remember how happy we are to break at this point
  \global\lastsavedRpenalty=\Rboxpenalty % Remember how happy we are to break at this point
  \ifpagefull%
    \@writep@ge%
  \fi%
  \global\setbox\RightBox=\box\voidb@x %
  \ifdim\dp\partialL=0pt %
    \ifvoid\excessL%
      \TRACEdiglot{partialL and excessL now empty}
      \Lneedsemptyingfalse%
     \fi
  \fi
  \ifpagefull % Page was written
    \global\leftfullfalse%
    \global\pagefullfalse%
    \global\holdinginserts=1 %

    \global\availht=\textheight %
    \global\vsize=\availht\relax%
    \ifearlyLrefill%
      %There is material in excessL which should be added now, not later.
      \TRACEdiglot{Refilling partialL early pl:(\the\ht\partialL+\the\dp\partialL) eL:(\the\ht\excessL+\the\dp\excessL) }%
      \global\setbox\partialL=\vtop{\joinboxes{\partialL}{\excessL}{12}{\partialLpenalty}}%
      \partialLpenalty=\Lchunkpenalty %
      \global\earlyLrefillfalse%
    \fi
    \TRACEdiglot{pL:(\the\ht\partialL+\the\dp\partialL) pR:(\the\ht\partialR+\the\dp\partialR)}%
    \ifdim\dp\partialL>0pt %
      %Assumptions: Page is empty, LeftBox is empty, partialL contains extra
      %material for left column, excessL is possibly empty (from setboth or above). 
      \ifrepeatpermitted%
        % Quite possibly have enough material already - repeat 'til not a full page.
	\ifdim\dp\partialR>0pt %
          %There is something to add to the RHS.. After re-setting partialL, setboth should be called.
          \TRACEdiglot{Repeating setboth after trial (both sides have data)}%
          \global\def\n@xtc@mmand{\TRACEdiglot{n@xtc@mmand}\setboth}%
        \else
	  \ifrepeatok
	    %Right is empty, left has something. Don't call setboth, come straight back to updatepartial
            \TRACEdiglot{Repeating upd@tep@rtial after trial}%
            \global\def\n@xtc@mmand{\TRACEdiglot{n@xtc@mmand}\upd@tep@rtial}%
	  \else
	    % Don't repeat - e.g. when called here from \diglotLeft ??? Or only sometimes?
            \TRACEdiglot{Not Repeating upd@tep@rtial}%
            \global\def\n@xtc@mmand{\TRACEdiglot{no n@xtc@mmand}}%
	    \global\repeatoktrue %ok to do it later though
	  \fi
	\fi
      \fi%
      \ifdim\dp\partialL>\availht%
        %Want the first chunk in partialL, the residue in excessL, so vsplit
        %gets it backwards for us.
        %Use LeftBox as a temporary store
	\TRACEdiglot{Spliting \the\ht\partialL to \the\availht}
        \global\setbox\LeftBox=\vsplit\partialL to \availht%
	\ifvoid\partialL%
	   \Lboxpenalty=\partialLpenalty %
	\else%
	   \Lboxpenalty=0 %
	   \makevtop{\partialL}%
	\fi%
	\makevtop{\LeftBox}%
        \global\setbox\excessL=\box\partialL\relax%
	\global\setbox\partialL=\box\LeftBox\relax%
      \else%
	\TRACEdiglot{no need to split}
        \global\outputpenalty=-10002\relax%No more itterations after this
        \global\setbox\partialL=\vtop{\unvbox\partialL}%
	%\makevtop{\partialL}
      \fi%
      \global\trialheight=\availht\relax%
      \doDiglotLeftTrial%
    \else %i.e.\dp\partialL<=0
      \ifnum\outputpenalty=-10001\relax%
        % No partialL mtl, but possibly have right column that should be
	% set.
        \TRACEdiglot{B pL:(\the\ht\partialL+\the\dp\partialL) pR:(\the\ht\partialR+\the\dp\partialR)}%
	\ifdim\dp\partialR>0pt
          \TRACEdiglot{Repeating setboth}%
          \setboth%
	\else
	  \ifdim\ht\partialR>0pt
            \TRACEdiglot{Repeating setboth}%
            \setboth%
	  \fi
	\fi
      \fi %outputpenalty %
    \fi %\ht\partiaL
  \fi%
}

\newif\ifLRf@@tnotes%
\newif\ifs@vedL%
\def\@writep@ge {%
  \TRACEdiglot{@writep@ge}%
  \global\setbox\galley=\vbox{\unvbox\partial}%
  \ifdiglotSepNotes%
    \TRACEdiglot{Sep notes}%
    \s@vedLfalse%
    \ifdiglotL%
      \s@vedLtrue%
    \fi%
    \LRf@@tnotesfalse%
    \f@rstnotetrue%
    \diglotLtrue%
    \dimen0=0pt 
    %Arrange Left and Right footnotes
    \global\setbox\LeftBox=\vbox{\let\\=\ins@rtn@tecl@ss \the\n@tecl@sses}%
    \iff@rstnote%
      \TRACEdiglot{No Left footnotes}%
    \else%
      \LRf@@tnotestrue%
      \f@rstnotetrue%
    \fi%
    \dimen0=0pt 
    \diglotLfalse%
    \global\setbox\RightBox=\vbox{\let\\=\ins@rtn@tecl@ss \the\n@tecl@sses}%
    \iff@rstnote%
      \TRACEdiglot{No Right footnotes}%
    \else%
      \LRf@@tnotestrue%
    \fi%
    \diglotLfalse%
    \ifs@vedL%
      \diglotLtrue%
    \fi%
    \ifdiglotBalNotes%
      \TRACEdiglot{Balanced notes}%
      \ifLRf@@tnotes%
	\kern\dimen0%
        \TRACEdiglot{Footnotes}%
	\ifdim\ht\LeftBox>\ht\RightBox%
	  \setbox\RightBox=\vbox to \ht\LeftBox{\box\RightBox\vss}%
	\else%
	  \setbox\LeftBox=\vbox to \ht\RightBox{\box\LeftBox\vss}%
	\fi%
        \setbox\LeftBox=\hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
          \hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
          \columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
        }%
      \else%
        \TRACEdiglot{No footnotes}%
      \fi %LRf@@tnotes
      \setbox\galley=\vbox{\unvbox\galley\box\LeftBox}%
    \else %BalNotes
      \TRACEdiglot{unBalanced notes}%
      \ifLRf@@tnotes%
	%Lht and Rht hold the height of the last boxes added to the page
	%Need to find out where to put the footnotes, as one of them should
	%be close to its respective text.
	{\dimen1=\Lht
	\advance\dimen1 by -\Rht % dimen1 is step in text
	\dimen2=\ht\LeftBox\relax%
	\TRACEdiglot{L:\the\Lht R:\the\Rht lf:(\the\ht\LeftBox+\the\dp\LeftBox) rf:(\the\ht\RightBox+\the\dp\RightBox)}
	\advance\dimen2 by -\ht\RightBox % dimen2 is step in footnotes
	%
        \setbox\LeftBox\hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
          \hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
          \columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
        }%
	%\advance\dimen2 by -\ht\RightBox % dimen2 is step in footnotes
	%%
        %\setbox\LeftBox\hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
          %\hbox to\columnLwidth{\copy\LeftBox\hss}\hskip\gutter\hbox to%
          %\columnRwidth{\copy\RightBox\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
        %}%

	\ifdim\dimen1<0pt %dimen1 -ve
	  \ifdim\dimen2<0pt %dimen2 -ve
	      \dimen3=0pt %No adjustment
	  \else  %dimen2 +ve
	    \ifdim\dimen1 > -\dimen2
	      \dimen3=-\dimen1
	    \else%
	      \dimen3=\dimen2
	    \fi%
	  \fi  %dimen2 %dimen2 -ve
	\else %dimen1 +ve
	  \ifdim\dimen2<0pt %
	    \ifdim\dimen1 > -\dimen2
	      \dimen3=-\dimen2
	    \else%
	      \dimen3=\dimen1
	    \fi%
	  \else %dimen2 +ve
	    \dimen3=0pt %No adjustment
	  \fi%
	\fi%
        \TRACEdiglot{Adjusting footnotebox}%
	\global\setbox\galley=\vbox{\unvbox\galley\kern -\dimen3\box\LeftBox}%
	}%
      \else%
        \TRACEdiglot{No footnotes}%
      \fi%
    \fi %BalNotes
  \else %SepNotes
    \TRACEdiglot{Merged notes}%
  \fi%
  %\fi
  %\TRACEdiglot{LOST1}
  %\fi
  %\TRACEdiglot{LOST2}
  \TRACEdiglot{Forming page}%
  %\showbox\galley
  %\showthe\everyhbox
  %\showthe\leftskip
  %\showthe\rightskip
  \def\pagecontents{%
   \ifvoid\topins\else \unvbox\topins \vskip\skip\topins \fi%
   \ifdim\ht\topleftins>\ht\toprightins%
      \setbox\toprightins=\vbox to \ht\topleftins{\box\toprightins\vss}%
   \else%
      \setbox\topleftins=\vbox to \ht\toprightins{\box\topleftins\vss}%
   \fi%
   \hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
     \hbox to\columnLwidth{\box\topleftins\hss}\hskip\gutter\hbox to%
     \columnRwidth{\box\toprightins\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
   }%
   \dimen0=\dp\galley\relax%
   \unvbox\galley%
   \ifdim\ht\bottomleftins>\ht\bottomrightins%
      \setbox\bottomrightins=\vbox to \ht\bottomleftins{\box\bottomrightins\vss}%
   \else%
      \setbox\bottomleftins=\vbox to \ht\bottomrightins{\box\bottomleftins\vss}%
   \fi%
   \hbox to \textwidth{%\vllap{\the\ht\LeftBox \the\dp\LeftBox}
     \hbox to\columnLwidth{\box\bottomleftins\hss}\hskip\gutter\hbox to%
     \columnRwidth{\box\bottomrightins\hss}%\rlap{\the\ht\RightBox \the\dp\RightBox}
   }%
   \ifvoid\bottomins\else%\kern-\dimen0 \dimen0=0pt 
     \vskip\skip\bottomins \unvbox\bottomins \fi%
   \vbox to 0pt{}%
   \ifdiglotSepNotes%
   \else%
     \TRACEdiglot{Inserting Notes}%
     \f@rstnotetrue%
     \let\\=\ins@rtn@tecl@ss \the\n@tecl@sses %
   \fi%
   \iff@rstnote % no notes actually occurred!
     \kern-\dimen0 \vfil%
   \else%
     \setbox0=\lastbox \dimen0=\dp0 \box0 \kern-\dimen0%
   \fi%
  }%
  \TRACEdiglot{PFM:\p@gefirstmark PBM:\p@gebotmark}%
  \global\adjustp@ge=0pt
  \resetvsize%
  \global\availhtR=\textheight%
  \global\availhtL=\textheight%
  \global\availht=\textheight%
  \plainoutput%
  \ifLeftMarks
  \xdef\p@gefirstmark{}%
  \xdef\nextp@gefirstmark{}%
  \else
  \xdef\p@gefirstmark{\nextp@gefirstmark}%
  \xdef\nextp@gefirstmark{}%
  \fi
  \edef\botmark{\p@gebotmark}
  \xdef\p@gebotmark{}%
  \global\setbox\RightBox=\box\voidb@x%
  \global\setbox\LeftBox=\box\voidb@x%
}

\def\testmarker{\hbox to 0pt{\vrule height 7pt depth 0pt width 0.5pt \kern-0.5pt}\message{_}}
%
\endinput
